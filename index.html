<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mutual Friends Network</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 100 100'><rect width='100' height='100' fill='%230f0f14'/><line x1='50' y1='25' x2='25' y2='50' stroke='%23ea2864' stroke-width='2' opacity='0.6'/><line x1='50' y1='25' x2='75' y2='50' stroke='%23ea2864' stroke-width='2' opacity='0.6'/><line x1='25' y1='50' x2='50' y2='75' stroke='%23ea2864' stroke-width='2' opacity='0.6'/><line x1='75' y1='50' x2='50' y2='75' stroke='%23ea2864' stroke-width='2' opacity='0.6'/><line x1='25' y1='50' x2='75' y2='50' stroke='%23ea2864' stroke-width='1.5' opacity='0.4'/><line x1='50' y1='25' x2='50' y2='75' stroke='%23ea2864' stroke-width='1.5' opacity='0.4'/><circle cx='50' cy='25' r='10' fill='%23c75a80' opacity='0.9'/><circle cx='25' cy='50' r='8' fill='%235e6575' opacity='0.9'/><circle cx='75' cy='50' r='8' fill='%238f7585' opacity='0.9'/><circle cx='50' cy='75' r='12' fill='%23ea2864'/><circle cx='50' cy='50' r='6' fill='%23c75a80' opacity='0.85'/></svg>">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Âü∫‰∫éÂèÇËÄÉÈÖçËâ≤Âç° - Black Color Palettes */
            --bg-primary: #0f0f14;
            --bg-secondary: #16141c;
            --bg-card: #1b1e26;
            --bg-hover: #252830;
            --accent-primary: #ea2864;
            --accent-light: #ff4d7f;
            --accent-dark: #c41e52;
            --accent-secondary: #2d2a35;
            --text-primary: #f5f5f7;
            --text-secondary: #a8a8b3;
            --text-muted: #6b6b78;
            --border-color: #2a2832;
            --glow-primary: 0 0 20px rgba(234, 40, 100, 0.4);
            --glow-soft: 0 0 30px rgba(234, 40, 100, 0.2);
            --mobile-header-icon-top: 30px;
            --menu-btn-size: 36px;
            --menu-icon-size: 24px;
            --mobile-logo-padding-h: 52px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
        }

        /* ËÉåÊôØÂä®Áîª */
        .bg-pattern {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(ellipse at 30% 70%, rgba(234, 40, 100, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 70% 30%, rgba(234, 40, 100, 0.05) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(45, 42, 53, 0.3) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
        }

        .grid-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(234, 40, 100, 0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(234, 40, 100, 0.02) 1px, transparent 1px);
            background-size: 60px 60px;
            pointer-events: none;
            z-index: 1;
        }

        /* ‰∏ªÂÆπÂô® */
        .container {
            display: flex;
            height: 100vh;
            position: relative;
            z-index: 10;
        }

        /* ‰æßËæπÊ†è */
        .sidebar {
            width: 400px;
            background: linear-gradient(180deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        .sidebar::-webkit-scrollbar-thumb:hover {
            background: var(--accent-cyan);
        }

        .sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 1px;
            height: 100%;
            background: linear-gradient(180deg, var(--accent-primary), var(--accent-dark), var(--bg-card));
            opacity: 0.6;
        }

        .logo-section {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            background: linear-gradient(135deg, rgba(234, 40, 100, 0.05) 0%, transparent 100%);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .logo-content {
            flex: 1;
        }

        .logo {
            font-family: 'Orbitron', sans-serif;
            font-size: 22px;
            font-weight: 900;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .logo-subtitle {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
            letter-spacing: 3px;
        }

        /* ËØ≠Ë®ÄÈÄâÊã© */
        .lang-selector {
            position: relative;
        }

        .lang-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            transition: color 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .lang-btn svg {
            width: 22px;
            height: 22px;
            stroke: var(--text-secondary);
            transition: stroke 0.2s ease;
        }

        .lang-btn:hover svg {
            stroke: var(--accent-primary);
        }

        .lang-btn:hover {
            color: var(--accent-primary);
        }

        .lang-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
            z-index: 1000;
            min-width: 100px;
        }

        .lang-selector:hover .lang-dropdown,
        .lang-dropdown.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .lang-option {
            padding: 10px 16px;
            font-size: 12px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .lang-option:hover {
            background: var(--bg-hover);
            color: var(--accent-primary);
        }

        .lang-option.active {
            background: rgba(234, 40, 100, 0.1);
            color: var(--accent-primary);
        }

        /* Êñá‰ª∂ÈÄâÊã© */
        .file-section {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .file-btn-group {
            display: flex;
            gap: 8px;
        }

        .file-btn {
            flex: 1;
            padding: 12px 16px;
            background: rgba(234, 40, 100, 0.08);
            border: 1px dashed rgba(234, 40, 100, 0.4);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 12px;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .file-btn:hover {
            background: rgba(234, 40, 100, 0.15);
            border-color: var(--accent-primary);
            box-shadow: var(--glow-soft);
        }

        .file-btn svg {
            stroke: var(--accent-primary);
        }

        .file-btn-db {
            background: rgba(45, 42, 53, 0.5);
            border-color: var(--accent-secondary);
        }

        .file-btn-db svg {
            stroke: var(--text-secondary);
        }

        .file-btn-db:hover {
            border-color: var(--accent-primary);
            box-shadow: var(--glow-soft);
        }

        .file-btn-db:hover svg {
            stroke: var(--accent-primary);
        }

        .file-info {
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .file-name {
            font-size: 11px;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 280px;
        }

        .export-btn {
            width: 22px;
            height: 22px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .export-btn:hover {
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
            background: rgba(0, 245, 255, 0.1);
        }

        .export-btn svg {
            stroke: currentColor;
        }

        /* ÊêúÁ¥¢Ê°Ü */
        .search-section {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .search-wrapper {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 14px 20px 14px 48px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: var(--glow-soft);
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }

        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
        }

        /* ÁªüËÆ°Âç°Áâá */
        .stats-section {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .stats-title {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--text-muted);
            margin-bottom: 16px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-dark));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .stat-card:hover {
            background: var(--bg-hover);
            transform: translateY(-2px);
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 26px;
            font-weight: 700;
            color: var(--accent-primary);
            line-height: 1;
        }

        .stat-card:nth-child(2) .stat-value {
            color: var(--accent-light);
        }

        .stat-card:nth-child(3) .stat-value {
            color: var(--accent-primary);
        }

        .stat-card:nth-child(4) .stat-value {
            color: var(--accent-light);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 8px;
        }

        /* ÊéßÂà∂Èù¢Êùø */
        .controls-section {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .control-group {
            margin-bottom: 16px;
        }

        .control-group:last-child {
            margin-bottom: 0;
        }

        .control-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .control-value {
            color: var(--accent-primary);
            font-family: 'Orbitron', sans-serif;
            font-size: 11px;
        }

        .slider {
            width: 100%;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--bg-hover);
            border-radius: 2px;
            outline: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--accent-primary);
            cursor: pointer;
            box-shadow: var(--glow-primary);
            transition: all 0.2s ease;
        }

        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.15);
        }

        /* ÊåâÈíÆÁªÑ */
        .btn-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-card);
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn:hover {
            background: var(--bg-hover);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .btn.active {
            background: rgba(234, 40, 100, 0.15);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        /* ËäÇÁÇπËØ¶ÊÉÖ */
        .detail-section {
            padding: 20px 24px;
            min-height: 300px;
        }

        .detail-header {
            margin-bottom: 20px;
        }

        .detail-placeholder {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .detail-placeholder-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* ÊéíË°åÊ¶úÊ†∑Âºè */
        .ranking-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
        }

        .ranking-header {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 8px;
        }

        .ranking-header svg {
            stroke: var(--accent-primary);
        }

        .ranking-desc {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 16px;
        }

        .ranking-list {
            max-height: 500px;
            overflow-y: auto;
            padding-right: 4px;
        }

        .ranking-list::-webkit-scrollbar {
            width: 4px;
        }

        .ranking-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .ranking-list::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 2px;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .ranking-item:hover {
            background: var(--bg-hover);
            border-color: var(--border-color);
            transform: translateX(4px);
        }

        .ranking-item.top-1 {
            background: linear-gradient(135deg, rgba(234, 40, 100, 0.18), rgba(234, 40, 100, 0.05));
            border-color: rgba(234, 40, 100, 0.35);
        }

        .ranking-item.top-1 .ranking-position {
            background: linear-gradient(135deg, #ea2864, #c41e52);
            color: #fff;
        }

        .ranking-item.top-2 {
            background: linear-gradient(135deg, rgba(199, 90, 128, 0.15), rgba(199, 90, 128, 0.05));
            border-color: rgba(199, 90, 128, 0.3);
        }

        .ranking-item.top-2 .ranking-position {
            background: linear-gradient(135deg, #c75a80, #a84d6d);
            color: #fff;
        }

        .ranking-item.top-3 {
            background: linear-gradient(135deg, rgba(143, 117, 133, 0.15), rgba(143, 117, 133, 0.05));
            border-color: rgba(143, 117, 133, 0.3);
        }

        .ranking-item.top-3 .ranking-position {
            background: linear-gradient(135deg, #8f7585, #7a6472);
            color: #fff;
        }

        .ranking-position {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-card);
            border-radius: 6px;
            font-family: 'Orbitron', sans-serif;
            font-size: 12px;
            font-weight: 700;
            color: var(--text-muted);
            margin-right: 12px;
            flex-shrink: 0;
        }

        .ranking-name {
            flex: 1;
            font-size: 13px;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .ranking-score {
            font-family: 'Orbitron', sans-serif;
            font-size: 13px;
            font-weight: 700;
            color: var(--accent-primary);
            margin-left: 10px;
        }

        .detail-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .detail-header-row {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 10px;
        }

        .detail-name {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--accent-primary);
            flex: 1;
            word-break: break-word;
        }

        .remove-node-btn {
            width: 28px;
            height: 28px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
            opacity: 0.6;
        }

        .remove-node-btn:hover {
            opacity: 1;
            border-color: var(--accent-primary);
            color: var(--accent-primary);
            background: rgba(234, 40, 100, 0.15);
        }

        .remove-node-btn svg {
            stroke: currentColor;
        }

        .detail-rank {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }

        .rank-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            background: rgba(234, 40, 100, 0.15);
            color: var(--accent-primary);
            border: 1px solid rgba(234, 40, 100, 0.3);
        }

        .rank-desc {
            font-size: 11px;
            color: var(--text-muted);
        }

        .detail-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 16px;
        }

        .detail-stat {
            background: var(--bg-secondary);
            padding: 12px;
            border-radius: 8px;
        }

        .detail-stat-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 20px;
            color: var(--accent-primary);
        }

        .detail-stat-label {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .detail-stat.full-width {
            grid-column: 1 / -1;
            text-align: center;
        }

        .connections-list {
            margin-top: 16px;
            max-height: none;
        }

        .connections-container {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 4px;
        }

        .connections-container::-webkit-scrollbar {
            width: 4px;
        }

        .connections-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .connections-container::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 2px;
        }

        .connections-title {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .connection-item {
            padding: 10px 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid transparent;
        }

        .connection-item:hover {
            background: var(--bg-hover);
            border-color: var(--border-color);
            transform: translateX(4px);
        }

        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-primary);
        }

        .connection-name {
            font-size: 13px;
            color: var(--text-primary);
            flex: 1;
        }

        .connection-count {
            font-family: 'Orbitron', sans-serif;
            font-size: 11px;
            color: var(--text-muted);
            background: var(--bg-card);
            padding: 2px 8px;
            border-radius: 10px;
        }

        /* ÂõæÂΩ¢Âå∫Âüü */
        .graph-area {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        #graph {
            width: 100%;
            height: 100%;
            background: transparent;
        }

        .node {
            cursor: pointer;
            transition: filter 0.2s ease;
        }

        .node:hover {
            filter: brightness(1.3);
        }

        .link {
            stroke-opacity: 0.4;
            transition: stroke-opacity 0.2s ease;
        }

        .link.highlighted {
            stroke-opacity: 1;
            stroke-width: 2px;
        }

        .link.dimmed {
            stroke-opacity: 0.1;
        }

        .node-label {
            font-family: 'Noto Sans SC', sans-serif;
            font-size: 11px;
            fill: var(--text-primary);
            pointer-events: none;
            text-shadow: 0 0 8px rgba(0, 0, 0, 0.8);
        }

        /* Â∑•ÂÖ∑ÊèêÁ§∫ */
        .tooltip {
            position: fixed;
            padding: 12px 16px;
            background: var(--bg-card);
            border: 1px solid var(--accent-primary);
            border-radius: 8px;
            font-size: 13px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
            z-index: 1000;
            box-shadow: var(--glow-soft);
            box-shadow: var(--glow-cyan);
            max-width: 250px;
        }

        .tooltip.visible {
            opacity: 1;
        }

        .tooltip-name {
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 4px;
        }

        .tooltip-info {
            font-size: 11px;
            color: var(--text-secondary);
        }

        /* Âõæ‰æã */
        .legend {
            position: absolute;
            bottom: 24px;
            left: 24px;
            background: rgba(22, 20, 28, 0.9);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            backdrop-filter: blur(10px);
            display: none;
        }

        .legend-title {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .legend-item:last-child {
            margin-bottom: 0;
        }

        .legend-circle {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }


        .legend-label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Áº©ÊîæÊéßÂà∂ */
        .zoom-controls {
            position: absolute;
            bottom: 24px;
            right: 24px;
            display: none;
            flex-direction: column;
            gap: 8px;
        }

        .zoom-btn {
            width: 44px;
            height: 44px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background: rgba(26, 34, 52, 0.9);
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .zoom-btn:hover {
            background: var(--bg-hover);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        /* Âä†ËΩΩÂä®Áîª */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            font-family: 'Orbitron', sans-serif;
            color: var(--text-secondary);
            letter-spacing: 2px;
        }

        /* Ê¨¢ËøéÁïåÈù¢ */
        .welcome-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: radial-gradient(ellipse at center, rgba(234, 40, 100, 0.04) 0%, transparent 70%);
            z-index: 100;
        }

        .welcome-content {
            text-align: center;
            padding: 60px;
            background: rgba(22, 20, 28, 0.9);
            border: 1px solid var(--border-color);
            border-radius: 24px;
            backdrop-filter: blur(20px);
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
        }

        .welcome-icon {
            margin-bottom: 24px;
            color: var(--accent-primary);
            animation: networkPulse 3s ease-in-out infinite;
        }

        @keyframes networkPulse {
            0%, 100% { opacity: 0.7; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.08); }
        }

        .welcome-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 26px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 16px;
        }

        .welcome-desc {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 32px;
        }

        .welcome-btn-group {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .welcome-btn {
            padding: 14px 24px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-dark));
            border: none;
            border-radius: 12px;
            color: #fff;
            font-size: 14px;
            font-weight: 700;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 20px rgba(234, 40, 100, 0.3);
        }

        .welcome-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(234, 40, 100, 0.5);
        }

        .welcome-btn svg {
            stroke: #fff;
        }

        .welcome-btn-db {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            box-shadow: none;
        }

        .welcome-btn-db svg {
            stroke: var(--text-secondary);
        }

        .welcome-btn-db:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
            box-shadow: var(--glow-soft);
        }

        .welcome-btn-db:hover svg {
            stroke: var(--accent-primary);
        }

        .welcome-hint {
            margin-top: 16px;
            font-size: 12px;
            color: var(--text-muted);
        }

        .welcome-note {
            margin-top: 24px;
            padding: 16px;
            background: rgba(234, 40, 100, 0.08);
            border: 1px solid rgba(234, 40, 100, 0.2);
            border-radius: 10px;
            text-align: left;
        }

        .welcome-note-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            font-weight: 600;
            color: var(--accent-primary);
            margin-bottom: 10px;
        }

        .welcome-note-title svg {
            stroke: var(--accent-primary);
            flex-shrink: 0;
        }

        .welcome-note-list {
            margin: 0;
            padding-left: 20px;
            font-size: 11px;
            color: var(--text-secondary);
            line-height: 1.8;
        }

        .welcome-note-list strong {
            color: var(--accent-primary);
        }

        .welcome-note-local {
            margin-top: 10px;
            font-size: 10px;
            color: var(--text-muted);
            font-style: italic;
        }

        .welcome-note-path {
            margin-top: 12px;
            padding-top: 10px;
            border-top: 1px dashed rgba(234, 40, 100, 0.2);
            font-size: 10px;
            color: var(--text-muted);
        }

        .welcome-note-path code {
            display: block;
            margin-top: 4px;
            padding: 6px 10px;
            background: var(--bg-primary);
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 10px;
            color: var(--text-secondary);
            word-break: break-all;
        }

        /* ÂìçÂ∫îÂºè */
        @media (max-width: 1200px) {
            .sidebar {
                width: 320px;
            }
        }

        /* ÊµÆÂä®ËèúÂçïÊåâÈíÆÔºàÂ∏¶Âä®ÁîªÊïàÊûúÔºö‰∏âÊù°Ê®™Êù† ‚Üî XÔºâ */
        .menu-toggle {
            display: none;
            position: fixed;
            z-index: 250;
            width: var(--menu-btn-size);
            height: var(--menu-btn-size);
            border: none;
            background: transparent;
            cursor: pointer;
            padding: 0;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            transition: color 0.2s ease;
        }

        .menu-toggle svg {
            width: var(--menu-icon-size);
            height: var(--menu-icon-size);
            stroke: currentColor;
            stroke-width: 2.4;
            fill: none;
        }

        .menu-toggle-line {
            stroke-linecap: round;
            stroke-linejoin: round;
            transform-origin: 12px 12px;
            transition: transform 0.25s ease, opacity 0.2s ease;
        }

        .line-top { transform: translateY(-5px); }
        .line-middle { transform: translateY(0); }
        .line-bottom { transform: translateY(5px); }

        .menu-toggle:hover { color: var(--accent-primary); }

        /* ÊâìÂºÄÁä∂ÊÄÅ - ÂèòÊàê X */
        .menu-toggle.active .line-top {
            transform: translateY(0) rotate(45deg);
        }

        .menu-toggle.active .line-middle {
            opacity: 0;
            transform: translateX(-8px);
        }

        .menu-toggle.active .line-bottom {
            transform: translateY(0) rotate(-45deg);
        }

        /* ‰æßËæπÊ†èÈÅÆÁΩ©Â±Ç */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 140;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sidebar-overlay.visible {
            display: block;
            opacity: 1;
        }

        @media (max-width: 900px) {
            html, body {
                overflow: hidden;
                height: 100%;
            }

            .container {
                flex-direction: column;
                height: 100vh;
                z-index: auto;
            }

            /* ÁßªÂä®Á´Ø logo-section - ‰øùÊåÅÂéüÊúâÈ´òÂ∫¶ */
            .logo-section {
                padding: 20px 52px;
            }

            /* ÊòæÁ§∫ËèúÂçïÊåâÈíÆ - ‰ΩøÁî®ÂèòÈáèËÆ©ÂõæÊ†á‰∏é logo Âå∫ÂùóÂûÇÁõ¥Â±Ö‰∏≠ */
            .menu-toggle {
                display: flex;
                top: var(--mobile-header-icon-top);
                left: calc((var(--mobile-logo-padding-h) - var(--menu-btn-size)) / 2);
            }

            /* ÁßªÂä®Á´ØËØ≠Ë®ÄÈÄâÊã©Âô® - Âõ∫ÂÆöÂÆö‰ΩçÔºåÂêåÊ†∑ÂØπÈΩê */
            .lang-selector {
                position: fixed;
                top: var(--mobile-header-icon-top);
                right: 16px;
                z-index: 250;
            }

            /* ‰æßËæπÊ†èÊäΩÂ±âÂºè - ÈúÄË¶ÅËÑ±Á¶ª container ÁöÑÂ±ÇÂè†‰∏ä‰∏ãÊñá */
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                width: 85%;
                max-width: 320px;
                height: 100vh;
                max-height: 100vh;
                z-index: 200;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                border-right: 1px solid var(--border-color);
                background: linear-gradient(180deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
                overflow-y: auto;
                overflow-x: hidden;
            }

            .sidebar.visible {
                transform: translateX(0);
            }

            /* ÂõæË°®Âå∫ÂüüÂÖ®Â±è */
            .graph-area {
                width: 100%;
                height: 100vh;
                flex: 1;
            }

            /* Ê¨¢ËøéÁïåÈù¢Ë∞ÉÊï¥ */
            .welcome-content {
                max-width: 90%;
                padding: 24px 20px;
                margin: 16px;
            }

            .welcome-icon svg {
                width: 60px;
                height: 60px;
            }

            .welcome-title {
                font-size: 20px;
            }

            .welcome-desc {
                font-size: 12px;
                margin-bottom: 20px;
            }

            .welcome-btn-group {
                flex-direction: column;
                gap: 10px;
            }

            .welcome-btn {
                width: 100%;
                justify-content: center;
                padding: 14px 20px;
            }

            .welcome-tip {
                font-size: 11px;
            }

            .vrcx-tip {
                padding: 12px;
            }

            .vrcx-tip-title {
                font-size: 11px;
            }

            .vrcx-tip ol {
                font-size: 10px;
            }

            /* Âõæ‰æãÂíåÊéßÂà∂ÊåâÈíÆË∞ÉÊï¥ */
            .legend {
                top: auto;
                bottom: 70px;
                left: 12px;
                right: auto;
                padding: 10px;
            }

            .legend-title {
                font-size: 10px;
            }

            .legend-circle {
                width: 10px;
                height: 10px;
            }

            .legend-label {
                font-size: 10px;
            }

            .zoom-controls {
                bottom: 12px;
                right: 12px;
                gap: 6px;
            }

            .zoom-btn {
                width: 38px;
                height: 38px;
            }
        }

        /* Â∞èÂ±èÊâãÊú∫ */
        @media (max-width: 480px) {
            :root {
                --mobile-header-icon-top: 26px;
                --mobile-logo-padding-h: 44px;
            }

            .sidebar {
                width: 100%;
                max-width: none;
            }

            .logo-section {
                padding: 16px 44px;
            }

            /* Êõ¥Á¥ßÂáëÂ±èÂπï‰∏ãÔºöÈÄöËøáÂèòÈáè‰∏ãË∞ÉÂõæÊ†á‰ΩçÁΩÆÔºå‰øùÊåÅ‰∏éÊ°åÈù¢ËØ≠Ë®ÄÊåâÈíÆÂ±Ö‰∏≠ */
            .menu-toggle {
                left: 12px;
            }

            .lang-selector {
                right: 12px;
            }

            .welcome-content {
                padding: 20px 16px;
            }

            .welcome-title {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="bg-pattern"></div>
    <div class="grid-overlay"></div>

    <!-- ÊµÆÂä®ËèúÂçïÊåâÈíÆ -->
    <button class="menu-toggle" id="menuToggle" title="Menu" aria-label="Menu">
        <svg viewBox="0 0 24 24">
            <line class="menu-toggle-line line-top" x1="5" y1="12" x2="19" y2="12"></line>
            <line class="menu-toggle-line line-middle" x1="5" y1="12" x2="19" y2="12"></line>
            <line class="menu-toggle-line line-bottom" x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
    </button>

    <!-- ‰æßËæπÊ†èÈÅÆÁΩ© -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <div class="container">
        <aside class="sidebar">
            <div class="logo-section">
                <div class="logo-content">
                    <div class="logo">NEXUS</div>
                    <div class="logo-subtitle" data-i18n="subtitle">ÂÖ±ÂêåÂ•ΩÂèãÁΩëÁªúÂàÜÊûê</div>
                </div>
                <div class="lang-selector">
                    <button class="lang-btn" id="langBtn" title="Language / ËØ≠Ë®Ä / Ë®ÄË™û">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="2" y1="12" x2="22" y2="12"></line>
                            <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                        </svg>
                    </button>
                    <div class="lang-dropdown" id="langDropdown">
                        <div class="lang-option active" data-lang="zh">‰∏≠Êñá</div>
                        <div class="lang-option" data-lang="en">English</div>
                        <div class="lang-option" data-lang="ja">Êó•Êú¨Ë™û</div>
                    </div>
                </div>
            </div>

            <div class="file-section">
                <input type="file" id="fileInput" accept=".gexf,.xml,text/xml,application/xml,application/octet-stream" style="display: none;">
                <input type="file" id="dbFileInput" accept=".sqlite3,.db,.sqlite,application/x-sqlite3,application/octet-stream" style="display: none;">
                <div class="file-btn-group">
                    <button class="file-btn" id="btnLoadFile">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                        </svg>
                        <span data-i18n="loadGexf">ÈÄâÊã© GEXF</span>
                    </button>
                    <button class="file-btn file-btn-db" id="btnLoadDB">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <ellipse cx="12" cy="5" rx="9" ry="3"></ellipse>
                            <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path>
                            <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path>
                        </svg>
                        <span data-i18n="loadVrcx">ÈÄâÊã© VRCX</span>
                    </button>
                </div>
                <div class="file-info">
                    <span class="file-name" id="fileName" data-i18n="selectFile">ËØ∑ÈÄâÊã©Êñá‰ª∂</span>
                    <button class="export-btn" id="btnExportGexf" style="display: none;" title="ÂØºÂá∫‰∏∫ GEXF Êñá‰ª∂">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="search-section">
                <div class="search-wrapper">
                    <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="M21 21l-4.35-4.35"></path>
                    </svg>
                    <input type="text" class="search-input" id="searchInput" placeholder="ÊêúÁ¥¢Â•ΩÂèã..." data-i18n-placeholder="search">
                </div>
            </div>

            <div class="stats-section">
                <div class="stats-title" data-i18n="networkStats">ÁΩëÁªúÁªüËÆ°</div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="nodeCount">--</div>
                        <div class="stat-label" data-i18n="totalFriends">Â•ΩÂèãÊÄªÊï∞</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="edgeCount">--</div>
                        <div class="stat-label" data-i18n="totalConnections">ËøûÊé•ÊÄªÊï∞</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avgDegree">--</div>
                        <div class="stat-label" data-i18n="avgConnections">Âπ≥ÂùáËøûÊé•</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="density">--</div>
                        <div class="stat-label" data-i18n="networkDensity">ÁΩëÁªúÂØÜÂ∫¶</div>
                    </div>
                </div>
            </div>

            <div class="controls-section">
                <div class="control-group">
                    <div class="control-label">
                        <span data-i18n="repulsion">Êñ•ÂäõÂº∫Â∫¶</span>
                        <span class="control-value" id="forceValue">-300</span>
                    </div>
                    <input type="range" class="slider" id="forceSlider" min="-800" max="-50" value="-300">
                </div>
                <div class="control-group">
                    <div class="control-label">
                        <span data-i18n="linkStrength">ËøûÊé•Âº∫Â∫¶</span>
                        <span class="control-value" id="distanceValue">80</span>
                    </div>
                    <input type="range" class="slider" id="distanceSlider" min="30" max="200" value="80">
                </div>
                <div class="btn-group">
                    <button class="btn active" id="btnShowLabels">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M4 7V4h16v3"></path>
                            <path d="M9 20h6"></path>
                            <path d="M12 4v16"></path>
                        </svg>
                        <span data-i18n="showLabels">ÊòæÁ§∫Ê†áÁ≠æ</span>
                    </button>
                    <button class="btn" id="btnReset">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                            <path d="M3 3v5h5"></path>
                        </svg>
                        <span data-i18n="resetView">ÈáçÁΩÆËßÜÂõæ</span>
                    </button>
                    <button class="btn" id="btnFreeze">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="6" y="4" width="4" height="16"></rect>
                            <rect x="14" y="4" width="4" height="16"></rect>
                        </svg>
                        <span data-i18n="freezeLayout">ÂÜªÁªì</span>
                    </button>
                </div>
            </div>

            <div class="detail-section" id="detailSection">
                <div class="detail-placeholder">
                    <div class="detail-placeholder-icon">üîç</div>
                    <p data-i18n="clickToView">ÁÇπÂáªËäÇÁÇπÊü•ÁúãËØ¶ÁªÜ‰ø°ÊÅØ</p>
                </div>
            </div>
        </aside>

        <main class="graph-area">
            <div class="loading" id="loading" style="display: none;">
                <div class="loading-spinner"></div>
                <div class="loading-text" data-i18n="loading">Ê≠£Âú®Âä†ËΩΩÁΩëÁªúÊï∞ÊçÆ...</div>
            </div>
            
            <div class="welcome-screen" id="welcomeScreen">
                <div class="welcome-content">
                    <div class="welcome-icon">
                        <svg width="90" height="90" viewBox="0 0 100 100" fill="none">
                            <!-- ËøûÊé•Á∫ø -->
                            <line x1="50" y1="25" x2="25" y2="50" stroke="currentColor" stroke-width="2" opacity="0.6"/>
                            <line x1="50" y1="25" x2="75" y2="50" stroke="currentColor" stroke-width="2" opacity="0.6"/>
                            <line x1="25" y1="50" x2="50" y2="75" stroke="currentColor" stroke-width="2" opacity="0.6"/>
                            <line x1="75" y1="50" x2="50" y2="75" stroke="currentColor" stroke-width="2" opacity="0.6"/>
                            <line x1="25" y1="50" x2="75" y2="50" stroke="currentColor" stroke-width="1.5" opacity="0.4"/>
                            <line x1="50" y1="25" x2="50" y2="75" stroke="currentColor" stroke-width="1.5" opacity="0.4"/>
                            <!-- ËäÇÁÇπ - ÁÅ∞Á≤âÊ∏êÂèòÈÖçËâ≤ -->
                            <circle cx="50" cy="25" r="10" fill="#c75a80" opacity="0.9"/>
                            <circle cx="25" cy="50" r="8" fill="#5e6575" opacity="0.9"/>
                            <circle cx="75" cy="50" r="8" fill="#8f7585" opacity="0.9"/>
                            <circle cx="50" cy="75" r="12" fill="#ea2864"/>
                            <circle cx="50" cy="50" r="6" fill="#c75a80" opacity="0.85"/>
                            <!-- Â§ñÂúàÂÖâÊôï -->
                            <circle cx="50" cy="75" r="16" stroke="#ea2864" stroke-width="1" fill="none" opacity="0.3"/>
                        </svg>
                    </div>
                    <h2 class="welcome-title" data-i18n="welcomeTitle">ÂÖ±ÂêåÂ•ΩÂèãÁΩëÁªúÂàÜÊûê</h2>
                    <p class="welcome-desc" data-i18n="welcomeDesc">‰∏ä‰º†Êñá‰ª∂ÂèØËßÜÂåñÂàÜÊûê‰Ω†ÁöÑÁ§æ‰∫§ÁΩëÁªú</p>
                    <div class="welcome-btn-group">
                        <button class="welcome-btn" id="welcomeUploadBtn">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                            </svg>
                            <span data-i18n="loadGexf">ÈÄâÊã© GEXF</span>
                        </button>
                        <button class="welcome-btn welcome-btn-db" id="welcomeUploadDBBtn">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <ellipse cx="12" cy="5" rx="9" ry="3"></ellipse>
                                <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path>
                                <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path>
                            </svg>
                            <span data-i18n="loadVrcx">ÈÄâÊã© VRCX</span>
                        </button>
                    </div>
                    <div class="welcome-hint" data-i18n="fileHint">ÊîØÊåÅ .gexf Êñá‰ª∂ Êàñ VRCX.sqlite3 Êï∞ÊçÆÂ∫ì</div>
                    <div class="welcome-note">
                        <div class="welcome-note-title">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="12" y1="16" x2="12" y2="12"></line>
                                <line x1="12" y1="8" x2="12.01" y2="8"></line>
                            </svg>
                            <span data-i18n="vrcxNote">‰ΩøÁî® VRCX Êï∞ÊçÆÂ∫ìÂâç</span>
                        </div>
                        <ol class="welcome-note-list" id="welcomeNoteList">
                            <li><span data-i18n="vrcxStep1">Âú®VRCXÁöÑËÆæÁΩÆ‰∏≠ÔºåÂàáÊç¢Ëá≥</span> <strong data-i18n="vrcxNightly">Nightly</strong> <span data-i18n="vrcxVersion">ÁâàÊú¨</span></li>
                            <li><span data-i18n="vrcxStep2">Âú® VRCX„ÄåÂõæË°®„ÄçÈÄâÈ°πÂç°ÊâßË°å</span> <strong>Fetch Mutual Friends</strong></li>
                            <li data-i18n="vrcxStep3">Ëß£ÊûêÂÆåÊàêÂêéÂèØ‰∏ãËΩΩ GEXF Êñá‰ª∂</li>
                        </ol>
                        <div class="welcome-note-local" data-i18n="vrcxLocal">* Êï∞ÊçÆÂ∫ìËß£ÊûêÂú®Êú¨Âú∞ÊµèËßàÂô®‰∏≠ËøõË°åÔºå‰∏ç‰ºö‰∏ä‰º†Ëá≥ÊúçÂä°Âô®</div>
                        <div class="welcome-note-path">
                            <span data-i18n="vrcxPathLabel">Windows ÈªòËÆ§Ë∑ØÂæÑÔºö</span>
                            <code>%APPDATA%\VRCX\VRCX.sqlite3</code>
                        </div>
                    </div>
                </div>
            </div>
            
            <svg id="graph"></svg>

            <div class="legend">
                <div class="legend-title" data-i18n="legendTitle">ÂÖ±ÂêåÂ•ΩÂèãÊï∞Èáè</div>
                <div class="legend-item">
                    <div class="legend-circle" style="background: #5e6575; box-shadow: 0 0 10px rgba(94, 101, 117, 0.4);"></div>
                    <span class="legend-label" data-i18n="legendLow">Â∞ëÈáèËøûÊé•</span>
                </div>
                <div class="legend-item">
                    <div class="legend-circle" style="background: #8f7585; box-shadow: 0 0 10px rgba(143, 117, 133, 0.45);"></div>
                    <span class="legend-label" data-i18n="legendMid">‰∏ÄËà¨ËøûÊé•</span>
                </div>
                <div class="legend-item">
                    <div class="legend-circle" style="background: #c75a80; box-shadow: 0 0 10px rgba(199, 90, 128, 0.5);"></div>
                    <span class="legend-label" data-i18n="legendHigh">ËæÉÂ§öËøûÊé•</span>
                </div>
                <div class="legend-item">
                    <div class="legend-circle" style="background: #ea2864; box-shadow: 0 0 10px rgba(234, 40, 100, 0.6);"></div>
                    <span class="legend-label" data-i18n="legendTop">Á§æ‰∫§‰∏≠ÂøÉ</span>
                </div>
            </div>

            <div class="zoom-controls">
                <button class="zoom-btn" id="zoomIn">+</button>
                <button class="zoom-btn" id="zoomOut">‚àí</button>
                <button class="zoom-btn" id="zoomFit">‚ä°</button>
            </div>
        </main>
    </div>

    <div class="tooltip" id="tooltip">
        <div class="tooltip-name"></div>
        <div class="tooltip-info"></div>
    </div>

    <script>
        // Â§öËØ≠Ë®ÄÊîØÊåÅ
        const i18n = {
            zh: {
                subtitle: 'ÂÖ±ÂêåÂ•ΩÂèãÁΩëÁªúÂàÜÊûê',
                loadGexf: 'ÈÄâÊã© GEXF',
                loadVrcx: 'ÈÄâÊã© VRCX',
                selectFile: 'ËØ∑ÈÄâÊã©Êñá‰ª∂',
                currentFile: 'ÂΩìÂâç',
                search: 'ÊêúÁ¥¢Â•ΩÂèã...',
                linkStrength: 'ËøûÊé•Âº∫Â∫¶',
                repulsion: 'Êñ•ÂäõÂº∫Â∫¶',
                showLabels: 'ÊòæÁ§∫Ê†áÁ≠æ',
                resetView: 'ÈáçÁΩÆËßÜÂõæ',
                freezeLayout: 'ÂÜªÁªì',
                networkStats: 'ÁΩëÁªúÁªüËÆ°',
                totalFriends: 'Â•ΩÂèãÊÄªÊï∞',
                totalConnections: 'ËøûÊé•ÊÄªÊï∞',
                avgConnections: 'Âπ≥ÂùáËøûÊé•',
                networkDensity: 'ÁΩëÁªúÂØÜÂ∫¶',
                nodeDetail: 'ËäÇÁÇπËØ¶ÊÉÖ',
                clickToView: 'ÁÇπÂáªËäÇÁÇπÊü•ÁúãËØ¶ÁªÜ‰ø°ÊÅØ',
                mutualRanking: 'ÂÖ±ÂêåÂ•ΩÂèãÊéíÂêç',
                rank: 'ÊéíÂêç',
                total: 'ÂÖ±',
                people: '‰∫∫',
                mutualCount: 'ÂÖ±ÂêåÂ•ΩÂèãÊï∞',
                mutualList: 'ÂÖ±ÂêåÂ•ΩÂèãÂàóË°®',
                loading: 'Ê≠£Âú®Âä†ËΩΩÁΩëÁªúÊï∞ÊçÆ...',
                initSql: 'Ê≠£Âú®ÂàùÂßãÂåñ SQL.js...',
                readingDb: 'Ê≠£Âú®ËØªÂèñÊï∞ÊçÆÂ∫ì...',
                welcomeTitle: 'ÂÖ±ÂêåÂ•ΩÂèãÁΩëÁªúÂàÜÊûê',
                welcomeDesc: '‰∏ä‰º†Êñá‰ª∂ÂèØËßÜÂåñÂàÜÊûê‰Ω†ÁöÑÁ§æ‰∫§ÁΩëÁªú',
                fileHint: 'ÊîØÊåÅ .gexf Êñá‰ª∂ Êàñ VRCX.sqlite3 Êï∞ÊçÆÂ∫ì',
                vrcxNote: '‰ΩøÁî® VRCX Êï∞ÊçÆÂ∫ìÂâç',
                vrcxStep1: 'Âú®VRCXÁöÑËÆæÁΩÆ‰∏≠ÔºåÂàáÊç¢Ëá≥',
                vrcxNightly: 'Nightly',
                vrcxVersion: 'ÁâàÊú¨',
                vrcxStep2: 'Âú® VRCX„ÄåÂõæË°®„ÄçÈÄâÈ°πÂç°ÊâßË°å',
                vrcxFetch: 'Fetch Mutual Friends',
                vrcxStep3: 'Ëß£ÊûêÂÆåÊàêÂêéÂèØ‰∏ãËΩΩ GEXF Êñá‰ª∂',
                vrcxLocal: '* Êï∞ÊçÆÂ∫ìËß£ÊûêÂú®Êú¨Âú∞ÊµèËßàÂô®‰∏≠ËøõË°åÔºå‰∏ç‰ºö‰∏ä‰º†Ëá≥ÊúçÂä°Âô®',
                vrcxPathLabel: 'Windows ÈªòËÆ§Ë∑ØÂæÑÔºö',
                legendTitle: 'ÂÖ±ÂêåÂ•ΩÂèãÊï∞Èáè',
                legendLow: 'Â∞ëÈáèËøûÊé•',
                legendMid: '‰∏ÄËà¨ËøûÊé•',
                legendHigh: 'ËæÉÂ§öËøûÊé•',
                legendTop: 'Á§æ‰∫§‰∏≠ÂøÉ',
                removeNode: '‰ªéÂõæ‰∏≠ÁßªÈô§Ê≠§ËäÇÁÇπ'
            },
            en: {
                subtitle: 'Mutual Friends Network',
                loadGexf: 'Load GEXF',
                loadVrcx: 'Load VRCX',
                selectFile: 'Select a file',
                currentFile: 'Current',
                search: 'Search friends...',
                linkStrength: 'Link Strength',
                repulsion: 'Repulsion',
                showLabels: 'Show Labels',
                resetView: 'Reset View',
                freezeLayout: 'Freeze',
                networkStats: 'Network Stats',
                totalFriends: 'Total Friends',
                totalConnections: 'Connections',
                avgConnections: 'Avg Connections',
                networkDensity: 'Density',
                nodeDetail: 'Node Details',
                clickToView: 'Click a node to view details',
                mutualRanking: 'Mutual Friends Ranking',
                rank: 'Rank',
                total: 'of',
                people: 'total',
                mutualCount: 'Mutual Friends',
                mutualList: 'Friend List',
                loading: 'Loading network data...',
                initSql: 'Initializing SQL.js...',
                readingDb: 'Reading database...',
                welcomeTitle: 'Mutual Friends Network',
                welcomeDesc: 'Upload a file to visualize your social network',
                fileHint: 'Supports .gexf files or VRCX.sqlite3 database',
                vrcxNote: 'Before using VRCX database',
                vrcxStep1: 'Switch VRCX to',
                vrcxNightly: 'Nightly',
                vrcxVersion: 'version',
                vrcxStep2: 'Execute in VRCX "Graph" tab',
                vrcxFetch: 'Fetch Mutual Friends',
                vrcxStep3: 'Download GEXF file after parsing',
                vrcxLocal: '* Parsing is done locally in your browser, data is never uploaded',
                vrcxPathLabel: 'Windows default path:',
                legendTitle: 'Connection Count',
                legendLow: 'Few',
                legendMid: 'Average',
                legendHigh: 'Many',
                legendTop: 'Hub',
                removeNode: 'Remove this node'
            },
            ja: {
                subtitle: 'ÂÖ±ÈÄö„Éï„É¨„É≥„Éâ„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ',
                loadGexf: 'GEXFÈÅ∏Êäû',
                loadVrcx: 'VRCXÈÅ∏Êäû',
                selectFile: '„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû',
                currentFile: 'ÁèæÂú®',
                search: '„Éï„É¨„É≥„ÉâÊ§úÁ¥¢...',
                linkStrength: '„É™„É≥„ÇØÂº∑Â∫¶',
                repulsion: 'ÂèçÁô∫Âäõ',
                showLabels: '„É©„Éô„É´Ë°®Á§∫',
                resetView: '„É™„Çª„ÉÉ„Éà',
                freezeLayout: '„Éï„É™„Éº„Ç∫',
                networkStats: '„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÁµ±Ë®à',
                totalFriends: '„Éï„É¨„É≥„ÉâÊï∞',
                totalConnections: 'Êé•Á∂öÊï∞',
                avgConnections: 'Âπ≥ÂùáÊé•Á∂ö',
                networkDensity: '„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÂØÜÂ∫¶',
                nodeDetail: '„Éé„Éº„ÉâË©≥Á¥∞',
                clickToView: '„Éé„Éº„Éâ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶Ë©≥Á¥∞Ë°®Á§∫',
                mutualRanking: 'ÂÖ±ÈÄö„Éï„É¨„É≥„Éâ„É©„É≥„Ç≠„É≥„Ç∞',
                rank: 'È†Ü‰Ωç',
                total: 'ÂÖ®',
                people: '‰∫∫‰∏≠',
                mutualCount: 'ÂÖ±ÈÄö„Éï„É¨„É≥„ÉâÊï∞',
                mutualList: '„Éï„É¨„É≥„Éâ„É™„Çπ„Éà',
                loading: '„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...',
                initSql: 'SQL.js„ÇíÂàùÊúüÂåñ‰∏≠...',
                readingDb: '„Éá„Éº„Çø„Éô„Éº„Çπ„ÇíË™≠„ÅøËæº„Åø‰∏≠...',
                welcomeTitle: 'ÂÖ±ÈÄö„Éï„É¨„É≥„Éâ„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÂàÜÊûê',
                welcomeDesc: '„Éï„Ç°„Ç§„É´„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Å¶„ÇΩ„Éº„Ç∑„É£„É´„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„ÇíÂèØË¶ñÂåñ',
                fileHint: '.gexf „Éï„Ç°„Ç§„É´ „Åæ„Åü„ÅØ VRCX.sqlite3 „Éá„Éº„Çø„Éô„Éº„ÇπÂØæÂøú',
                vrcxNote: 'VRCX„Éá„Éº„Çø„Éô„Éº„Çπ‰ΩøÁî®Ââç„Å´',
                vrcxStep1: 'VRCX„Çí',
                vrcxNightly: 'Nightly',
                vrcxVersion: '„Éê„Éº„Ç∏„Éß„É≥„Å´ÂàáÊõø',
                vrcxStep2: 'VRCX„Äå„Ç∞„É©„Éï„Äç„Çø„Éñ„ÅßÂÆüË°å',
                vrcxFetch: 'Fetch Mutual Friends',
                vrcxStep3: 'Ëß£ÊûêÂæå„Å´ GEXF „Éï„Ç°„Ç§„É´„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ',
                vrcxLocal: '* Ëß£Êûê„ÅØ„Éñ„É©„Ç¶„Ç∂ÂÜÖ„Åß„É≠„Éº„Ç´„É´„Å´Ë°å„Çè„Çå„ÄÅ„Çµ„Éº„Éê„Éº„Å´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åï„Çå„Åæ„Åõ„Çì',
                vrcxPathLabel: 'Windows „Éá„Éï„Ç©„É´„Éà„Éë„ÇπÔºö',
                legendTitle: 'ÂÖ±ÈÄö„Éï„É¨„É≥„ÉâÊï∞',
                legendLow: 'Â∞ë„Å™„ÅÑ',
                legendMid: 'ÊôÆÈÄö',
                legendHigh: 'Â§ö„ÅÑ',
                legendTop: '„Éè„Éñ',
                removeNode: '„Åì„ÅÆ„Éé„Éº„Éâ„ÇíÂâäÈô§'
            }
        };

        let currentLang = 'zh';

        function updateLanguage(lang) {
            currentLang = lang;
            const texts = i18n[lang];
            
            // Êõ¥Êñ∞ÊâÄÊúâÂ∏¶ data-i18n Â±ûÊÄßÁöÑÂÖÉÁ¥†
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (texts[key]) {
                    el.textContent = texts[key];
                }
            });

            // Êõ¥Êñ∞ËæìÂÖ•Ê°Ü placeholder
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (texts[key]) {
                    el.placeholder = texts[key];
                }
            });

            // Êõ¥Êñ∞ title Â±ûÊÄß
            document.querySelectorAll('[data-i18n-title]').forEach(el => {
                const key = el.getAttribute('data-i18n-title');
                if (texts[key]) {
                    el.title = texts[key];
                }
            });

            // Êõ¥Êñ∞‰∏ãÊãâËèúÂçïÊøÄÊ¥ªÁä∂ÊÄÅ
            document.querySelectorAll('.lang-option').forEach(opt => {
                opt.classList.toggle('active', opt.getAttribute('data-lang') === lang);
            });

            // ‰øùÂ≠òËØ≠Ë®ÄÂÅèÂ•Ω
            localStorage.setItem('preferredLang', lang);

            // Êõ¥Êñ∞Êñá‰ª∂ÂêçÊòæÁ§∫ÔºàÂ¶ÇÊûúÂ∑≤Âä†ËΩΩÊñá‰ª∂Ôºâ
            if (window.networkViz && window.networkViz.currentFileName) {
                const fileNameEl = document.getElementById('fileName');
                fileNameEl.textContent = `${texts.currentFile}: ${window.networkViz.currentFileName}`;
            }

            // Âà∑Êñ∞Âä®ÊÄÅÁîüÊàêÁöÑÂÜÖÂÆπÔºàÊéíÂêçÂàóË°®ÊàñËäÇÁÇπËØ¶ÊÉÖÔºâ
            if (window.networkViz && window.networkViz.nodes && window.networkViz.nodes.length > 0) {
                if (window.networkViz.selectedNode) {
                    window.networkViz.showNodeDetail(window.networkViz.selectedNode);
                } else {
                    window.networkViz.showRankingList();
                }
            }
        }

        // GEXF Ëß£ÊûêÂô®
        class GEXFParser {
            static parse(xmlString) {
                const parser = new DOMParser();
                const xml = parser.parseFromString(xmlString, 'text/xml');
                
                const nodes = [];
                const edges = [];
                const nodeMap = new Map();

                // Ëß£ÊûêËäÇÁÇπ
                const nodeElements = xml.querySelectorAll('node');
                nodeElements.forEach(node => {
                    const id = node.getAttribute('id');
                    const label = node.getAttribute('label');
                    
                    let type = 'friend';
                    let displayName = label;
                    
                    const attvalues = node.querySelectorAll('attvalue');
                    attvalues.forEach(attr => {
                        const forAttr = attr.getAttribute('for');
                        const value = attr.getAttribute('value');
                        if (forAttr === '0') type = value;
                        if (forAttr === '1') displayName = value;
                    });

                    const nodeData = {
                        id,
                        label: displayName || label,
                        type,
                        connections: 0
                    };
                    
                    nodes.push(nodeData);
                    nodeMap.set(id, nodeData);
                });

                // Ëß£ÊûêËæπ
                const edgeElements = xml.querySelectorAll('edge');
                edgeElements.forEach(edge => {
                    const source = edge.getAttribute('source');
                    const target = edge.getAttribute('target');
                    edges.push({ source, target });
                });

                // Ê≠£Á°ÆËÆ°ÁÆóÊØè‰∏™ËäÇÁÇπÁöÑËøûÊé•Êï∞Ôºà‰ΩøÁî® Set ÂéªÈáçÔºâ
                nodes.forEach(node => {
                    const connectionSet = new Set();
                    edges.forEach(edge => {
                        if (edge.source === node.id && edge.target !== node.id) {
                            connectionSet.add(edge.target);
                        }
                        if (edge.target === node.id && edge.source !== node.id) {
                            connectionSet.add(edge.source);
                        }
                    });
                    node.connections = connectionSet.size;
                });

                return { nodes, edges };
            }
        }

        // ‰∏ªÂèØËßÜÂåñÁ±ª
        class NetworkVisualization {
            constructor() {
                this.svg = d3.select('#graph');
                this.width = 0;
                this.height = 0;
                this.nodes = [];
                this.edges = [];
                this.nodeMap = new Map();
                this.simulation = null;
                this.showLabels = true;
                this.frozen = false;
                this.selectedNode = null;
                this.highlightedNodes = new Set();
                this.currentGexfContent = null;  // ‰øùÂ≠òÂΩìÂâçÁöÑ GEXF ÂÜÖÂÆπÁî®‰∫éÂØºÂá∫
                this.currentFileName = null;     // ÂΩìÂâçÊñá‰ª∂Âêç
                this.isDragging = false;         // ÊòØÂê¶Ê≠£Âú®ÊãñÂä®ËäÇÁÇπ

                this.init();
            }

            async init() {
                this.updateDimensions();
            window.addEventListener('resize', () => this.updateDimensions());
            
            // ‰∏çËá™Âä®Âä†ËΩΩÊï∞ÊçÆÔºåÁ≠âÂæÖÁî®Êà∑ÈÄâÊã©Êñá‰ª∂
            this.setupControls();
            this.showWelcome();
        }

            showWelcome() {
                // ÈöêËóèÂä†ËΩΩÂä®ÁîªÔºåÊòæÁ§∫Ê¨¢ËøéÁïåÈù¢
                document.getElementById('loading').style.display = 'none';
                document.getElementById('welcomeScreen').style.display = 'flex';
                // ÈöêËóèÂõæ‰æãÂíåÊéßÂà∂ÊåâÈíÆ
                document.querySelector('.legend').style.display = 'none';
                document.querySelector('.zoom-controls').style.display = 'none';
            }

            hideWelcome() {
                document.getElementById('welcomeScreen').style.display = 'none';
                // ÊòæÁ§∫Âõæ‰æãÂíåÊéßÂà∂ÊåâÈíÆ
                document.querySelector('.legend').style.display = 'block';
                document.querySelector('.zoom-controls').style.display = 'flex';
            }

            updateDimensions() {
                const container = document.querySelector('.graph-area');
                this.width = container.clientWidth;
                this.height = container.clientHeight;
                
                this.svg
                    .attr('width', this.width)
                    .attr('height', this.height);
            }

            async loadData(fileContent = null) {
                try {
                    let text;
                    if (fileContent) {
                        text = fileContent;
                    } else {
                        const response = await fetch('mutual_graph.gexf');
                        text = await response.text();
                    }
                    
                    const data = GEXFParser.parse(text);
                    
                    this.nodes = data.nodes;
                    this.edges = data.edges;
                    this.nodeMap.clear();
                    
                    this.nodes.forEach(node => {
                        this.nodeMap.set(node.id, node);
                    });

                    this.updateStats();
                } catch (error) {
                    console.error('Âä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•:', error);
                    alert('Âä†ËΩΩÊñá‰ª∂Â§±Ë¥•ÔºåËØ∑Á°Æ‰øùÊñá‰ª∂Ê†ºÂºèÊ≠£Á°Æ');
                }
            }

            async loadFromFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = (e) => reject(e);
                    reader.readAsText(file);
                });
            }

            async loadFromVRCXDatabase(file) {
                // ÊòæÁ§∫Âä†ËΩΩÁïåÈù¢
                this.hideWelcome();
                const loading = document.getElementById('loading');
                loading.style.display = 'flex';
                loading.style.opacity = '1';
                const texts = i18n[currentLang];
                document.querySelector('.loading-text').textContent = texts.initSql;

                try {
                    // ÂàùÂßãÂåñ sql.js
                    const SQL = await initSqlJs({
                        locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
                    });

                    document.querySelector('.loading-text').textContent = texts.readingDb;

                    // ËØªÂèñÊñá‰ª∂‰∏∫ ArrayBuffer
                    const arrayBuffer = await file.arrayBuffer();
                    const db = new SQL.Database(new Uint8Array(arrayBuffer));

                    document.querySelector('.loading-text').textContent = 'Ê≠£Âú®Ëß£ÊûêÊï∞ÊçÆ...';

                    // Ê£ÄÊµãË°®ÂâçÁºÄ
                    const prefix = this.detectVRCXPrefix(db);
                    if (!prefix) {
                        throw new Error('Êó†Ê≥ïÊâæÂà∞ mutual_graph Áõ∏ÂÖ≥Ë°®ÔºåËØ∑Á°Æ‰øùÂ∑≤Âú® VRCX ‰∏≠ÊâßË°åËøá Fetch Mutual Friends');
                    }

                    // Âä†ËΩΩÊòæÁ§∫ÂêçÁß∞
                    const displayNames = this.loadVRCXDisplayNames(db, prefix);
                    
                    // Âä†ËΩΩÂ•ΩÂèã ID
                    const friendIds = this.loadVRCXFriendIds(db, prefix);
                    
                    // Âä†ËΩΩËæπ
                    const edges = this.loadVRCXEdges(db, prefix);

                    // ÂÖ≥Èó≠Êï∞ÊçÆÂ∫ì
                    db.close();

                    document.querySelector('.loading-text').textContent = 'Ê≠£Âú®ÁîüÊàêÂõæÂΩ¢...';

                    // ÊûÑÂª∫ GEXF
                    const gexfContent = this.buildGEXFFromVRCX(friendIds, edges, displayNames);

                    // Âä†ËΩΩÂõæÂΩ¢ÔºàÊòæÁ§∫ÂéüÂßãÊñá‰ª∂ÂêçÔºåÊ†áËÆ∞‰∏∫‰ªéÊï∞ÊçÆÂ∫ìÂØºÂÖ•Ôºâ
                    await this.reloadGraph(gexfContent, file.name, true);

                } catch (error) {
                    loading.style.display = 'none';
                    this.showWelcome();
                    throw error;
                }
            }

            detectVRCXPrefix(db) {
                const result = db.exec("SELECT name FROM sqlite_master WHERE type='table' AND name LIKE '%mutual_graph_links'");
                if (!result.length || !result[0].values.length) return null;
                
                const tableName = result[0].values[0][0];
                return tableName.replace('_mutual_graph_links', '');
            }

            loadVRCXDisplayNames(db, prefix) {
                const displayNames = new Map();
                try {
                    const result = db.exec(`SELECT user_id, display_name FROM ${prefix}_friend_log_current`);
                    if (result.length && result[0].values) {
                        result[0].values.forEach(([userId, displayName]) => {
                            if (userId && displayName) {
                                displayNames.set(userId, displayName);
                            }
                        });
                    }
                } catch (e) {
                    console.warn('Êó†Ê≥ïÂä†ËΩΩÊòæÁ§∫ÂêçÁß∞Ë°®:', e);
                }
                return displayNames;
            }

            loadVRCXFriendIds(db, prefix) {
                const result = db.exec(`SELECT friend_id FROM ${prefix}_mutual_graph_friends`);
                if (!result.length) return [];
                return result[0].values.map(row => row[0]).filter(Boolean);
            }

            loadVRCXEdges(db, prefix) {
                const excludedIds = new Set(['usr_00000000-0000-0000-0000-000000000000']);
                const result = db.exec(`SELECT friend_id, mutual_id FROM ${prefix}_mutual_graph_links`);
                if (!result.length) return [];
                
                return result[0].values
                    .filter(([friendId, mutualId]) => 
                        friendId && mutualId && 
                        !excludedIds.has(friendId) && 
                        !excludedIds.has(mutualId)
                    )
                    .map(([friendId, mutualId]) => ({ source: friendId, target: mutualId }));
            }

            buildGEXFFromVRCX(friendIds, edges, displayNames) {
                const friendSet = new Set(friendIds);
                const nodeIds = new Set(friendIds);
                const excludedIds = new Set(['usr_00000000-0000-0000-0000-000000000000']);
                
                // Êî∂ÈõÜÊâÄÊúâËäÇÁÇπ ID
                edges.forEach(edge => {
                    if (edge.target && !excludedIds.has(edge.target)) {
                        nodeIds.add(edge.target);
                    }
                });

                // ÊûÑÂª∫ËäÇÁÇπ
                const nodes = [];
                nodeIds.forEach(nodeId => {
                    if (excludedIds.has(nodeId)) return;
                    const nodeType = friendSet.has(nodeId) ? 'friend' : 'mutual';
                    const displayName = displayNames.get(nodeId) || '';
                    const label = displayName || nodeId;
                    nodes.push({ id: nodeId, type: nodeType, label, displayName: displayName || label });
                });

                // ÊéíÂ∫èËäÇÁÇπ
                nodes.sort((a, b) => a.id.localeCompare(b.id));

                // ÊûÑÂª∫ GEXF XML
                const timestamp = new Date().toISOString().split('T')[0];
                const escapeXml = (str) => str
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&apos;');

                let gexf = `<?xml version="1.0" encoding="UTF-8"?>
<gexf xmlns="http://www.gexf.net/1.3draft" version="1.3">
  <meta lastmodifieddate="${timestamp}">
    <creator>VRCX Mutual Graph Exporter (Browser)</creator>
    <description>Mutual friend network exported from VRCX database</description>
  </meta>
  <graph mode="static" defaultedgetype="undirected">
    <attributes class="node" mode="static">
      <attribute id="0" title="type" type="string"/>
      <attribute id="1" title="displayName" type="string"/>
    </attributes>
    <nodes>
`;
                nodes.forEach(node => {
                    gexf += `      <node id="${escapeXml(node.id)}" label="${escapeXml(node.label)}">
        <attvalues>
          <attvalue for="0" value="${escapeXml(node.type)}" />
          <attvalue for="1" value="${escapeXml(node.displayName)}" />
        </attvalues>
      </node>
`;
                });

                gexf += `    </nodes>
    <edges>
`;
                edges.forEach((edge, index) => {
                    gexf += `      <edge id="${index}" source="${escapeXml(edge.source)}" target="${escapeXml(edge.target)}" />
`;
                });

                gexf += `    </edges>
  </graph>
</gexf>`;

                return gexf;
            }

            async reloadGraph(fileContent, fileName, isFromDatabase = false) {
                // ÈöêËóèÊ¨¢ËøéÁïåÈù¢
                this.hideWelcome();
                
                // ÊòæÁ§∫Âä†ËΩΩÂä®Áîª
                const loading = document.getElementById('loading');
                loading.style.display = 'flex';
                loading.style.opacity = '1';

                // Ê∏ÖÈô§ÊóßÁöÑÂõæÂΩ¢
                if (this.simulation) {
                    this.simulation.stop();
                }
                if (this.container) {
                    this.container.selectAll('*').remove();
                }
                
                // ÈáçÁΩÆÁä∂ÊÄÅ
                this.selectedNode = null;
                this.highlightedNodes.clear();
                this.frozen = false;
                document.getElementById('btnFreeze').classList.remove('active');
                
                // ‰øùÂ≠ò GEXF ÂÜÖÂÆπÁî®‰∫éÂØºÂá∫
                this.currentGexfContent = fileContent;
                this.currentFileName = fileName;
                
                // Âä†ËΩΩÊñ∞Êï∞ÊçÆ
                await this.loadData(fileContent);
                
                // ÈáçÊñ∞ËÆæÁΩÆÊ®°ÊãüÂíåÊ∏≤Êüì
                this.setupSimulation();
                this.render();
                
                // Êõ¥Êñ∞Êñá‰ª∂ÂêçÊòæÁ§∫Ôºà‰ΩøÁî®ÂΩìÂâçËØ≠Ë®ÄÔºâ
                const texts = i18n[currentLang];
                document.getElementById('fileName').textContent = `${texts.currentFile}: ${fileName}`;
                
                // Â¶ÇÊûúÊòØ‰ªéÊï∞ÊçÆÂ∫ìÂØºÂÖ•ÁöÑÔºåÊòæÁ§∫ÂØºÂá∫ÊåâÈíÆ
                const exportBtn = document.getElementById('btnExportGexf');
                if (isFromDatabase) {
                    exportBtn.style.display = 'flex';
                } else {
                    exportBtn.style.display = 'none';
                }
                
                // ÊòæÁ§∫ÊéíÂêçÂàóË°®
                this.showRankingList();
                
                // ÁßªÂä®Á´ØÂä†ËΩΩÊàêÂäüÂêéËá™Âä®ÈöêËóè‰æßËæπÊ†è
                if (window.innerWidth <= 900) {
                    document.querySelector('.sidebar').classList.remove('visible');
                    document.getElementById('sidebarOverlay').classList.remove('visible');
                    document.getElementById('menuToggle').classList.remove('active');
                }
                
                // ÈáçÁΩÆÊêúÁ¥¢Ê°Ü
                document.getElementById('searchInput').value = '';
                
                // ÈöêËóèÂä†ËΩΩÂä®Áîª
                this.hideLoading();
            }

            showRankingList() {
                // ÊåâËøûÊé•Êï∞ÊéíÂ∫è
                const sortedNodes = [...this.nodes].sort((a, b) => b.connections - a.connections);
                const texts = i18n[currentLang];
                
                const detailSection = document.getElementById('detailSection');
                detailSection.innerHTML = `
                    <div class="ranking-card">
                        <div class="ranking-header">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"></path>
                            </svg>
                            <span>${texts.mutualRanking}</span>
                        </div>
                        <div class="ranking-desc">${texts.clickToView}</div>
                        <div class="ranking-list">
                            ${sortedNodes.map((node, index) => `
                                <div class="ranking-item ${index < 3 ? 'top-' + (index + 1) : ''}" data-id="${node.id}">
                                    <span class="ranking-position">${index + 1}</span>
                                    <span class="ranking-name">${node.label}</span>
                                    <span class="ranking-score">${node.connections}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;

                // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂
                detailSection.querySelectorAll('.ranking-item[data-id]').forEach(item => {
                    item.addEventListener('click', () => {
                        const id = item.getAttribute('data-id');
                        const node = this.nodeMap.get(id);
                        if (node) {
                            this.selectedNode = node;
                            this.highlightConnections(node);
                            this.showNodeDetail(node);
                            this.centerOnNode(node);
                        }
                    });
                });
            }

            updateStats() {
                const nodeCount = this.nodes.length;
                const edgeCount = this.edges.length;
                const totalDegree = this.nodes.reduce((sum, n) => sum + n.connections, 0);
                const avgDegree = nodeCount > 0 ? (totalDegree / nodeCount).toFixed(1) : '0';
                const maxPossibleEdges = (nodeCount * (nodeCount - 1)) / 2;
                const density = maxPossibleEdges > 0 ? (edgeCount / maxPossibleEdges * 100).toFixed(2) : '0';

                document.getElementById('nodeCount').textContent = nodeCount;
                document.getElementById('edgeCount').textContent = edgeCount;
                document.getElementById('avgDegree').textContent = avgDegree;
                document.getElementById('density').textContent = density + '%';

                // ÁºìÂ≠òÊúÄÂ§ßËøûÊé•Êï∞ÔºåÈÅøÂÖçÈáçÂ§çËÆ°ÁÆó
                this.maxConnections = Math.max(...this.nodes.map(n => n.connections), 1);
                
                // È¢ÑËÆ°ÁÆóËäÇÁÇπÊéíÂêç
                this.nodeRanks = new Map();
                const sorted = [...this.nodes].sort((a, b) => b.connections - a.connections);
                sorted.forEach((node, index) => {
                    this.nodeRanks.set(node.id, index + 1);
                });
            }

            setupSimulation() {
                this.simulation = d3.forceSimulation(this.nodes)
                    .force('link', d3.forceLink(this.edges)
                        .id(d => d.id)
                        .distance(80))
                    .force('charge', d3.forceManyBody().strength(-300))
                    .force('center', d3.forceCenter(this.width / 2, this.height / 2))
                    .force('collision', d3.forceCollide().radius(d => this.getNodeRadius(d) + 5));
            }

            getNodeRadius(d) {
                const minRadius = 6;
                const maxRadius = 24;
                const maxConn = this.maxConnections || 10;
                const scale = d3.scaleLog()
                    .domain([1, maxConn])
                    .range([minRadius, maxRadius]);
                return scale(d.connections || 1);
            }

            getNodeColor(d) {
                // ‰ΩøÁî®ÁºìÂ≠òÁöÑÊúÄÂ§ßËøûÊé•Êï∞
                const ratio = d.connections / (this.maxConnections || 1);
                
                // ÁÅ∞Ëâ≤Âà∞Á≤âËâ≤ÁöÑÂíåË∞êÊ∏êÂèòÔºàÈ•±ÂíåÂ∫¶ÈÄíÂ¢û + Ëâ≤Áõ∏ÂÅèÁßªÔºâ
                if (ratio < 0.25) {
                    return '#5e6575'; // ÂÜ∑ÁÅ∞Ëìù - Â∞ëÈáèËøûÊé•
                } else if (ratio < 0.5) {
                    return '#8f7585'; // ÁÅ∞Áé´Áë∞ - ‰∏ÄËà¨ËøûÊé•
                } else if (ratio < 0.75) {
                    return '#c75a80'; // Áé´Áë∞Á≤â - ËæÉÂ§öËøûÊé•
                } else {
                    return '#ea2864'; // ‰∏ªËâ≤Ë∞ÉÁ≤âÁ∫¢ - Á§æ‰∫§‰∏≠ÂøÉ
                }
            }

            render() {
                // ÂàõÂª∫ÂÆπÂô®
                this.container = this.svg.append('g').attr('class', 'graph-container');

                // Ê∑ªÂä†Áº©Êîæ
                this.zoom = d3.zoom()
                    .scaleExtent([0.1, 4])
                    .on('zoom', (event) => {
                        this.container.attr('transform', event.transform);
                        // Ê†πÊçÆÁº©ÊîæÁ∫ßÂà´Âä®ÊÄÅÊòæÁ§∫/ÈöêËóèÊ†áÁ≠æÔºàÊÄßËÉΩ‰ºòÂåñÔºâ
                        this.updateLabelsVisibility(event.transform.k);
                    });

                this.svg.call(this.zoom);
                this.currentZoom = 1;

                // Ê∏≤ÊüìËæπ
                this.linkGroup = this.container.append('g').attr('class', 'links');
                this.links = this.linkGroup.selectAll('line')
                    .data(this.edges)
                    .enter()
                    .append('line')
                    .attr('class', 'link')
                    .attr('stroke', '#3d4f6f')
                    .attr('stroke-width', 1);

                // Ê∏≤ÊüìËäÇÁÇπ
                this.nodeGroup = this.container.append('g').attr('class', 'nodes');
                this.nodeElements = this.nodeGroup.selectAll('g')
                    .data(this.nodes)
                    .enter()
                    .append('g')
                    .attr('class', 'node')
                    .call(this.drag());

                // ËäÇÁÇπÂÖâÊôïÔºà‰ΩøÁî®Ê∏êÂèòÈÄèÊòéÂ∫¶‰ª£Êõø blur Êª§ÈïúÊèêÂçáÊÄßËÉΩÔºâ
                this.nodeElements.append('circle')
                    .attr('class', 'node-glow')
                    .attr('r', d => this.getNodeRadius(d) + 6)
                    .attr('fill', d => this.getNodeColor(d))
                    .attr('opacity', 0.15);

                // ËäÇÁÇπÂúÜÂúà
                this.nodeElements.append('circle')
                    .attr('class', 'node-circle')
                    .attr('r', d => this.getNodeRadius(d))
                    .attr('fill', d => this.getNodeColor(d))
                    .attr('stroke', '#fff')
                    .attr('stroke-width', 1.5);

                // ËäÇÁÇπÊ†áÁ≠æ
                this.labels = this.nodeElements.append('text')
                    .attr('class', 'node-label')
                    .attr('dy', d => this.getNodeRadius(d) + 14)
                    .attr('text-anchor', 'middle')
                    .text(d => d.label.length > 12 ? d.label.slice(0, 12) + '...' : d.label)
                    .style('opacity', this.showLabels ? 1 : 0);

                // ‰∫ã‰ª∂ÁõëÂê¨
                this.nodeElements
                    .on('mouseover', (event, d) => this.handleMouseOver(event, d))
                    .on('mouseout', (event, d) => this.handleMouseOut(event, d))
                    .on('click', (event, d) => this.handleClick(event, d));

                // Ê®°ÊãüÊõ¥Êñ∞
                this.simulation.on('tick', () => this.tick());
                
                // ÈáçÊñ∞ÂêØÂä®Ê®°Êãü‰ª•Á°Æ‰øùÂä®ÁîªÊïàÊûú
                this.simulation.alpha(1).restart();
            }

            tick() {
                this.links
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                this.nodeElements.attr('transform', d => `translate(${d.x}, ${d.y})`);
            }

            updateLabelsVisibility(zoomLevel) {
                if (!this.labels || !this.showLabels) return;
                
                this.currentZoom = zoomLevel;
                const nodeCount = this.nodes.length;
                
                // ËäÇÁÇπÊï∞ÈáèÂ§öÊó∂ÔºåÂè™Âú®Áº©ÊîæË∂≥Â§üÂ§ßÊó∂ÊòæÁ§∫Ê†áÁ≠æ
                if (nodeCount > 200) {
                    // ËäÇÁÇπÂ§öÊó∂ÔºåÁº©Êîæ > 0.8 ÊâçÊòæÁ§∫Ê†áÁ≠æ
                    const shouldShow = zoomLevel > 0.8;
                    this.labels.style('opacity', shouldShow ? 1 : 0);
                } else if (nodeCount > 100) {
                    // ‰∏≠Á≠âÊï∞ÈáèÔºåÁº©Êîæ > 0.5 ÊòæÁ§∫
                    const shouldShow = zoomLevel > 0.5;
                    this.labels.style('opacity', shouldShow ? 1 : 0);
                }
                // ËäÇÁÇπÂ∞ëÊó∂ÂßãÁªàÊòæÁ§∫
            }

            drag() {
                return d3.drag()
                    .on('start', (event, d) => {
                        this.isDragging = true;
                        // ÊãñÂä®ÂºÄÂßãÊó∂ÈöêËóè tooltip
                        document.getElementById('tooltip').classList.remove('visible');
                        if (!event.active) this.simulation.alphaTarget(0.3).restart();
                        d.fx = d.x;
                        d.fy = d.y;
                    })
                    .on('drag', (event, d) => {
                        d.fx = event.x;
                        d.fy = event.y;
                    })
                    .on('end', (event, d) => {
                        this.isDragging = false;
                        if (!event.active) this.simulation.alphaTarget(0);
                        if (!this.frozen) {
                            d.fx = null;
                            d.fy = null;
                        }
                    });
            }

            handleMouseOver(event, d) {
                // ÊãñÂä®ËøáÁ®ã‰∏≠‰∏çÂ§ÑÁêÜÊÇ¨ÂÅú‰∫ã‰ª∂ÔºåÈò≤Ê≠¢Èó™ÁÉÅ
                if (this.isDragging) return;
                
                const tooltip = document.getElementById('tooltip');
                tooltip.querySelector('.tooltip-name').textContent = d.label;
                
                // ‰ΩøÁî®È¢ÑËÆ°ÁÆóÁöÑÊéíÂêç
                const rank = this.nodeRanks ? this.nodeRanks.get(d.id) : '?';
                
                tooltip.querySelector('.tooltip-info').textContent = 
                    `ÂÖ±ÂêåÂ•ΩÂèã: ${d.connections} | ÊéíÂêç: #${rank}`;
                
                tooltip.style.left = (event.pageX + 15) + 'px';
                tooltip.style.top = (event.pageY - 10) + 'px';
                tooltip.classList.add('visible');

                // Âè™ÊúâÊú™ÈÄâ‰∏≠ËäÇÁÇπÊó∂ÔºåÊÇ¨ÂÅúÊâçÊîπÂèòÈ´ò‰∫Æ
                // Â∑≤ÈÄâ‰∏≠ËäÇÁÇπÊó∂ÔºåÊÇ¨ÂÅúÂè™ÊòæÁ§∫ tooltipÔºåÈúÄÁÇπÂáªÊâçÂàáÊç¢
                if (!this.selectedNode) {
                    this.highlightConnections(d);
                }
            }

            handleMouseOut(event, d) {
                // ÊãñÂä®ËøáÁ®ã‰∏≠‰∏çÂ§ÑÁêÜÊÇ¨ÂÅú‰∫ã‰ª∂ÔºåÈò≤Ê≠¢Èó™ÁÉÅ
                if (this.isDragging) return;
                
                const tooltip = document.getElementById('tooltip');
                tooltip.classList.remove('visible');
                
                // Â∑≤ÈÄâ‰∏≠ËäÇÁÇπÊó∂‰øùÊåÅÈ´ò‰∫ÆÔºåÊú™ÈÄâ‰∏≠Êó∂Ê∏ÖÈô§
                if (!this.selectedNode) {
                    this.clearHighlights();
                }
            }

            handleClick(event, d) {
                event.stopPropagation();
                this.selectedNode = d;
                this.highlightConnections(d);
                this.showNodeDetail(d);
            }

            highlightConnections(node) {
                this.highlightedNodes.clear();
                this.highlightedNodes.add(node.id);

                const connectedIds = new Set();
                this.edges.forEach(edge => {
                    const sourceId = typeof edge.source === 'object' ? edge.source.id : edge.source;
                    const targetId = typeof edge.target === 'object' ? edge.target.id : edge.target;
                    
                    if (sourceId === node.id) {
                        connectedIds.add(targetId);
                        this.highlightedNodes.add(targetId);
                    }
                    if (targetId === node.id) {
                        connectedIds.add(sourceId);
                        this.highlightedNodes.add(sourceId);
                    }
                });

                this.links
                    .classed('highlighted', d => {
                        const sourceId = typeof d.source === 'object' ? d.source.id : d.source;
                        const targetId = typeof d.target === 'object' ? d.target.id : d.target;
                        return sourceId === node.id || targetId === node.id;
                    })
                    .classed('dimmed', d => {
                        const sourceId = typeof d.source === 'object' ? d.source.id : d.source;
                        const targetId = typeof d.target === 'object' ? d.target.id : d.target;
                        return sourceId !== node.id && targetId !== node.id;
                    });

                this.nodeElements.style('opacity', d => 
                    this.highlightedNodes.has(d.id) ? 1 : 0.2
                );
            }

            clearHighlights() {
                if (this.links) this.links.classed('highlighted', false).classed('dimmed', false);
                if (this.nodeElements) this.nodeElements.style('opacity', 1);
                this.highlightedNodes.clear();
            }

            showNodeDetail(node) {
                // ‰ΩøÁî® Set ÂéªÈáçÔºåÈÅøÂÖçÈáçÂ§çÂ•ΩÂèã
                const connectionSet = new Set();
                const connections = [];
                
                this.edges.forEach(edge => {
                    const sourceId = typeof edge.source === 'object' ? edge.source.id : edge.source;
                    const targetId = typeof edge.target === 'object' ? edge.target.id : edge.target;
                    
                    if (sourceId === node.id && this.nodeMap.has(targetId) && !connectionSet.has(targetId)) {
                        connectionSet.add(targetId);
                        connections.push(this.nodeMap.get(targetId));
                    }
                    if (targetId === node.id && this.nodeMap.has(sourceId) && !connectionSet.has(sourceId)) {
                        connectionSet.add(sourceId);
                        connections.push(this.nodeMap.get(sourceId));
                    }
                });

                // ÊåâËøûÊé•Êï∞ÊéíÂ∫è
                connections.sort((a, b) => b.connections - a.connections);

                // ‰ΩøÁî®È¢ÑËÆ°ÁÆóÁöÑÊéíÂêç
                const rank = this.nodeRanks ? this.nodeRanks.get(node.id) : '?';

                const texts = i18n[currentLang];
                const detailSection = document.getElementById('detailSection');
                detailSection.innerHTML = `
                    <div class="detail-card">
                        <div class="detail-header-row">
                            <div class="detail-name">${node.label}</div>
                            <button class="remove-node-btn" data-id="${node.id}" title="${texts.removeNode}">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M18 6L6 18"></path>
                                    <path d="M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="detail-rank">
                            <span class="rank-badge">${texts.rank} #${rank}</span>
                            <span class="rank-desc">${texts.total} ${this.nodes.length} ${texts.people}</span>
                        </div>
                        
                        <div class="detail-stats">
                            <div class="detail-stat full-width">
                                <div class="detail-stat-value">${connections.length}</div>
                                <div class="detail-stat-label">${texts.mutualCount}</div>
                            </div>
                        </div>
                        
                        <div class="connections-list">
                            <div class="connections-title">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="9" cy="7" r="4"></circle>
                                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                </svg>
                                ${texts.mutualList} (${connections.length})
                            </div>
                            <div class="connections-container">
                                ${connections.map(c => `
                                    <div class="connection-item" data-id="${c.id}">
                                        <div class="connection-dot" style="background: ${this.getNodeColor(c)}"></div>
                                        <span class="connection-name">${c.label}</span>
                                        <span class="connection-count">${c.connections}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;

                // Ê∑ªÂä†ËøûÊé•È°πÁÇπÂáª‰∫ã‰ª∂
                detailSection.querySelectorAll('.connection-item[data-id]').forEach(item => {
                    item.addEventListener('click', () => {
                        const id = item.getAttribute('data-id');
                        const targetNode = this.nodeMap.get(id);
                        if (targetNode) {
                            this.selectedNode = targetNode;
                            this.highlightConnections(targetNode);
                            this.showNodeDetail(targetNode);
                            this.centerOnNode(targetNode);
                        }
                    });
                });

                // Ê∑ªÂä†ÁßªÈô§ÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
                const removeBtn = detailSection.querySelector('.remove-node-btn');
                if (removeBtn) {
                    removeBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const nodeId = removeBtn.getAttribute('data-id');
                        this.removeNode(nodeId);
                    });
                }
            }

            removeNode(nodeId) {
                // ‰ªéËäÇÁÇπÊï∞ÁªÑ‰∏≠ÁßªÈô§
                const nodeIndex = this.nodes.findIndex(n => n.id === nodeId);
                if (nodeIndex === -1) return;
                
                const removedNode = this.nodes[nodeIndex];
                this.nodes.splice(nodeIndex, 1);
                this.nodeMap.delete(nodeId);

                // ÁßªÈô§Áõ∏ÂÖ≥ÁöÑËæπ
                this.edges = this.edges.filter(edge => {
                    const sourceId = typeof edge.source === 'object' ? edge.source.id : edge.source;
                    const targetId = typeof edge.target === 'object' ? edge.target.id : edge.target;
                    return sourceId !== nodeId && targetId !== nodeId;
                });

                // ÈáçÊñ∞ËÆ°ÁÆóÊâÄÊúâËäÇÁÇπÁöÑËøûÊé•Êï∞
                this.nodes.forEach(node => {
                    const connectionSet = new Set();
                    this.edges.forEach(edge => {
                        const sourceId = typeof edge.source === 'object' ? edge.source.id : edge.source;
                        const targetId = typeof edge.target === 'object' ? edge.target.id : edge.target;
                        if (sourceId === node.id && targetId !== node.id) {
                            connectionSet.add(targetId);
                        }
                        if (targetId === node.id && sourceId !== node.id) {
                            connectionSet.add(sourceId);
                        }
                    });
                    node.connections = connectionSet.size;
                });

                // Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØ
                this.updateStats();

                // ÈáçÊñ∞Ê∏≤ÊüìÂõæÂΩ¢
                this.simulation.stop();
                this.container.selectAll('*').remove();
                this.setupSimulation();
                this.render();

                // ÈáçÁΩÆÈÄâ‰∏≠Áä∂ÊÄÅÔºåÊòæÁ§∫ÊéíÂêçÂàóË°®
                this.selectedNode = null;
                this.highlightedNodes.clear();
                this.showRankingList();
            }

            centerOnNode(node) {
                const scale = 1.5;
                const x = this.width / 2 - node.x * scale;
                const y = this.height / 2 - node.y * scale;
                
                this.svg.transition()
                    .duration(750)
                    .call(this.zoom.transform, d3.zoomIdentity.translate(x, y).scale(scale));
            }

            setupControls() {
                // GEXF Êñá‰ª∂ÈÄâÊã©
                const fileInput = document.getElementById('fileInput');
                const btnLoadFile = document.getElementById('btnLoadFile');
                const welcomeUploadBtn = document.getElementById('welcomeUploadBtn');
                
                const triggerFileInput = () => fileInput.click();
                
                btnLoadFile.addEventListener('click', triggerFileInput);
                welcomeUploadBtn.addEventListener('click', triggerFileInput);
                
                fileInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        try {
                            const content = await this.loadFromFile(file);
                            await this.reloadGraph(content, file.name);
                        } catch (error) {
                            console.error('ËØªÂèñÊñá‰ª∂Â§±Ë¥•:', error);
                            alert('ËØªÂèñÊñá‰ª∂Â§±Ë¥•');
                        }
                    }
                    fileInput.value = '';
                });

                // VRCX Êï∞ÊçÆÂ∫ìÈÄâÊã©
                const dbFileInput = document.getElementById('dbFileInput');
                const btnLoadDB = document.getElementById('btnLoadDB');
                const welcomeUploadDBBtn = document.getElementById('welcomeUploadDBBtn');
                
                const triggerDBInput = () => dbFileInput.click();
                
                btnLoadDB.addEventListener('click', triggerDBInput);
                welcomeUploadDBBtn.addEventListener('click', triggerDBInput);
                
                dbFileInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        try {
                            await this.loadFromVRCXDatabase(file);
                        } catch (error) {
                            console.error('Ëß£ÊûêÊï∞ÊçÆÂ∫ìÂ§±Ë¥•:', error);
                            alert('Ëß£ÊûêÊï∞ÊçÆÂ∫ìÂ§±Ë¥•: ' + error.message);
                        }
                    }
                    dbFileInput.value = '';
                });

                // ÂØºÂá∫ GEXF ÊåâÈíÆ
                const btnExportGexf = document.getElementById('btnExportGexf');
                btnExportGexf.addEventListener('click', () => {
                    if (this.currentGexfContent) {
                        this.exportGexf();
                    }
                });

                // ÊêúÁ¥¢
                const searchInput = document.getElementById('searchInput');
                searchInput.addEventListener('input', (e) => this.handleSearch(e.target.value));

                // ÂäõÂ∫¶ÊªëÂùó
                const forceSlider = document.getElementById('forceSlider');
                forceSlider.addEventListener('input', (e) => {
                    const value = parseInt(e.target.value);
                    document.getElementById('forceValue').textContent = value;
                    if (this.simulation) {
                        this.simulation.force('charge').strength(value);
                        this.simulation.alpha(0.3).restart();
                    }
                });

                // Ë∑ùÁ¶ªÊªëÂùó
                const distanceSlider = document.getElementById('distanceSlider');
                distanceSlider.addEventListener('input', (e) => {
                    const value = parseInt(e.target.value);
                    document.getElementById('distanceValue').textContent = value;
                    if (this.simulation) {
                        this.simulation.force('link').distance(value);
                        this.simulation.alpha(0.3).restart();
                    }
                });

                // ÊòæÁ§∫Ê†áÁ≠æ
                const btnShowLabels = document.getElementById('btnShowLabels');
                btnShowLabels.addEventListener('click', () => {
                    this.showLabels = !this.showLabels;
                    btnShowLabels.classList.toggle('active', this.showLabels);
                    if (this.labels) {
                        if (this.showLabels) {
                            // ÂêØÁî®Êó∂Ê†πÊçÆÁº©ÊîæÁ∫ßÂà´ÂÜ≥ÂÆöÊòØÂê¶ÊòæÁ§∫
                            this.updateLabelsVisibility(this.currentZoom || 1);
                        } else {
                            this.labels.transition().duration(200).style('opacity', 0);
                        }
                    }
                });

                // ÈáçÁΩÆËßÜÂõæ
                const btnReset = document.getElementById('btnReset');
                btnReset.addEventListener('click', () => {
                    if (!this.simulation) return;
                    this.svg.transition()
                        .duration(750)
                        .call(this.zoom.transform, d3.zoomIdentity);
                    this.selectedNode = null;
                    this.clearHighlights();
                    this.simulation.alpha(0.3).restart();
                });

                // ÂÜªÁªìÂ∏ÉÂ±Ä
                const btnFreeze = document.getElementById('btnFreeze');
                btnFreeze.addEventListener('click', () => {
                    if (!this.simulation) return;
                    this.frozen = !this.frozen;
                    btnFreeze.classList.toggle('active', this.frozen);
                    
                    if (this.frozen) {
                        this.simulation.stop();
                        this.nodes.forEach(n => {
                            n.fx = n.x;
                            n.fy = n.y;
                        });
                    } else {
                        this.nodes.forEach(n => {
                            n.fx = null;
                            n.fy = null;
                        });
                        this.simulation.alpha(0.3).restart();
                    }
                });

                // Áº©ÊîæÊåâÈíÆ
                document.getElementById('zoomIn').addEventListener('click', () => {
                    if (this.zoom) this.svg.transition().call(this.zoom.scaleBy, 1.5);
                });

                document.getElementById('zoomOut').addEventListener('click', () => {
                    if (this.zoom) this.svg.transition().call(this.zoom.scaleBy, 0.67);
                });

                document.getElementById('zoomFit').addEventListener('click', () => {
                    if (this.container) this.fitToView();
                });

                // ÁÇπÂáªÁ©∫ÁôΩÂ§ÑÂèñÊ∂àÈÄâÊã©ÔºåÊòæÁ§∫ÊéíÂêçÂàóË°®
                this.svg.on('click', () => {
                    if (!this.simulation) return;
                    this.selectedNode = null;
                    this.clearHighlights();
                    this.showRankingList();
                });
            }

            handleSearch(query) {
                if (!this.nodeElements || !this.links) return;
                
                const normalizedQuery = query.toLowerCase().trim();
                
                if (!normalizedQuery) {
                    this.nodeElements.style('opacity', 1);
                    this.links.style('opacity', 0.4);
                    return;
                }

                const matchingNodes = new Set();
                this.nodes.forEach(node => {
                    if (node.label.toLowerCase().includes(normalizedQuery)) {
                        matchingNodes.add(node.id);
                    }
                });

                this.nodeElements.style('opacity', d => 
                    matchingNodes.has(d.id) ? 1 : 0.1
                );

                this.links.style('opacity', d => {
                    const sourceId = typeof d.source === 'object' ? d.source.id : d.source;
                    const targetId = typeof d.target === 'object' ? d.target.id : d.target;
                    return matchingNodes.has(sourceId) || matchingNodes.has(targetId) ? 0.6 : 0.05;
                });

                // Â¶ÇÊûúÂè™Êúâ‰∏Ä‰∏™ÂåπÈÖçÔºåËá™Âä®ÈÄâ‰∏≠Âπ∂Â±Ö‰∏≠
                if (matchingNodes.size === 1) {
                    const nodeId = [...matchingNodes][0];
                    const node = this.nodeMap.get(nodeId);
                    if (node) {
                        this.selectedNode = node;
                        this.showNodeDetail(node);
                        this.centerOnNode(node);
                    }
                }
            }

            fitToView() {
                const bounds = this.container.node().getBBox();
                const padding = 50;
                
                const scale = Math.min(
                    (this.width - padding * 2) / bounds.width,
                    (this.height - padding * 2) / bounds.height,
                    2
                );
                
                const x = this.width / 2 - (bounds.x + bounds.width / 2) * scale;
                const y = this.height / 2 - (bounds.y + bounds.height / 2) * scale;
                
                this.svg.transition()
                    .duration(750)
                    .call(this.zoom.transform, d3.zoomIdentity.translate(x, y).scale(scale));
            }

            hideLoading() {
                const loading = document.getElementById('loading');
                loading.style.opacity = '0';
                setTimeout(() => {
                    loading.style.display = 'none';
                }, 300);
            }

            exportGexf() {
                if (!this.currentGexfContent) return;
                
                // ÂàõÂª∫ÂØºÂá∫Êñá‰ª∂Âêç
                let exportFileName = this.currentFileName || 'mutual_graph';
                if (exportFileName.endsWith('.sqlite3') || exportFileName.endsWith('.db')) {
                    exportFileName = exportFileName.replace(/\.(sqlite3|db)$/i, '.gexf');
                } else if (!exportFileName.endsWith('.gexf')) {
                    exportFileName += '.gexf';
                }
                
                // ÂàõÂª∫ Blob Âπ∂‰∏ãËΩΩ
                const blob = new Blob([this.currentGexfContent], { type: 'application/xml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = exportFileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        }

        // ÂêØÂä®Â∫îÁî®
        document.addEventListener('DOMContentLoaded', () => {
            // ÂàùÂßãÂåñËØ≠Ë®ÄÈÄâÊã©Âô®
            const langBtn = document.getElementById('langBtn');
            const langDropdown = document.getElementById('langDropdown');
            
            // ‰ªé localStorage ËØªÂèñËØ≠Ë®ÄÂÅèÂ•Ω
            const savedLang = localStorage.getItem('preferredLang') || 'zh';
            updateLanguage(savedLang);
            
            // ËØ≠Ë®ÄÂàáÊç¢ÁÇπÂáª‰∫ã‰ª∂
            langDropdown.querySelectorAll('.lang-option').forEach(option => {
                option.addEventListener('click', () => {
                    const lang = option.getAttribute('data-lang');
                    updateLanguage(lang);
                });
            });

            // ÁßªÂä®Á´Ø‰æßËæπÊ†èÊéßÂà∂
            const menuToggle = document.getElementById('menuToggle');
            const sidebar = document.querySelector('.sidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            let isMobile = window.innerWidth <= 900;

            function updateMenuTogglePosition() {
                if (!menuToggle) return;
                if (window.innerWidth > 900) {
                    menuToggle.style.left = '';
                    return;
                }
                const logoSection = document.querySelector('.logo-section');
                if (!logoSection) return;
                const paddingLeft = parseFloat(getComputedStyle(logoSection).paddingLeft) || 0;
                const btnWidth = parseFloat(getComputedStyle(menuToggle).width) || 0;
                const offset = Math.max(6, (paddingLeft - btnWidth) / 2);
                menuToggle.style.left = `${offset}px`;
            }

            function showSidebar() {
                sidebar.classList.add('visible');
                sidebarOverlay.classList.add('visible');
                menuToggle.classList.add('active');
            }

            function hideSidebar() {
                sidebar.classList.remove('visible');
                sidebarOverlay.classList.remove('visible');
                menuToggle.classList.remove('active');
            }

            // ËèúÂçïÊåâÈíÆÁÇπÂáª
            if (menuToggle) {
                menuToggle.addEventListener('click', () => {
                    if (sidebar.classList.contains('visible')) {
                        hideSidebar();
                    } else {
                        showSidebar();
                    }
                });
                updateMenuTogglePosition();
            }

            // ÈÅÆÁΩ©ÁÇπÂáªÂÖ≥Èó≠
            if (sidebarOverlay) {
                sidebarOverlay.addEventListener('click', hideSidebar);
            }

            // ÂìçÂ∫îÁ™óÂè£Â§ßÂ∞èÂèòÂåñ
            window.addEventListener('resize', () => {
                const wasMobile = isMobile;
                isMobile = window.innerWidth <= 900;
                
                // ‰ªéÁßªÂä®Á´ØÂàáÊç¢Âà∞Ê°åÈù¢Á´ØÊó∂ÔºåÁßªÈô§ÁßªÂä®Á´ØÊ†∑Âºè
                if (wasMobile && !isMobile) {
                    sidebar.classList.remove('visible');
                    sidebarOverlay.classList.remove('visible');
                }
                updateMenuTogglePosition();
            });

            window.networkViz = new NetworkVisualization();
        });
    </script>
</body>
</html>

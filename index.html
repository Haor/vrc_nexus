<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mutual Friends Network</title>
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 100 100'><rect width='100' height='100' fill='%230f0f14'/><line x1='50' y1='25' x2='25' y2='50' stroke='%23ea2864' stroke-width='2' opacity='0.6'/><line x1='50' y1='25' x2='75' y2='50' stroke='%23ea2864' stroke-width='2' opacity='0.6'/><line x1='25' y1='50' x2='50' y2='75' stroke='%23ea2864' stroke-width='2' opacity='0.6'/><line x1='75' y1='50' x2='50' y2='75' stroke='%23ea2864' stroke-width='2' opacity='0.6'/><line x1='25' y1='50' x2='75' y2='50' stroke='%23ea2864' stroke-width='1.5' opacity='0.4'/><line x1='50' y1='25' x2='50' y2='75' stroke='%23ea2864' stroke-width='1.5' opacity='0.4'/><circle cx='50' cy='25' r='10' fill='%23c75a80' opacity='0.9'/><circle cx='25' cy='50' r='8' fill='%235e6575' opacity='0.9'/><circle cx='75' cy='50' r='8' fill='%238f7585' opacity='0.9'/><circle cx='50' cy='75' r='12' fill='%23ea2864'/><circle cx='50' cy='50' r='6' fill='%23c75a80' opacity='0.85'/></svg>">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Noto+Sans+SC:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            /* 基于参考配色卡 - Black Color Palettes */
            --bg-primary: #0f0f14;
            --bg-secondary: #16141c;
            --bg-card: #1b1e26;
            --bg-hover: #252830;
            --accent-primary: #ea2864;
            --accent-light: #ff4d7f;
            --accent-dark: #c41e52;
            --accent-secondary: #2d2a35;
            --text-primary: #f5f5f7;
            --text-secondary: #a8a8b3;
            --text-muted: #8a8a96;  /* 提亮以满足 WCAG AA 4.5:1 对比度 */
            --border-color: #2a2832;
            --glow-primary: 0 0 20px rgba(234, 40, 100, 0.4);
            --glow-soft: 0 0 30px rgba(234, 40, 100, 0.2);
            --mobile-header-icon-top: 30px;
            --menu-btn-size: 36px;
            --menu-icon-size: 24px;
            --mobile-logo-padding-h: 52px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* 统一 Focus 状态 - 键盘可访问性 */
        :focus-visible {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
        }

        button:focus-visible,
        a:focus-visible,
        input:focus-visible {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
        }

        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
        }

        /* ========== 液态玻璃效果基础样式 ========== */
        .liquid-glass {
            background: linear-gradient(
                135deg,
                rgba(255, 255, 255, 0.08) 0%,
                rgba(255, 255, 255, 0.02) 50%,
                rgba(255, 255, 255, 0.05) 100%
            );
            backdrop-filter: blur(16px) saturate(180%);
            -webkit-backdrop-filter: blur(16px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.12);
            box-shadow:
                0 8px 32px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1),
                inset 0 -1px 0 rgba(0, 0, 0, 0.1);
            position: relative;
        }

        /* 液态玻璃边缘高光 */
        .liquid-glass::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(
                90deg,
                transparent 0%,
                rgba(255, 255, 255, 0.3) 20%,
                rgba(255, 255, 255, 0.4) 50%,
                rgba(255, 255, 255, 0.3) 80%,
                transparent 100%
            );
            border-radius: inherit;
            pointer-events: none;
        }

        /* 粉色调液态玻璃变体 */
        .liquid-glass-pink {
            background: linear-gradient(
                135deg,
                rgba(234, 40, 100, 0.12) 0%,
                rgba(234, 40, 100, 0.04) 50%,
                rgba(234, 40, 100, 0.08) 100%
            );
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(234, 40, 100, 0.2);
            box-shadow:
                0 8px 32px rgba(234, 40, 100, 0.15),
                0 2px 8px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1),
                inset 0 -1px 0 rgba(0, 0, 0, 0.05);
            position: relative;
        }

        .liquid-glass-pink::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(
                90deg,
                transparent 0%,
                rgba(255, 77, 127, 0.4) 20%,
                rgba(255, 77, 127, 0.6) 50%,
                rgba(255, 77, 127, 0.4) 80%,
                transparent 100%
            );
            border-radius: inherit;
            pointer-events: none;
        }

        /* 背景动画 */
        .bg-pattern {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(ellipse at 30% 70%, rgba(234, 40, 100, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 70% 30%, rgba(234, 40, 100, 0.05) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(45, 42, 53, 0.3) 0%, transparent 70%);
            pointer-events: none;
            z-index: 0;
        }

        .grid-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image:
                linear-gradient(rgba(234, 40, 100, 0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(234, 40, 100, 0.02) 1px, transparent 1px);
            background-size: 48px 48px;
            pointer-events: none;
            z-index: 1;
        }

        /* 主容器 */
        .container {
            display: flex;
            height: 100vh;
            position: relative;
            z-index: 10;
        }

        /* 侧边栏 */
        .sidebar {
            width: 400px;
            background: linear-gradient(180deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        .sidebar::-webkit-scrollbar-thumb:hover {
            background: var(--accent-primary);
        }

        .sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 1px;
            height: 100%;
            background: linear-gradient(180deg, var(--accent-primary), var(--accent-dark), var(--bg-card));
            opacity: 0.6;
        }

        .logo-section {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            background: linear-gradient(135deg, rgba(234, 40, 100, 0.05) 0%, transparent 100%);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .logo-content {
            flex: 1;
        }

        .logo {
            font-family: 'Orbitron', sans-serif;
            font-size: 22px;
            font-weight: 900;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        .logo-subtitle {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
            letter-spacing: 3px;
        }

        /* GitHub 链接 */
        .github-link {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            transition: color 0.2s ease;
        }

        .github-link:hover {
            color: var(--accent-primary);
        }

        /* 语言选择 */
        .lang-selector {
            position: relative;
        }

        .lang-btn {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            transition: color 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .lang-btn svg {
            width: 22px;
            height: 22px;
            stroke: var(--text-secondary);
            transition: stroke 0.2s ease;
        }

        .lang-btn:hover svg {
            stroke: var(--accent-primary);
        }

        .lang-btn:hover {
            color: var(--accent-primary);
        }

        .lang-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.2s ease;
            z-index: 1000;
            min-width: 100px;
        }

        .lang-selector:hover .lang-dropdown,
        .lang-dropdown.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .lang-option {
            padding: 10px 16px;
            font-size: 12px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .lang-option:hover {
            background: var(--bg-hover);
            color: var(--accent-primary);
        }

        .lang-option.active {
            background: rgba(234, 40, 100, 0.1);
            color: var(--accent-primary);
        }

        /* 文件选择 */
        .file-section {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .file-btn-group {
            display: flex;
            gap: 8px;
        }

        .file-btn {
            flex: 1;
            padding: 12px 16px;
            background: rgba(234, 40, 100, 0.08);
            border: 1px dashed rgba(234, 40, 100, 0.4);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 12px;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .file-btn:hover {
            background: rgba(234, 40, 100, 0.15);
            border-color: var(--accent-primary);
            box-shadow: var(--glow-soft);
        }

        .file-btn svg {
            stroke: var(--accent-primary);
        }

        .file-btn-db {
            background: rgba(45, 42, 53, 0.5);
            border-color: var(--accent-secondary);
        }

        .file-btn-db svg {
            stroke: var(--text-secondary);
        }

        .file-btn-db:hover {
            border-color: var(--accent-primary);
            box-shadow: var(--glow-soft);
        }

        .file-btn-db:hover svg {
            stroke: var(--accent-primary);
        }

        .file-info {
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .file-name {
            font-size: 11px;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 280px;
        }

        .export-btn {
            width: 22px;
            height: 22px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .export-btn:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
            background: rgba(234, 40, 100, 0.1);
        }

        .export-btn svg {
            stroke: currentColor;
        }

        /* 搜索框 */
        .search-section {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .search-wrapper {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 14px 20px 14px 48px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: var(--glow-soft);
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }

        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
        }

        /* 统计卡片 */
        .stats-section {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .stats-title {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--text-muted);
            margin-bottom: 16px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(27, 30, 38, 0.9) 0%, rgba(22, 20, 28, 0.95) 100%);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(8px);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-dark));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .stat-card:hover {
            background: var(--bg-hover);
            transform: translateY(-2px);
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        /* stat-card 顶部渐变条统一粉色系 */
        .stat-card:nth-child(2)::before {
            background: linear-gradient(90deg, var(--accent-light), var(--accent-primary));
        }

        .stat-card:nth-child(3)::before {
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-dark));
        }

        .stat-card:nth-child(4)::before {
            background: linear-gradient(90deg, var(--accent-dark), var(--accent-primary));
        }

        .stat-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 26px;
            font-weight: 700;
            color: var(--accent-primary);
            line-height: 1;
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 8px;
        }

        /* 控制面板 */
        .controls-section {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .control-group {
            margin-bottom: 16px;
        }

        .control-group:last-child {
            margin-bottom: 0;
        }

        .control-label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .control-value {
            color: var(--accent-primary);
            font-family: 'Orbitron', sans-serif;
            font-size: 11px;
        }

        .slider {
            width: 100%;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--bg-hover);
            border-radius: 2px;
            outline: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--accent-primary);
            cursor: pointer;
            box-shadow: var(--glow-primary);
            transition: all 0.2s ease;
        }

        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.15);
        }

        /* 按钮组 */
        .btn-group {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-card);
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn:hover {
            background: var(--bg-hover);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .btn.active {
            background: rgba(234, 40, 100, 0.15);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        /* 节点详情 */
        .detail-section {
            padding: 20px 24px;
            min-height: 300px;
        }

        .detail-header {
            margin-bottom: 20px;
        }

        .detail-placeholder {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-muted);
        }

        .detail-placeholder-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* 排行榜样式 */
        .ranking-card {
            background: linear-gradient(180deg, var(--bg-card) 0%, rgba(22, 20, 28, 0.8) 100%);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
        }

        .ranking-header {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 16px;
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 8px;
        }

        .ranking-header svg {
            stroke: var(--accent-primary);
        }

        .ranking-sub-label {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 400;
            margin-left: 4px;
        }

        .ranking-desc {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 16px;
        }

        .ranking-list {
            max-height: 500px;
            overflow-y: auto;
            padding-right: 4px;
        }

        .ranking-list::-webkit-scrollbar {
            width: 4px;
        }

        .ranking-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .ranking-list::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 2px;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
        }

        .ranking-item:hover {
            background: var(--bg-hover);
            border-color: var(--border-color);
            transform: translateX(4px);
        }

        .ranking-item.top-1 {
            background: linear-gradient(135deg, rgba(234, 40, 100, 0.18), rgba(234, 40, 100, 0.05));
            border-color: rgba(234, 40, 100, 0.5);
            box-shadow: 0 0 12px rgba(234, 40, 100, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.05);
        }

        .ranking-item.top-1 .ranking-position {
            background: linear-gradient(135deg, #ea2864, #c41e52);
            color: #fff;
            box-shadow: 0 0 8px rgba(234, 40, 100, 0.4);
        }

        .ranking-item.top-2 {
            background: linear-gradient(135deg, rgba(199, 90, 128, 0.15), rgba(199, 90, 128, 0.05));
            border-color: rgba(199, 90, 128, 0.4);
            box-shadow: 0 0 10px rgba(199, 90, 128, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.03);
        }

        .ranking-item.top-2 .ranking-position {
            background: linear-gradient(135deg, #c75a80, #a84d6d);
            color: #fff;
            box-shadow: 0 0 6px rgba(199, 90, 128, 0.3);
        }

        .ranking-item.top-3 {
            background: linear-gradient(135deg, rgba(143, 117, 133, 0.15), rgba(143, 117, 133, 0.05));
            border-color: rgba(143, 117, 133, 0.4);
            box-shadow: 0 0 8px rgba(143, 117, 133, 0.08), inset 0 1px 0 rgba(255, 255, 255, 0.02);
        }

        .ranking-item.top-3 .ranking-position {
            background: linear-gradient(135deg, #8f7585, #7a6472);
            color: #fff;
            box-shadow: 0 0 5px rgba(143, 117, 133, 0.25);
        }

        .ranking-position {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-card);
            border-radius: 6px;
            font-family: 'Orbitron', sans-serif;
            font-size: 12px;
            font-weight: 700;
            color: var(--text-muted);
            margin-right: 12px;
            flex-shrink: 0;
        }

        .ranking-name {
            flex: 1;
            font-size: 13px;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .ranking-score {
            font-family: 'Orbitron', sans-serif;
            font-size: 13px;
            font-weight: 700;
            color: var(--accent-primary);
            margin-left: 10px;
        }

        .ranking-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 12px;
            padding: 4px;
            background: var(--bg-primary);
            border-radius: 8px;
        }

        .ranking-tab {
            flex: 1;
            padding: 10px 6px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .ranking-tab:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .ranking-tab.active {
            background: var(--accent-primary);
            color: #fff;
        }

        .ranking-time-selector {
            display: flex;
            gap: 4px;
            margin-bottom: 12px;
        }

        .ranking-time-btn {
            padding: 4px 10px;
            border: 1px solid var(--border-color);
            background: transparent;
            color: var(--text-muted);
            font-size: 11px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .ranking-time-btn:hover {
            border-color: var(--accent-primary);
            color: var(--text-primary);
        }

        .ranking-time-btn.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: #fff;
        }

        .ranking-data-hint {
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 8px;
            padding: 6px 8px;
            background: rgba(234, 40, 100, 0.1);
            border-radius: 4px;
            border-left: 2px solid var(--accent-primary);
        }

        /* Account Selector Modal */
        .account-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(4px);
        }

        .account-modal {
            background: linear-gradient(
                135deg,
                rgba(27, 30, 38, 0.9) 0%,
                rgba(22, 20, 28, 0.95) 100%
            );
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 24px;
            min-width: 320px;
            max-width: 90vw;
            max-height: 80vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease;
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            box-shadow:
                0 24px 80px rgba(0, 0, 0, 0.5),
                0 0 40px rgba(234, 40, 100, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            position: relative;
        }

        .account-modal::before {
            content: '';
            position: absolute;
            top: 0;
            left: 15%;
            right: 15%;
            height: 1px;
            background: linear-gradient(
                90deg,
                transparent 0%,
                rgba(255, 77, 127, 0.4) 50%,
                transparent 100%
            );
            border-radius: 20px 20px 0 0;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .account-modal-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .account-modal-desc {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 16px;
        }

        .account-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .account-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .account-item:hover {
            border-color: var(--accent-primary);
            background: rgba(234, 40, 100, 0.1);
        }

        .account-item-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-primary), #ff6b9d);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #fff;
        }

        .account-item-info {
            flex: 1;
        }

        .account-item-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .account-item-id {
            font-size: 11px;
            color: var(--text-muted);
            font-family: 'Orbitron', monospace;
        }

        .detail-card {
            background: linear-gradient(180deg, var(--bg-card) 0%, rgba(22, 20, 28, 0.9) 100%);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .detail-header-row {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 10px;
        }

        .detail-name {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 4px;
            color: var(--accent-primary);
            flex: 1;
            word-break: break-word;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }

        .close-detail-btn {
            width: 28px;
            height: 28px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
            opacity: 0.6;
        }

        .close-detail-btn:hover {
            opacity: 1;
            border-color: var(--text-muted);
            color: var(--text-primary);
            background: var(--bg-hover);
        }

        .close-detail-btn svg {
            stroke: currentColor;
        }

        .remove-node-btn {
            width: 100%;
            padding: 10px 16px;
            margin-top: 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: transparent;
            color: var(--text-muted);
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s ease;
        }

        .remove-node-btn:hover {
            border-color: #e74c3c;
            color: #e74c3c;
            background: rgba(231, 76, 60, 0.1);
        }

        .remove-node-btn svg {
            stroke: currentColor;
        }

        .detail-rank {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }

        .rank-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            background: rgba(234, 40, 100, 0.15);
            color: var(--accent-primary);
            border: 1px solid rgba(234, 40, 100, 0.3);
        }

        .rank-desc {
            font-size: 11px;
            color: var(--text-muted);
        }

        .detail-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 16px;
        }

        .detail-stat {
            background: var(--bg-secondary);
            padding: 12px;
            border-radius: 8px;
        }

        .detail-stat-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 20px;
            color: var(--accent-primary);
        }

        .detail-stat-label {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .detail-stat.full-width {
            grid-column: 1 / -1;
            text-align: center;
        }

        .connections-list {
            margin-top: 16px;
            max-height: none;
        }

        .connections-container {
            max-height: 400px;
            overflow-y: auto;
            padding-right: 4px;
        }

        .connections-container::-webkit-scrollbar {
            width: 4px;
        }

        .connections-container::-webkit-scrollbar-track {
            background: transparent;
        }

        .connections-container::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 2px;
        }

        .connections-title {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .connection-item {
            padding: 10px 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid transparent;
        }

        .connection-item:hover {
            background: var(--bg-hover);
            border-color: var(--border-color);
            transform: translateX(4px);
        }

        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-primary);
        }

        .connection-name {
            font-size: 13px;
            color: var(--text-primary);
            flex: 1;
        }

        .connection-count {
            font-family: 'Orbitron', sans-serif;
            font-size: 11px;
            color: var(--text-muted);
            background: var(--bg-card);
            padding: 2px 8px;
            border-radius: 10px;
        }

        /* 节点详情增强 - 信任等级徽章 */
        .trust-level-badge {
            display: inline-flex;
            align-items: center;
            padding: 4px 10px 5px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            line-height: 1;
        }

        .trust-level-badge.visitor { background: rgba(204, 204, 204, 0.2); color: #cccccc; }
        .trust-level-badge.new-user { background: rgba(23, 120, 255, 0.2); color: #1778ff; }
        .trust-level-badge.user { background: rgba(43, 207, 92, 0.2); color: #2bcf5c; }
        .trust-level-badge.known-user { background: rgba(255, 123, 66, 0.2); color: #ff7b42; }
        .trust-level-badge.trusted-user { background: rgba(129, 67, 230, 0.2); color: #8143e6; }

        /* 隐藏好友图标 */
        .hidden-friend-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: var(--accent-primary);
            cursor: help;
            opacity: 0.8;
            transition: opacity 0.2s;
        }
        .hidden-friend-icon:hover {
            opacity: 1;
        }
        .hidden-friend-icon svg {
            display: block;
        }

        /* 徽章行 - 信任等级和隐藏好友徽章 */
        .detail-badges-row {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
            margin-bottom: 10px;
        }
        .detail-badges-row:empty {
            display: none;
        }
        .detail-badges-row .trust-level-badge,
        .detail-badges-row .hidden-friend-badge {
            margin-left: 0;
        }

        /* 节点详情增强 - 区块分隔线 */
        .detail-divider {
            height: 1px;
            background: var(--border-color);
            margin: 16px 0;
        }

        /* 节点详情增强 - 关系指标区块 */
        .detail-metrics {
            margin-top: 16px;
        }

        .detail-metrics-title {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .detail-metrics-title svg {
            stroke: var(--accent-primary);
        }

        .metric-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 6px;
        }

        .metric-row:last-child {
            margin-bottom: 0;
        }

        .metric-label {
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .metric-label-icon {
            font-size: 14px;
        }

        .metric-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 14px;
            font-weight: 600;
            color: var(--accent-primary);
        }

        .metric-rank {
            font-size: 11px;
            color: var(--text-muted);
            margin-left: 6px;
            font-weight: 400;
            font-family: 'Noto Sans SC', sans-serif;
        }

        /* 节点详情增强 - 原始数据区块 */
        .detail-raw-data {
            margin-top: 16px;
        }

        .raw-data-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .raw-data-item {
            padding: 10px 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .raw-data-item.full-width {
            grid-column: 1 / -1;
        }

        .raw-data-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 16px;
            color: var(--accent-primary);
            margin-bottom: 2px;
        }

        .raw-data-label {
            font-size: 11px;
            color: var(--text-muted);
        }

        .raw-data-sub {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        /* 节点详情增强 - 得分明细折叠面板 */
        .detail-score-breakdown {
            margin-top: 16px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            transition: border-color 0.2s ease;
        }

        .detail-score-breakdown:has(.score-breakdown-toggle.expanded) {
            border-color: var(--accent-primary);
        }

        .score-breakdown-toggle {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-secondary);
            border: none;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: color 0.2s ease;
        }

        .score-breakdown-toggle:hover {
            color: var(--text-primary);
        }

        .score-breakdown-toggle svg {
            transition: transform 0.2s ease;
        }

        .score-breakdown-toggle.expanded svg {
            transform: rotate(180deg);
        }

        /* CSS Grid 高度过渡动画 */
        .score-breakdown-content-wrapper {
            display: grid;
            grid-template-rows: 0fr;
            transition: grid-template-rows 0.25s ease-out;
        }

        .score-breakdown-content-wrapper.expanded {
            grid-template-rows: 1fr;
        }

        .score-breakdown-content {
            overflow: hidden;
            background: var(--bg-secondary);
        }

        .score-breakdown-content-inner {
            padding: 12px;
        }

        .score-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 0;
            font-size: 11px;
        }

        .score-item:not(:last-child) {
            border-bottom: 1px solid var(--border-color);
        }

        .score-item-label {
            color: var(--text-muted);
        }

        .score-item-value {
            font-family: 'Orbitron', sans-serif;
            color: var(--text-secondary);
        }

        .score-item-bar {
            flex: 1;
            height: 4px;
            background: var(--bg-card);
            border-radius: 2px;
            margin: 0 10px;
            overflow: hidden;
        }

        .score-item-bar-fill {
            height: 100%;
            background: var(--accent-primary);
            border-radius: 2px;
            transition: width 0.3s ease;
        }

        /* 节点详情增强 - 无数据提示 */
        .no-data-hint {
            text-align: center;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 8px;
            color: var(--text-muted);
            font-size: 12px;
        }

        .no-data-hint svg {
            display: block;
            margin: 0 auto 8px;
            opacity: 0.5;
        }

        /* 图形区域 */
        .graph-area {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        #graph {
            width: 100%;
            height: 100%;
            background: transparent;
        }

        .node {
            cursor: pointer;
            transition: filter 0.2s ease;
        }

        .node:hover {
            filter: brightness(1.3);
        }

        .link {
            stroke-opacity: 0.4;
            transition: stroke-opacity 0.2s ease;
        }

        /* 大规模数据时禁用边的 CSS 过渡以提升性能 */
        .graph-container.large-dataset .link {
            transition: none;
        }

        .link.highlighted {
            stroke-opacity: 1;
            stroke-width: 2px;
        }

        .link.dimmed {
            stroke-opacity: 0.1;
        }

        .node-label {
            font-family: 'Noto Sans SC', sans-serif;
            font-size: 11px;
            fill: var(--text-primary);
            pointer-events: none;
            text-shadow: 0 0 8px rgba(0, 0, 0, 0.8);
        }

        /* 工具提示 */
        .tooltip {
            position: fixed;
            padding: 12px 16px;
            background: linear-gradient(
                135deg,
                rgba(27, 30, 38, 0.92) 0%,
                rgba(22, 20, 28, 0.95) 100%
            );
            border: 1px solid rgba(234, 40, 100, 0.3);
            border-radius: 12px;
            font-size: 13px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
            z-index: 1000;
            max-width: 250px;
            backdrop-filter: blur(16px) saturate(180%);
            -webkit-backdrop-filter: blur(16px) saturate(180%);
            box-shadow:
                0 8px 32px rgba(0, 0, 0, 0.4),
                0 0 20px rgba(234, 40, 100, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.08);
        }

        /* Tooltip 顶部高光 */
        .tooltip::before {
            content: '';
            position: absolute;
            top: 0;
            left: 10%;
            right: 10%;
            height: 1px;
            background: linear-gradient(
                90deg,
                transparent 0%,
                rgba(255, 77, 127, 0.5) 50%,
                transparent 100%
            );
            border-radius: 12px 12px 0 0;
        }

        .tooltip.visible {
            opacity: 1;
        }

        .tooltip-name {
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 4px;
        }

        .tooltip-info {
            font-size: 11px;
            color: var(--text-secondary);
        }

        /* 图例 */
        .legend {
            position: absolute;
            bottom: 24px;
            left: 24px;
            background: linear-gradient(
                135deg,
                rgba(27, 30, 38, 0.88) 0%,
                rgba(22, 20, 28, 0.92) 100%
            );
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 14px;
            padding: 16px;
            backdrop-filter: blur(16px) saturate(180%);
            -webkit-backdrop-filter: blur(16px) saturate(180%);
            display: none;
            box-shadow:
                0 8px 32px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.08);
        }

        .legend-title {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .legend-item:last-child {
            margin-bottom: 0;
        }

        .legend-circle {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }


        .legend-label {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* 渐变图例样式 */
        .legend-gradient-container {
            width: 100%;
            min-width: 120px;
        }

        .legend-gradient-bar {
            height: 12px;
            border-radius: 6px;
            box-shadow: 0 0 10px rgba(100, 255, 218, 0.3);
        }

        .legend-gradient-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 6px;
            font-size: 10px;
            color: var(--text-muted);
        }

        /* 缩放控制 */
        .zoom-controls {
            position: absolute;
            bottom: 24px;
            right: 24px;
            display: none;
            flex-direction: column;
            gap: 8px;
        }

        .zoom-btn {
            width: 44px;
            height: 44px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            background: linear-gradient(
                135deg,
                rgba(27, 30, 38, 0.88) 0%,
                rgba(22, 20, 28, 0.92) 100%
            );
            color: var(--text-secondary);
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            backdrop-filter: blur(16px) saturate(180%);
            -webkit-backdrop-filter: blur(16px) saturate(180%);
            display: flex;
            align-items: center;
            box-shadow:
                0 4px 16px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.08);
            justify-content: center;
        }

        .zoom-btn:hover {
            background: var(--bg-hover);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        /* 着色模式工具栏 */
        .color-mode-toolbar {
            position: absolute;
            top: 24px;
            left: 24px;
            display: none;
            background: linear-gradient(
                135deg,
                rgba(27, 30, 38, 0.88) 0%,
                rgba(22, 20, 28, 0.92) 100%
            );
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 14px;
            padding: 8px;
            backdrop-filter: blur(16px) saturate(180%);
            -webkit-backdrop-filter: blur(16px) saturate(180%);
            z-index: 100;
            box-shadow:
                0 8px 32px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.08);
        }

        .color-mode-toolbar.visible {
            display: block;
        }

        .color-mode-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 6px;
        }

        .color-mode-header:hover {
            background: var(--bg-hover);
        }

        .color-mode-header svg {
            stroke: var(--accent-primary);
            transition: transform 0.2s ease;
        }

        .color-mode-header span {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            flex: 1;
        }

        .color-mode-toggle-icon {
            stroke: var(--text-muted);
            transition: transform 0.2s ease;
        }

        .color-mode-toolbar.collapsed .color-mode-toggle-icon {
            transform: rotate(180deg);
        }

        .color-mode-toolbar.collapsed .color-mode-options {
            display: none;
        }

        .color-mode-toolbar:not(.collapsed) .color-mode-header {
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-radius: 6px 6px 0 0;
        }

        .color-mode-options {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .color-mode-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s ease;
            text-align: left;
            width: 100%;
        }

        .color-mode-btn:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .color-mode-btn.active {
            background: rgba(234, 40, 100, 0.15);
            color: var(--accent-primary);
        }

        .color-mode-btn svg {
            flex-shrink: 0;
        }

        .color-mode-preview {
            display: flex;
            gap: 2px;
            margin-left: auto;
        }

        .color-mode-preview-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .preview-connections .color-mode-preview-dot:nth-child(1) { background: #5e6575; }
        .preview-connections .color-mode-preview-dot:nth-child(2) { background: #8f7585; }
        .preview-connections .color-mode-preview-dot:nth-child(3) { background: #c75a80; }
        .preview-connections .color-mode-preview-dot:nth-child(4) { background: #ea2864; }

        .preview-trust .color-mode-preview-dot:nth-child(1) { background: #cccccc; }
        .preview-trust .color-mode-preview-dot:nth-child(2) { background: #1778ff; }
        .preview-trust .color-mode-preview-dot:nth-child(3) { background: #2bcf5c; }
        .preview-trust .color-mode-preview-dot:nth-child(4) { background: #8143e6; }

        .preview-strength .color-mode-preview-dot:nth-child(1) { background: #4a4a5c; }
        .preview-strength .color-mode-preview-dot:nth-child(2) { background: #7b4b8c; }
        .preview-strength .color-mode-preview-dot:nth-child(3) { background: #b84a7c; }
        .preview-strength .color-mode-preview-dot:nth-child(4) { background: #e84393; }

        .preview-playtime .color-mode-preview-dot:nth-child(1) { background: #2d4a5a; }
        .preview-playtime .color-mode-preview-dot:nth-child(2) { background: #3d7a8a; }
        .preview-playtime .color-mode-preview-dot:nth-child(3) { background: #4db6ac; }
        .preview-playtime .color-mode-preview-dot:nth-child(4) { background: #64ffda; }

        .preview-community .color-mode-preview-dot:nth-child(1) { background: #e74c3c; }
        .preview-community .color-mode-preview-dot:nth-child(2) { background: #3498db; }
        .preview-community .color-mode-preview-dot:nth-child(3) { background: #2ecc71; }
        .preview-community .color-mode-preview-dot:nth-child(4) { background: #f39c12; }

        /* Resolution 滑条 */
        .resolution-slider-container {
            display: none;
            padding: 8px 4px;
            border-top: 1px solid var(--border-color);
            margin-top: 8px;
        }

        .resolution-slider-container.visible {
            display: block;
        }

        .resolution-slider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .resolution-label {
            font-size: 11px;
            color: var(--text-muted);
        }

        .resolution-value {
            font-size: 11px;
            color: var(--accent-primary);
            font-family: 'Orbitron', monospace;
            min-width: 36px;
            text-align: right;
        }

        .resolution-slider {
            width: 100%;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--bg-secondary);
            border-radius: 2px;
            outline: none;
            cursor: pointer;
        }

        .resolution-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--accent-primary);
            cursor: pointer;
            box-shadow: 0 0 6px rgba(234, 40, 100, 0.5);
            transition: transform 0.15s ease;
        }

        .resolution-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .resolution-slider::-moz-range-thumb {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: var(--accent-primary);
            cursor: pointer;
            border: none;
            box-shadow: 0 0 6px rgba(234, 40, 100, 0.5);
        }

        .resolution-hints {
            display: flex;
            justify-content: space-between;
            margin-top: 4px;
            font-size: 9px;
            color: var(--text-muted);
            opacity: 0.6;
        }

        /* 导出按钮 */
        .export-csv-dropdown {
            position: relative;
            display: inline-block;
            margin-left: auto;
        }

        .export-csv-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: transparent;
            color: var(--text-muted);
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .export-csv-btn:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
            background: rgba(234, 40, 100, 0.1);
        }

        .export-csv-btn svg {
            stroke: currentColor;
        }

        .export-csv-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 4px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-5px);
            transition: all 0.2s ease;
            z-index: 1000;
            min-width: 180px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .export-csv-dropdown:hover .export-csv-menu {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .export-csv-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
            text-align: left;
        }

        .export-csv-option:hover {
            background: var(--bg-hover);
            color: var(--accent-primary);
        }

        .export-csv-option svg {
            stroke: currentColor;
            flex-shrink: 0;
        }

        .ranking-header-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        /* 数据完整性指示器 */
        .data-info-section {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-color);
            display: none;
        }

        .data-info-section.visible {
            display: block;
        }

        .data-info-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            position: relative;
        }

        .data-info-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            color: var(--text-secondary);
            font-size: 12px;
        }

        .data-info-header svg {
            stroke: var(--accent-primary);
        }

        .data-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .data-info-item {
            padding: 10px;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .data-info-item.full-width {
            grid-column: 1 / -1;
        }

        .data-info-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 14px;
            color: var(--accent-primary);
            margin-bottom: 2px;
        }

        .data-info-label {
            font-size: 10px;
            color: var(--text-muted);
        }

        .data-info-note {
            margin-top: 12px;
            padding: 10px;
            background: rgba(234, 40, 100, 0.08);
            border-left: 2px solid var(--accent-primary);
            border-radius: 0 6px 6px 0;
            font-size: 11px;
            color: var(--text-muted);
            line-height: 1.5;
        }

        .data-info-toggle {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 20px;
            height: 20px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .data-info-toggle:hover {
            opacity: 1;
        }

        .data-info-toggle svg {
            transition: transform 0.2s;
        }

        .data-info-card.collapsed .data-info-toggle svg {
            transform: rotate(180deg);
        }

        .data-info-card.collapsed .data-info-grid,
        .data-info-card.collapsed .data-info-note {
            display: none;
        }

        /* 加载动画 */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            font-family: 'Orbitron', sans-serif;
            color: var(--text-secondary);
            letter-spacing: 2px;
        }

        /* 欢迎界面 */
        .welcome-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: radial-gradient(ellipse at center, rgba(234, 40, 100, 0.04) 0%, transparent 70%);
            z-index: 100;
        }

        .welcome-content {
            text-align: center;
            padding: 60px;
            background: linear-gradient(
                135deg,
                rgba(22, 20, 28, 0.85) 0%,
                rgba(27, 30, 38, 0.9) 50%,
                rgba(22, 20, 28, 0.85) 100%
            );
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            backdrop-filter: blur(24px) saturate(180%);
            -webkit-backdrop-filter: blur(24px) saturate(180%);
            max-width: 500px;
            box-shadow:
                0 24px 80px rgba(0, 0, 0, 0.5),
                0 8px 32px rgba(234, 40, 100, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.1),
                inset 0 -1px 0 rgba(0, 0, 0, 0.2);
            position: relative;
        }

        /* 欢迎卡片顶部高光 */
        .welcome-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 20%;
            right: 20%;
            height: 1px;
            background: linear-gradient(
                90deg,
                transparent 0%,
                rgba(255, 77, 127, 0.5) 30%,
                rgba(255, 255, 255, 0.3) 50%,
                rgba(255, 77, 127, 0.5) 70%,
                transparent 100%
            );
            border-radius: 24px 24px 0 0;
        }

        .welcome-icon {
            margin-bottom: 24px;
            color: var(--accent-primary);
            animation: networkPulse 3s ease-in-out infinite;
        }

        @keyframes networkPulse {

            0%,
            100% {
                opacity: 0.7;
                transform: scale(1);
            }

            50% {
                opacity: 1;
                transform: scale(1.08);
            }
        }

        .welcome-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 26px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-light));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 16px;
        }

        .welcome-desc {
            color: var(--text-secondary);
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 32px;
        }

        .welcome-btn-group {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .welcome-btn {
            padding: 14px 24px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-dark));
            border: none;
            border-radius: 12px;
            color: #fff;
            font-size: 14px;
            font-weight: 700;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 20px rgba(234, 40, 100, 0.3);
        }

        .welcome-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(234, 40, 100, 0.5);
        }

        .welcome-btn svg {
            stroke: #fff;
        }

        .welcome-btn-db {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            box-shadow: none;
        }

        .welcome-btn-db svg {
            stroke: var(--text-secondary);
        }

        .welcome-btn-db:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
            box-shadow: var(--glow-soft);
        }

        .welcome-btn-db:hover svg {
            stroke: var(--accent-primary);
        }

        .welcome-hint {
            margin-top: 16px;
            font-size: 12px;
            color: var(--text-muted);
        }

        .welcome-note {
            margin-top: 24px;
            padding: 16px;
            background: rgba(234, 40, 100, 0.08);
            border: 1px solid rgba(234, 40, 100, 0.2);
            border-radius: 10px;
            text-align: left;
        }

        .welcome-note-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            font-weight: 600;
            color: var(--accent-primary);
            margin-bottom: 10px;
        }

        .welcome-note-title svg {
            stroke: var(--accent-primary);
            flex-shrink: 0;
        }

        .welcome-note-list {
            margin: 0;
            padding-left: 20px;
            font-size: 11px;
            color: var(--text-secondary);
            line-height: 1.8;
        }

        .welcome-note-list strong {
            color: var(--accent-primary);
        }

        .welcome-note-local {
            margin-top: 10px;
            font-size: 10px;
            color: var(--text-muted);
            font-style: italic;
        }

        .welcome-note-path {
            margin-top: 12px;
            padding-top: 10px;
            border-top: 1px dashed rgba(234, 40, 100, 0.2);
            font-size: 10px;
            color: var(--text-muted);
        }

        .welcome-note-path code {
            display: block;
            margin-top: 4px;
            padding: 6px 10px;
            background: var(--bg-primary);
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 10px;
            color: var(--text-secondary);
            word-break: break-all;
        }

        /* 响应式 */
        @media (max-width: 1200px) {
            .sidebar {
                width: 320px;
            }
        }

        /* 浮动菜单按钮（带动画效果：三条横杠 ↔ X） */
        .menu-toggle {
            display: none;
            position: fixed;
            z-index: 250;
            width: var(--menu-btn-size);
            height: var(--menu-btn-size);
            border: none;
            background: transparent;
            cursor: pointer;
            padding: 0;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            transition: color 0.2s ease;
        }

        .menu-toggle svg {
            width: var(--menu-icon-size);
            height: var(--menu-icon-size);
            stroke: currentColor;
            stroke-width: 2.4;
            fill: none;
        }

        .menu-toggle-line {
            stroke-linecap: round;
            stroke-linejoin: round;
            transform-origin: 12px 12px;
            transition: transform 0.25s ease, opacity 0.2s ease;
        }

        .line-top {
            transform: translateY(-5px);
        }

        .line-middle {
            transform: translateY(0);
        }

        .line-bottom {
            transform: translateY(5px);
        }

        .menu-toggle:hover {
            color: var(--accent-primary);
        }

        /* 打开状态 - 变成 X */
        .menu-toggle.active .line-top {
            transform: translateY(0) rotate(45deg);
        }

        .menu-toggle.active .line-middle {
            opacity: 0;
            transform: translateX(-8px);
        }

        .menu-toggle.active .line-bottom {
            transform: translateY(0) rotate(-45deg);
        }

        /* 侧边栏遮罩层 */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 140;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .sidebar-overlay.visible {
            display: block;
            opacity: 1;
        }

        @media (max-width: 900px) {

            html,
            body {
                overflow: hidden;
                height: 100%;
            }

            .container {
                flex-direction: column;
                height: 100vh;
                z-index: auto;
            }

            /* 移动端 logo-section - 保持原有高度 */
            .logo-section {
                padding: 20px 52px;
            }

            /* 显示菜单按钮 - 使用变量让图标与 logo 区块垂直居中 */
            .menu-toggle {
                display: flex;
                top: var(--mobile-header-icon-top);
                left: calc((var(--mobile-logo-padding-h) - var(--menu-btn-size)) / 2);
            }

            /* 移动端语言选择器 - 固定定位，同样对齐 */
            .lang-selector {
                position: fixed;
                top: var(--mobile-header-icon-top);
                right: 16px;
                z-index: 250;
            }

            /* 侧边栏抽屉式 - 需要脱离 container 的层叠上下文 */
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                width: 85%;
                max-width: 320px;
                height: 100vh;
                max-height: 100vh;
                z-index: 200;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                border-right: 1px solid var(--border-color);
                background: linear-gradient(180deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
                overflow-y: auto;
                overflow-x: hidden;
            }

            .sidebar.visible {
                transform: translateX(0);
            }

            /* 图表区域全屏 */
            .graph-area {
                width: 100%;
                height: 100vh;
                flex: 1;
            }

            /* 欢迎界面调整 */
            .welcome-content {
                max-width: 90%;
                padding: 24px 20px;
                margin: 16px;
            }

            .welcome-icon svg {
                width: 60px;
                height: 60px;
            }

            .welcome-title {
                font-size: 20px;
            }

            .welcome-desc {
                font-size: 12px;
                margin-bottom: 20px;
            }

            .welcome-btn-group {
                flex-direction: column;
                gap: 10px;
            }

            .welcome-btn {
                width: 100%;
                justify-content: center;
                padding: 14px 20px;
            }

            .welcome-tip {
                font-size: 11px;
            }

            .vrcx-tip {
                padding: 12px;
            }

            .vrcx-tip-title {
                font-size: 11px;
            }

            .vrcx-tip ol {
                font-size: 10px;
            }

            /* 图例和控制按钮调整 */
            .legend {
                top: auto;
                bottom: 70px;
                left: 12px;
                right: auto;
                padding: 10px;
            }

            .legend-title {
                font-size: 10px;
            }

            .legend-circle {
                width: 10px;
                height: 10px;
            }

            .legend-label {
                font-size: 10px;
            }

            .zoom-controls {
                bottom: 12px;
                right: 12px;
                gap: 6px;
            }

            .zoom-btn {
                width: 38px;
                height: 38px;
            }
        }

        /* 小屏手机 */
        @media (max-width: 480px) {
            :root {
                --mobile-header-icon-top: 26px;
                --mobile-logo-padding-h: 44px;
            }

            .sidebar {
                width: 100%;
                max-width: none;
            }

            .logo-section {
                padding: 16px 44px;
            }

            /* 更紧凑屏幕下：通过变量下调图标位置，保持与桌面语言按钮居中 */
            .menu-toggle {
                left: 12px;
            }

            .lang-selector {
                right: 12px;
            }

            .welcome-content {
                padding: 20px 16px;
            }

            .welcome-title {
                font-size: 18px;
            }
        }
    </style>
</head>

<body>
    <div class="bg-pattern"></div>
    <div class="grid-overlay"></div>

    <!-- 浮动菜单按钮 -->
    <button class="menu-toggle" id="menuToggle" title="Menu" aria-label="Menu">
        <svg viewBox="0 0 24 24">
            <line class="menu-toggle-line line-top" x1="5" y1="12" x2="19" y2="12"></line>
            <line class="menu-toggle-line line-middle" x1="5" y1="12" x2="19" y2="12"></line>
            <line class="menu-toggle-line line-bottom" x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
    </button>

    <!-- 侧边栏遮罩 -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <div class="container">
        <aside class="sidebar">
            <div class="logo-section">
                <div class="logo-content">
                    <div class="logo">NEXUS</div>
                    <div class="logo-subtitle" data-i18n="subtitle">共同好友网络分析</div>
                </div>
                <a href="https://github.com/Haor/vrc_nexus" target="_blank" rel="noopener noreferrer" class="github-link" title="GitHub">
                    <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
                    </svg>
                </a>
                <div class="lang-selector">
                    <button class="lang-btn" id="langBtn" title="Language / 语言 / 言語">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="2" y1="12" x2="22" y2="12"></line>
                            <path
                                d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z">
                            </path>
                        </svg>
                    </button>
                    <div class="lang-dropdown" id="langDropdown">
                        <div class="lang-option active" data-lang="zh">中文</div>
                        <div class="lang-option" data-lang="en">English</div>
                        <div class="lang-option" data-lang="ja">日本語</div>
                    </div>
                </div>
            </div>

            <div class="file-section">
                <input type="file" id="fileInput" accept=".gexf,.xml,text/xml,application/xml,application/octet-stream"
                    style="display: none;">
                <input type="file" id="dbFileInput"
                    accept=".sqlite3,.db,.sqlite,application/x-sqlite3,application/octet-stream" style="display: none;">
                <div class="file-btn-group">
                    <button class="file-btn" id="btnLoadFile">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                        </svg>
                        <span data-i18n="loadGexf">选择 GEXF</span>
                    </button>
                    <button class="file-btn file-btn-db" id="btnLoadDB">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <ellipse cx="12" cy="5" rx="9" ry="3"></ellipse>
                            <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path>
                            <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path>
                        </svg>
                        <span data-i18n="loadVrcx">选择 VRCX</span>
                    </button>
                </div>
                <div class="file-info">
                    <span class="file-name" id="fileName" data-i18n="selectFile">请选择文件</span>
                    <button class="export-btn" id="btnExportGexf" style="display: none;" title="导出为 GEXF 文件">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="search-section">
                <div class="search-wrapper">
                    <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="M21 21l-4.35-4.35"></path>
                    </svg>
                    <input type="text" class="search-input" id="searchInput" placeholder="搜索好友..."
                        data-i18n-placeholder="search">
                </div>
            </div>

            <div class="stats-section">
                <div class="stats-title" data-i18n="networkStats">网络统计</div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="nodeCount">--</div>
                        <div class="stat-label" data-i18n="totalFriends">好友总数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="edgeCount">--</div>
                        <div class="stat-label" data-i18n="totalConnections">连接总数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avgDegree">--</div>
                        <div class="stat-label" data-i18n="avgConnections">平均连接</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="density">--</div>
                        <div class="stat-label" data-i18n="networkDensity">网络密度</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="clusteringCoef">--</div>
                        <div class="stat-label" data-i18n="avgClustering">聚类系数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="communityCount">--</div>
                        <div class="stat-label" data-i18n="communityCount">社区数量</div>
                    </div>
                </div>
            </div>

            <!-- 数据完整性指示器 -->
            <div class="data-info-section" id="dataInfoSection">
                <div class="data-info-card">
                    <button class="data-info-toggle" id="dataInfoToggle">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="18 15 12 9 6 15"></polyline>
                        </svg>
                    </button>
                    <div class="data-info-header">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="16" x2="12" y2="12"></line>
                            <line x1="12" y1="8" x2="12.01" y2="8"></line>
                        </svg>
                        <span data-i18n="dataInfo">数据信息</span>
                    </div>
                    <div class="data-info-grid">
                        <div class="data-info-item">
                            <div class="data-info-value" id="dataInfoRange">--</div>
                            <div class="data-info-label" data-i18n="dataRange">数据范围</div>
                        </div>
                        <div class="data-info-item">
                            <div class="data-info-value" id="dataInfoDays">--</div>
                            <div class="data-info-label" data-i18n="totalDays">覆盖天数</div>
                        </div>
                        <div class="data-info-item">
                            <div class="data-info-value" id="dataInfoActivity">--</div>
                            <div class="data-info-label" data-i18n="activityRate">活跃度</div>
                        </div>
                        <div class="data-info-item">
                            <div class="data-info-value" id="dataInfoHalflife">--</div>
                            <div class="data-info-label" data-i18n="halflife">半衰期</div>
                        </div>
                    </div>
                    <div class="data-info-note" id="dataInfoNote">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <path d="M12 16v-4"></path>
                            <path d="M12 8h.01"></path>
                        </svg>
                        <span data-i18n="dataInfoDesc">关系指标基于VRCX记录计算，数据完整性取决于记录时长</span>
                    </div>
                </div>
            </div>

            <div class="controls-section">
                <div class="control-group">
                    <div class="control-label">
                        <span data-i18n="repulsion">斥力强度</span>
                        <span class="control-value" id="forceValue">-300</span>
                    </div>
                    <input type="range" class="slider" id="forceSlider" min="-800" max="-50" value="-300">
                </div>
                <div class="control-group">
                    <div class="control-label">
                        <span data-i18n="linkStrength">连接强度</span>
                        <span class="control-value" id="distanceValue">80</span>
                    </div>
                    <input type="range" class="slider" id="distanceSlider" min="30" max="200" value="80">
                </div>
                <div class="btn-group">
                    <button class="btn active" id="btnShowLabels">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M4 7V4h16v3"></path>
                            <path d="M9 20h6"></path>
                            <path d="M12 4v16"></path>
                        </svg>
                        <span data-i18n="showLabels">显示标签</span>
                    </button>
                    <button class="btn" id="btnReset">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path>
                            <path d="M3 3v5h5"></path>
                        </svg>
                        <span data-i18n="resetView">重置视图</span>
                    </button>
                    <button class="btn" id="btnFreeze">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <rect x="6" y="4" width="4" height="16"></rect>
                            <rect x="14" y="4" width="4" height="16"></rect>
                        </svg>
                        <span data-i18n="freezeLayout">冻结</span>
                    </button>
                </div>
            </div>

            <div class="detail-section" id="detailSection">
                <div class="detail-placeholder">
                    <div class="detail-placeholder-icon">🔍</div>
                    <p data-i18n="clickToView">点击节点查看详细信息</p>
                </div>
            </div>
        </aside>

        <main class="graph-area">
            <div class="loading" id="loading" style="display: none;">
                <div class="loading-spinner"></div>
                <div class="loading-text" data-i18n="loading">正在加载网络数据...</div>
            </div>

            <div class="welcome-screen" id="welcomeScreen">
                <div class="welcome-content">
                    <div class="welcome-icon">
                        <svg width="90" height="90" viewBox="0 0 100 100" fill="none">
                            <!-- 连接线 -->
                            <line x1="50" y1="25" x2="25" y2="50" stroke="currentColor" stroke-width="2"
                                opacity="0.6" />
                            <line x1="50" y1="25" x2="75" y2="50" stroke="currentColor" stroke-width="2"
                                opacity="0.6" />
                            <line x1="25" y1="50" x2="50" y2="75" stroke="currentColor" stroke-width="2"
                                opacity="0.6" />
                            <line x1="75" y1="50" x2="50" y2="75" stroke="currentColor" stroke-width="2"
                                opacity="0.6" />
                            <line x1="25" y1="50" x2="75" y2="50" stroke="currentColor" stroke-width="1.5"
                                opacity="0.4" />
                            <line x1="50" y1="25" x2="50" y2="75" stroke="currentColor" stroke-width="1.5"
                                opacity="0.4" />
                            <!-- 节点 - 灰粉渐变配色 -->
                            <circle cx="50" cy="25" r="10" fill="#c75a80" opacity="0.9" />
                            <circle cx="25" cy="50" r="8" fill="#5e6575" opacity="0.9" />
                            <circle cx="75" cy="50" r="8" fill="#8f7585" opacity="0.9" />
                            <circle cx="50" cy="75" r="12" fill="#ea2864" />
                            <circle cx="50" cy="50" r="6" fill="#c75a80" opacity="0.85" />
                            <!-- 外圈光晕 -->
                            <circle cx="50" cy="75" r="16" stroke="#ea2864" stroke-width="1" fill="none"
                                opacity="0.3" />
                        </svg>
                    </div>
                    <h2 class="welcome-title" data-i18n="welcomeTitle">共同好友网络分析</h2>
                    <p class="welcome-desc" data-i18n="welcomeDesc">上传文件可视化分析你的社交网络</p>
                    <div class="welcome-btn-group">
                        <button class="welcome-btn" id="welcomeUploadBtn">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                            </svg>
                            <span data-i18n="loadGexf">选择 GEXF</span>
                        </button>
                        <button class="welcome-btn welcome-btn-db" id="welcomeUploadDBBtn">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <ellipse cx="12" cy="5" rx="9" ry="3"></ellipse>
                                <path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path>
                                <path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path>
                            </svg>
                            <span data-i18n="loadVrcx">选择 VRCX</span>
                        </button>
                    </div>
                    <div class="welcome-hint" data-i18n="fileHint">支持 .gexf 文件 或 VRCX.sqlite3 数据库</div>
                    <div class="welcome-note">
                        <div class="welcome-note-title">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="12" y1="16" x2="12" y2="12"></line>
                                <line x1="12" y1="8" x2="12.01" y2="8"></line>
                            </svg>
                            <span class="control-value" data-i18n="vrcxNote">使用 VRCX 数据库前</span>
                        </div>
                        <ol class="welcome-note-list" id="welcomeNoteList">
                            <li><span data-i18n="vrcxStep1">在设置中检查更新，确保使用</span> <strong class="control-value"
                                    data-i18n="vrcxMinVersion">Stable 2025.12.06+</strong> <span
                                    data-i18n="vrcxVersion">或更新版本（旧版数据库结构不兼容）</span>
                            </li>
                            <li><span data-i18n="vrcxStep2">打开 VRCX「图表」，在 Mutual Friend Network 下执行</span> <strong
                                    class="control-value" data-i18n="vrcxFetch">Start Fetch</strong>
                            </li>
                            <li data-i18n="vrcxStep3">解析完成后可下载 GEXF 文件</li>
                        </ol>
                        <div class="welcome-note-local" data-i18n="vrcxLocal">* 数据库解析在本地浏览器中进行，不会上传至服务器</div>
                        <div class="welcome-note-path">
                            <span data-i18n="vrcxPathLabel">Windows 默认路径：</span>
                            <code>%APPDATA%\VRCX\VRCX.sqlite3</code>
                        </div>
                    </div>
                </div>
            </div>

            <svg id="graph"></svg>

            <div class="legend">

                <div class="legend-item">
                    <div class="legend-circle"
                        style="background: #5e6575; box-shadow: 0 0 10px rgba(94, 101, 117, 0.4);"></div>
                    <span class="legend-label" data-i18n="legendLow">少量连接</span>
                </div>
                <div class="legend-item">
                    <div class="legend-circle"
                        style="background: #8f7585; box-shadow: 0 0 10px rgba(143, 117, 133, 0.45);"></div>
                    <span class="legend-label" data-i18n="legendMid">一般连接</span>
                </div>
                <div class="legend-item">
                    <div class="legend-circle"
                        style="background: #c75a80; box-shadow: 0 0 10px rgba(199, 90, 128, 0.5);"></div>
                    <span class="legend-label" data-i18n="legendHigh">较多连接</span>
                </div>
                <div class="legend-item">
                    <div class="legend-circle"
                        style="background: #ea2864; box-shadow: 0 0 10px rgba(234, 40, 100, 0.6);"></div>
                    <span class="legend-label" data-i18n="legendTop">社交中心</span>
                </div>
            </div>

            <!-- 着色模式工具栏 -->
            <div class="color-mode-toolbar" id="colorModeToolbar">
                <div class="color-mode-header" id="colorModeHeader">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <circle cx="12" cy="12" r="6"></circle>
                        <circle cx="12" cy="12" r="2"></circle>
                    </svg>
                    <span data-i18n="colorMode">着色模式</span>
                    <svg class="color-mode-toggle-icon" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="18 15 12 9 6 15"></polyline>
                    </svg>
                </div>
                <div class="color-mode-options">
                    <button class="color-mode-btn active preview-connections" data-mode="connections">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                        <span data-i18n="colorByConnections">共同好友数</span>
                        <div class="color-mode-preview">
                            <div class="color-mode-preview-dot"></div>
                            <div class="color-mode-preview-dot"></div>
                            <div class="color-mode-preview-dot"></div>
                            <div class="color-mode-preview-dot"></div>
                        </div>
                    </button>
                    <button class="color-mode-btn preview-trust" data-mode="trust">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                        </svg>
                        <span data-i18n="colorByTrust">信任等级</span>
                        <div class="color-mode-preview">
                            <div class="color-mode-preview-dot"></div>
                            <div class="color-mode-preview-dot"></div>
                            <div class="color-mode-preview-dot"></div>
                            <div class="color-mode-preview-dot"></div>
                        </div>
                    </button>
                    <button class="color-mode-btn preview-strength" data-mode="strength">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                            <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                        </svg>
                        <span data-i18n="colorByStrength">关系强度</span>
                        <div class="color-mode-preview">
                            <div class="color-mode-preview-dot"></div>
                            <div class="color-mode-preview-dot"></div>
                            <div class="color-mode-preview-dot"></div>
                            <div class="color-mode-preview-dot"></div>
                        </div>
                    </button>
                    <button class="color-mode-btn preview-playtime" data-mode="playtime">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                        <span data-i18n="colorByPlaytime">游玩时长</span>
                        <div class="color-mode-preview">
                            <div class="color-mode-preview-dot"></div>
                            <div class="color-mode-preview-dot"></div>
                            <div class="color-mode-preview-dot"></div>
                            <div class="color-mode-preview-dot"></div>
                        </div>
                    </button>
                    <button class="color-mode-btn preview-community" data-mode="community">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="5" r="3"></circle>
                            <circle cx="5" cy="19" r="3"></circle>
                            <circle cx="19" cy="19" r="3"></circle>
                            <line x1="12" y1="8" x2="5" y2="16"></line>
                            <line x1="12" y1="8" x2="19" y2="16"></line>
                        </svg>
                        <span data-i18n="colorByCommunity">社区</span>
                        <div class="color-mode-preview">
                            <div class="color-mode-preview-dot"></div>
                            <div class="color-mode-preview-dot"></div>
                            <div class="color-mode-preview-dot"></div>
                            <div class="color-mode-preview-dot"></div>
                        </div>
                    </button>
                </div>
                <div class="resolution-slider-container" id="resolutionSliderContainer">
                    <div class="resolution-slider-header">
                        <span class="resolution-label" data-i18n="communityResolution">社区粒度</span>
                        <span class="resolution-value" id="resolutionValue">自动</span>
                    </div>
                    <input type="range" class="resolution-slider" id="resolutionSlider" min="0" max="40" value="0" step="1">
                    <div class="resolution-hints">
                        <span data-i18n="resolutionAuto">自动</span>
                        <span data-i18n="resolutionFine">精细</span>
                    </div>
                </div>
            </div>

            <div class="zoom-controls">
                <button class="zoom-btn" id="zoomIn">+</button>
                <button class="zoom-btn" id="zoomOut">−</button>
                <button class="zoom-btn" id="zoomFit">⊡</button>
            </div>
        </main>
    </div>

    <div class="tooltip" id="tooltip">
        <div class="tooltip-name"></div>
        <div class="tooltip-info"></div>
    </div>

    <script>
        // 多语言支持
        const i18n = {
            zh: {
                subtitle: '共同好友网络分析',
                loadGexf: '选择 GEXF',
                loadVrcx: '选择 VRCX',
                selectFile: '请选择文件',
                currentFile: '当前',
                search: '搜索好友...',
                linkStrength: '连接强度',
                repulsion: '斥力强度',
                showLabels: '显示标签',
                resetView: '重置视图',
                freezeLayout: '冻结',
                networkStats: '网络统计',
                totalFriends: '好友总数',
                totalConnections: '连接总数',
                avgConnections: '平均连接',
                networkDensity: '网络密度',
                avgClustering: '聚类系数',
                communityCount: '社区数量',
                community: '社区',
                clusteringCoef: '聚类系数',
                nodeDetail: '节点详情',
                clickToView: '点击节点查看详细信息',
                mutualRanking: '共同好友排名',
                rank: '排名',
                total: '共',
                people: '人',
                mutualCount: '共同好友数',
                mutualList: '共同好友列表',
                loading: '正在加载网络数据...',
                initSql: '正在初始化 SQL.js...',
                readingDb: '正在读取数据库...',
                welcomeTitle: '共同好友网络分析',
                welcomeDesc: '上传文件可视化分析你的社交网络',
                fileHint: '支持 .gexf 文件 或 VRCX.sqlite3 数据库',
                vrcxNote: '使用 VRCX 数据库前',
                vrcxStep1: '在设置中检查更新，确保使用',
                vrcxMinVersion: 'Stable 2025.12.06+',
                vrcxVersion: '或更新版本（旧版数据库结构不兼容）',
                vrcxStep2: '打开 VRCX「图表」，在 Mutual Friend Network 下执行',
                vrcxFetch: 'Start Fetch',
                vrcxStep3: '解析完成后可下载 GEXF 文件',
                vrcxLocal: '* 数据库解析在本地浏览器中进行，不会上传至服务器',
                vrcxPathLabel: 'Windows 默认路径：',

                legendLow: '少量连接',
                legendMid: '一般连接',
                legendHigh: '较多连接',
                legendTop: '社交中心',
                // 游玩时长图例
                legendPlaytimeLow: '短时游玩',
                legendPlaytimeMid: '中等时长',
                legendPlaytimeHigh: '长时游玩',
                legendPlaytimeTop: '深度陪伴',
                removeNode: '从图中移除此节点',
                rankingMutual: '共同好友',
                rankingStrength: '关系强度',
                rankingIntimacy: '近期亲密',
                rankingPlaytime: '游玩时长',
                rankingTitle: '排行榜',
                timeAll: '全部',
                time60d: '60天',
                time90d: '90天',
                time30d: '30天',
                time7d: '7天',
                timeDay: '天',
                dataHint: '数据来自VRCX记录，完整性取决于记录时长',
                closeDetail: '关闭详情',
                selectAccount: '选择账号',
                selectAccountDesc: '检测到多个账号数据，请选择要加载的账号：',
                friendCount: '位好友',
                // 节点详情增强
                trustLevel: '信任等级',
                relationMetrics: '关系指标',
                relationshipStrength: '关系强度',
                recentIntimacy: '近期亲密度',
                rawData: '原始数据',
                totalPlaytime: '总游玩时长',
                effectivePlaytime: '有效时长',
                retentionRate: '保留率',
                meetCount: '见面次数',
                recentPlaytime: '近期时长',
                lifeShare: '生命份额',
                scoreBreakdown: '得分明细',
                depthScore: '有效陪伴深度',
                qualityScore: '互动质量',
                stabilityScore: '稳定性',
                bondScore: '社交羁绊',
                recentTimeScore: '近期陪伴',
                recentFreqScore: '近期频率',
                shareScore: '生命份额',
                noInteractionData: '暂无互动记录',
                hiddenFriend: '隐藏好友',
                hiddenFriendHint: '该好友可能隐藏了共同好友关系',
                hour: '小时',
                times: '次',
                // 着色模式
                colorMode: '着色模式',
                colorByConnections: '共同好友数',
                colorByTrust: '信任等级',
                colorByStrength: '关系强度',
                colorByPlaytime: '游玩时长',
                colorByCommunity: '社区',
                communityResolution: '社区粒度',
                resolutionAuto: '自动',
                resolutionFine: '精细',
                // 导出功能
                exportCSV: '导出',
                exportStrength: '关系强度排名',
                exportIntimacy: '近期亲密度排名',
                exportFull: '完整数据',
                // 数据信息
                dataInfo: '数据信息',
                dataRange: '数据范围',
                totalDays: '覆盖天数',
                activityRate: '活跃度',
                halflife: '半衰期',
                day: '天',
                dataInfoDesc: '关系指标基于VRCX记录计算，数据完整性取决于记录时长'
            },
            en: {
                subtitle: 'Mutual Friends Network',
                loadGexf: 'Load GEXF',
                loadVrcx: 'Load VRCX',
                selectFile: 'Select a file',
                currentFile: 'Current',
                search: 'Search friends...',
                linkStrength: 'Link Strength',
                repulsion: 'Repulsion',
                showLabels: 'Show Labels',
                resetView: 'Reset View',
                freezeLayout: 'Freeze',
                networkStats: 'Network Stats',
                totalFriends: 'Total Friends',
                totalConnections: 'Connections',
                avgConnections: 'Avg Connections',
                networkDensity: 'Density',
                avgClustering: 'Clustering',
                communityCount: 'Communities',
                community: 'Community',
                clusteringCoef: 'Clustering',
                nodeDetail: 'Node Details',
                clickToView: 'Click a node to view details',
                mutualRanking: 'Mutual Friends Ranking',
                rank: 'Rank',
                total: 'of',
                people: 'total',
                mutualCount: 'Mutual Friends',
                mutualList: 'Friend List',
                loading: 'Loading network data...',
                initSql: 'Initializing SQL.js...',
                readingDb: 'Reading database...',
                welcomeTitle: 'Mutual Friends Network',
                welcomeDesc: 'Upload a file to visualize your social network',
                fileHint: 'Supports .gexf files or VRCX.sqlite3 database',
                vrcxNote: 'Before using VRCX database',
                vrcxStep1: 'Check for updates and ensure using',
                vrcxMinVersion: 'Stable 2025.12.06+',
                vrcxVersion: 'or newer (older versions are incompatible)',
                vrcxStep2: 'Open VRCX "Chart", under Mutual Friend Network execute',
                vrcxFetch: 'Start Fetch',
                vrcxStep3: 'Download GEXF file after parsing',
                vrcxLocal: '* Parsing is done locally in your browser, data is never uploaded',
                vrcxPathLabel: 'Windows default path:',

                legendLow: 'Few',
                legendMid: 'Average',
                legendHigh: 'Many',
                legendTop: 'Hub',
                // Playtime legend
                legendPlaytimeLow: 'Brief',
                legendPlaytimeMid: 'Moderate',
                legendPlaytimeHigh: 'Extended',
                legendPlaytimeTop: 'Core',
                removeNode: 'Remove this node',
                rankingMutual: 'Mutual',
                rankingStrength: 'Strength',
                rankingIntimacy: 'Intimacy',
                rankingPlaytime: 'Playtime',
                rankingTitle: 'Ranking',
                timeAll: 'All',
                time60d: '60d',
                time90d: '90d',
                time30d: '30d',
                time7d: '7d',
                timeDay: 'd',
                dataHint: 'Data from VRCX logs, completeness depends on recording duration',
                closeDetail: 'Close',
                selectAccount: 'Select Account',
                selectAccountDesc: 'Multiple accounts detected. Please select which account to load:',
                friendCount: 'friends',
                // Node detail enhancement
                trustLevel: 'Trust Level',
                relationMetrics: 'Relationship Metrics',
                relationshipStrength: 'Relationship Strength',
                recentIntimacy: 'Recent Intimacy',
                rawData: 'Raw Data',
                totalPlaytime: 'Total Playtime',
                effectivePlaytime: 'Effective Time',
                retentionRate: 'Retention',
                meetCount: 'Meetings',
                recentPlaytime: 'Recent Time',
                lifeShare: 'Life Share',
                scoreBreakdown: 'Score Breakdown',
                depthScore: 'Effective Depth',
                qualityScore: 'Interaction Quality',
                stabilityScore: 'Stability',
                bondScore: 'Social Bond',
                recentTimeScore: 'Recent Companionship',
                recentFreqScore: 'Recent Frequency',
                shareScore: 'Life Share',
                noInteractionData: 'No interaction data',
                hiddenFriend: 'Hidden Friend',
                hiddenFriendHint: 'This friend may have hidden mutual friend relationships',
                hour: 'h',
                times: 'times',
                // Color mode
                colorMode: 'Color Mode',
                colorByConnections: 'Connections',
                colorByTrust: 'Trust Level',
                colorByStrength: 'Relationship',
                colorByPlaytime: 'Playtime',
                colorByCommunity: 'Community',
                communityResolution: 'Resolution',
                resolutionAuto: 'Auto',
                resolutionFine: 'Fine',
                // Export
                exportCSV: 'Export',
                exportStrength: 'Relationship Ranking',
                exportIntimacy: 'Intimacy Ranking',
                exportFull: 'Full Data',
                // Data info
                dataInfo: 'Data Info',
                dataRange: 'Date Range',
                totalDays: 'Total Days',
                activityRate: 'Activity',
                halflife: 'Half-life',
                day: 'd',
                dataInfoDesc: 'Metrics are calculated from VRCX logs. Completeness depends on recording duration.'
            },
            ja: {
                subtitle: '共通フレンドネットワーク',
                loadGexf: 'GEXF選択',
                loadVrcx: 'VRCX選択',
                selectFile: 'ファイルを選択',
                currentFile: '現在',
                search: 'フレンド検索...',
                linkStrength: 'リンク強度',
                repulsion: '反発力',
                showLabels: 'ラベル表示',
                resetView: 'リセット',
                freezeLayout: 'フリーズ',
                networkStats: 'ネットワーク統計',
                totalFriends: 'フレンド数',
                totalConnections: '接続数',
                avgConnections: '平均接続',
                networkDensity: 'ネットワーク密度',
                avgClustering: 'クラスタ係数',
                communityCount: 'コミュニティ数',
                community: 'コミュニティ',
                clusteringCoef: 'クラスタ係数',
                nodeDetail: 'ノード詳細',
                clickToView: 'ノードをクリックして詳細表示',
                mutualRanking: '共通フレンドランキング',
                rank: '順位',
                total: '全',
                people: '人中',
                mutualCount: '共通フレンド数',
                mutualList: 'フレンドリスト',
                loading: 'ネットワークデータを読み込み中...',
                initSql: 'SQL.jsを初期化中...',
                readingDb: 'データベースを読み込み中...',
                welcomeTitle: '共通フレンドネットワーク分析',
                welcomeDesc: 'ファイルをアップロードしてソーシャルネットワークを可視化',
                fileHint: '.gexf ファイル または VRCX.sqlite3 データベース対応',
                vrcxNote: 'VRCXデータベース使用前に',
                vrcxStep1: '設定で更新を確認し、',
                vrcxMinVersion: 'Stable 2025.12.06+',
                vrcxVersion: '以降を使用してください（旧形式は非対応）',
                vrcxStep2: 'VRCX「チャート」を開き、Mutual Friend Network で実行',
                vrcxFetch: 'Start Fetch',
                vrcxStep3: '解析後に GEXF ファイルをダウンロード',
                vrcxLocal: '* 解析はブラウザ内でローカルに行われ、サーバーにアップロードされません',
                vrcxPathLabel: 'Windows デフォルトパス：',

                legendLow: '少ない',
                legendMid: '普通',
                legendHigh: '多い',
                legendTop: 'ハブ',
                // プレイ時間凡例
                legendPlaytimeLow: '短時間',
                legendPlaytimeMid: '中程度',
                legendPlaytimeHigh: '長時間',
                legendPlaytimeTop: '深い絆',
                removeNode: 'このノードを削除',
                rankingMutual: '共通',
                rankingStrength: '関係強度',
                rankingIntimacy: '親密度',
                rankingPlaytime: 'プレイ時間',
                rankingTitle: 'ランキング',
                timeAll: '全期間',
                time60d: '60日',
                time90d: '90日',
                time30d: '30日',
                time7d: '7日',
                timeDay: '日',
                dataHint: 'VRCXログに基づくデータ、完全性は記録期間に依存',
                closeDetail: '閉じる',
                selectAccount: 'アカウント選択',
                selectAccountDesc: '複数のアカウントが検出されました。ロードするアカウントを選択してください：',
                friendCount: '人のフレンド',
                // ノード詳細強化
                trustLevel: '信頼レベル',
                relationMetrics: '関係指標',
                relationshipStrength: '関係強度',
                recentIntimacy: '最近の親密度',
                rawData: '元データ',
                totalPlaytime: '総プレイ時間',
                effectivePlaytime: '有効時間',
                retentionRate: '保持率',
                meetCount: '会った回数',
                recentPlaytime: '最近の時間',
                lifeShare: 'ライフシェア',
                scoreBreakdown: 'スコア内訳',
                depthScore: '有効陪伴深度',
                qualityScore: 'インタラクション品質',
                stabilityScore: '安定性',
                bondScore: 'ソーシャルボンド',
                recentTimeScore: '最近の同行',
                recentFreqScore: '最近の頻度',
                shareScore: 'ライフシェア',
                noInteractionData: 'インタラクション記録なし',
                hiddenFriend: '隠しフレンド',
                hiddenFriendHint: 'このフレンドは共通フレンド関係を隠している可能性があります',
                hour: '時間',
                times: '回',
                // 着色モード
                colorMode: '着色モード',
                colorByConnections: '共通フレンド数',
                colorByTrust: '信頼レベル',
                colorByStrength: '関係強度',
                colorByPlaytime: 'プレイ時間',
                colorByCommunity: 'コミュニティ',
                communityResolution: '解像度',
                resolutionAuto: '自動',
                resolutionFine: '精細',
                // エクスポート
                exportCSV: 'CSV出力',
                exportStrength: '関係強度ランキング',
                exportIntimacy: '親密度ランキング',
                exportFull: '完全データ',
                // データ情報
                dataInfo: 'データ情報',
                dataRange: 'データ範囲',
                totalDays: '総日数',
                activityRate: 'アクティビティ',
                halflife: '半減期',
                day: '日',
                dataInfoDesc: '指標はVRCXログに基づいて計算されます。完全性は記録期間に依存します。'
            }
        };

        let currentLang = 'zh';

        function updateLanguage(lang) {
            currentLang = lang;
            const texts = i18n[lang];

            // 更新所有带 data-i18n 属性的元素
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (texts[key]) {
                    el.textContent = texts[key];
                }
            });

            // 更新输入框 placeholder
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (texts[key]) {
                    el.placeholder = texts[key];
                }
            });

            // 更新 title 属性
            document.querySelectorAll('[data-i18n-title]').forEach(el => {
                const key = el.getAttribute('data-i18n-title');
                if (texts[key]) {
                    el.title = texts[key];
                }
            });

            // 更新下拉菜单激活状态
            document.querySelectorAll('.lang-option').forEach(opt => {
                opt.classList.toggle('active', opt.getAttribute('data-lang') === lang);
            });

            // 保存语言偏好
            localStorage.setItem('preferredLang', lang);

            // 更新文件名显示（如果已加载文件）
            if (window.networkViz && window.networkViz.currentFileName) {
                const fileNameEl = document.getElementById('fileName');
                fileNameEl.textContent = `${texts.currentFile}: ${window.networkViz.currentFileName}`;
            }

            // 刷新动态生成的内容（排名列表或节点详情）
            if (window.networkViz && window.networkViz.nodes && window.networkViz.nodes.length > 0) {
                // 更新图例翻译
                if (window.networkViz.updateLegendColors) {
                    window.networkViz.updateLegendColors();
                }
                // 更新数据信息面板
                if (window.networkViz.dataParams && window.networkViz.updateDataInfo) {
                    window.networkViz.updateDataInfo(window.networkViz.dataParams);
                }
                if (window.networkViz.selectedNode) {
                    window.networkViz.showNodeDetail(window.networkViz.selectedNode);
                } else {
                    window.networkViz.showRankingList();
                }
            }
        }

        // GEXF 解析器
        class GEXFParser {
            static parse(xmlString) {
                const parser = new DOMParser();
                const xml = parser.parseFromString(xmlString, 'text/xml');

                const nodes = [];
                const edges = [];
                const nodeMap = new Map();

                // 首先解析属性定义，建立 id -> title 映射
                const attrMap = new Map();
                const attrElements = xml.querySelectorAll('attributes[class="node"] attribute');
                attrElements.forEach(attr => {
                    const attrId = attr.getAttribute('id');
                    const title = attr.getAttribute('title');
                    if (attrId && title) {
                        attrMap.set(attrId, title);
                    }
                });

                // 解析节点
                const nodeElements = xml.querySelectorAll('node');
                nodeElements.forEach(node => {
                    const id = node.getAttribute('id');
                    const label = node.getAttribute('label');

                    // 默认值（兼容旧版 GEXF）
                    let type = 'friend';
                    let displayName = label;
                    let trustLevel = '';
                    let meetCount = 0;
                    let meetCount7d = 0;
                    let meetCount30d = 0;
                    let playTime = 0;
                    let playTime7d = 0;
                    let playTime30d = 0;
                    let daysKnown = 0;
                    // 关系指标（新增）
                    let relationshipStrength = 0;
                    let recentIntimacy = 0;
                    let recentIntimacy30d = 0;
                    let recentIntimacy60d = 0;
                    let recentIntimacy90d = 0;
                    let effectiveHours = 0;
                    let retentionRate = 0;
                    let lifeShare = 0;
                    let isHiddenFriend = false;

                    const attvalues = node.querySelectorAll('attvalue');
                    attvalues.forEach(attr => {
                        const forAttr = attr.getAttribute('for');
                        const value = attr.getAttribute('value');
                        const attrTitle = attrMap.get(forAttr);

                        // 优先使用 title 匹配，其次使用 id 匹配（兼容旧格式）
                        if (attrTitle === 'type' || forAttr === '0') type = value;
                        else if (attrTitle === 'displayName' || forAttr === '1') displayName = value;
                        else if (attrTitle === 'trustLevel' || forAttr === '2') trustLevel = value;
                        else if (attrTitle === 'meetCount' || forAttr === '3') meetCount = parseInt(value) || 0;
                        else if (attrTitle === 'meetCount7d' || forAttr === '4') meetCount7d = parseInt(value) || 0;
                        else if (attrTitle === 'meetCount30d' || forAttr === '5') meetCount30d = parseInt(value) || 0;
                        else if (attrTitle === 'playTime' || forAttr === '6') playTime = parseFloat(value) || 0;
                        else if (attrTitle === 'playTime7d' || forAttr === '7') playTime7d = parseFloat(value) || 0;
                        else if (attrTitle === 'playTime30d' || forAttr === '8') playTime30d = parseFloat(value) || 0;
                        else if (attrTitle === 'daysKnown' || forAttr === '9') daysKnown = parseInt(value) || 0;
                        // 关系指标
                        else if (attrTitle === 'relationshipStrength' || forAttr === '10') relationshipStrength = parseFloat(value) || 0;
                        else if (attrTitle === 'recentIntimacy' || forAttr === '11') recentIntimacy = parseFloat(value) || 0;
                        else if (attrTitle === 'effectiveHours' || forAttr === '12') effectiveHours = parseFloat(value) || 0;
                        else if (attrTitle === 'retentionRate' || forAttr === '13') retentionRate = parseFloat(value) || 0;
                        else if (attrTitle === 'lifeShare' || forAttr === '14') lifeShare = parseFloat(value) || 0;
                        else if (attrTitle === 'isHiddenFriend' || forAttr === '15') isHiddenFriend = value === 'true';
                        else if (attrTitle === 'recentIntimacy30d' || forAttr === '16') recentIntimacy30d = parseFloat(value) || 0;
                        else if (attrTitle === 'recentIntimacy60d' || forAttr === '17') recentIntimacy60d = parseFloat(value) || 0;
                        else if (attrTitle === 'recentIntimacy90d' || forAttr === '18') recentIntimacy90d = parseFloat(value) || 0;
                    });

                    const nodeData = {
                        id,
                        label: displayName || label,
                        type,
                        connections: 0,
                        // 新增属性（可能为默认值，用于兼容旧版 GEXF）
                        trustLevel,
                        meetCount,
                        meetCount7d,
                        meetCount30d,
                        playTime,
                        playTime7d,
                        playTime30d,
                        daysKnown,
                        // 关系指标
                        relationshipStrength,
                        recentIntimacy,
                        recentIntimacy30d,
                        recentIntimacy60d,
                        recentIntimacy90d,
                        effectiveHours,
                        retentionRate,
                        lifeShare,
                        isHiddenFriend
                    };

                    nodes.push(nodeData);
                    nodeMap.set(id, nodeData);
                });

                // 解析边
                const edgeElements = xml.querySelectorAll('edge');
                edgeElements.forEach(edge => {
                    const source = edge.getAttribute('source');
                    const target = edge.getAttribute('target');
                    edges.push({ source, target });
                });

                // 正确计算每个节点的连接数（使用 Set 去重）
                nodes.forEach(node => {
                    const connectionSet = new Set();
                    edges.forEach(edge => {
                        if (edge.source === node.id && edge.target !== node.id) {
                            connectionSet.add(edge.target);
                        }
                        if (edge.target === node.id && edge.source !== node.id) {
                            connectionSet.add(edge.source);
                        }
                    });
                    node.connections = connectionSet.size;
                });

                return { nodes, edges };
            }
        }

        // 算法常量
        const ALGORITHM_CONSTANTS = {
            HALFLIFE_BASE_DAYS: 90,           // 半衰期基准天数
            HALFLIFE_MULTIPLIER: 2,           // 半衰期乘数 (2 - activityFactor)
            RECENT_WINDOW_BASE_DAYS: 30,      // 近期窗口基准天数
            RECENT_WINDOW_RANGE_DAYS: 30,     // 近期窗口浮动范围
            // 关系强度权重
            WEIGHT_DEPTH: 35,                 // 有效陪伴深度
            WEIGHT_QUALITY: 25,               // 互动质量
            WEIGHT_STABILITY: 20,             // 稳定性
            WEIGHT_BOND: 20,                  // 社交羁绊
            // 近期亲密度权重
            WEIGHT_RECENT_TIME: 50,           // 近期陪伴时长
            WEIGHT_RECENT_FREQ: 30,           // 近期频率
            WEIGHT_LIFE_SHARE: 20             // 生命份额
        };

        // 信任等级颜色（VRChat 官方配色）
        const TRUST_LEVEL_COLORS = {
            'Visitor': '#cccccc',
            'New User': '#1778ff',
            'User': '#2bcf5c',
            'Known User': '#ff7b42',
            'Trusted User': '#8143e6'
        };

        // 主可视化类
        class NetworkVisualization {
            constructor() {
                this.svg = d3.select('#graph');
                this.width = 0;
                this.height = 0;
                this.nodes = [];
                this.edges = [];
                this.nodeMap = new Map();
                this.neighborIndex = new Map();  // 邻接表索引：nodeId -> Set<neighborId>
                this.edgeIndex = new Map();      // 边索引：nodeId -> [edges]
                this.simulation = null;
                this.showLabels = true;
                this.frozen = false;
                this.selectedNode = null;
                this.highlightedNodes = new Set();
                this.currentGexfContent = null;  // 保存当前的 GEXF 内容用于导出
                this.currentFileName = null;     // 当前文件名
                this.isDragging = false;         // 是否正在拖动节点
                this.colorMode = 'connections';  // 着色模式
                this.userResolution = null;      // 用户设置的社区粒度（null=自动）
                this.dataParams = null;          // 数据库参数信息

                // 缓存常用 DOM 元素引用
                this.domCache = {
                    loading: document.getElementById('loading'),
                    welcomeScreen: document.getElementById('welcomeScreen'),
                    legend: document.querySelector('.legend'),
                    zoomControls: document.querySelector('.zoom-controls'),
                    colorModeToolbar: document.getElementById('colorModeToolbar'),
                    dataInfoSection: document.getElementById('dataInfoSection'),
                    detailSection: document.getElementById('detailSection'),
                    fileName: document.getElementById('fileName'),
                    exportGexfBtn: document.getElementById('btnExportGexf')
                };

                this.init();
            }

            async init() {
                this.updateDimensions();
                window.addEventListener('resize', () => this.updateDimensions());

                // 不自动加载数据，等待用户选择文件
                this.setupControls();
                this.showWelcome();
            }

            showWelcome() {
                // 隐藏加载动画，显示欢迎界面
                this.domCache.loading.style.display = 'none';
                this.domCache.welcomeScreen.style.display = 'flex';
                // 隐藏图例和控制按钮
                this.domCache.legend.style.display = 'none';
                this.domCache.zoomControls.style.display = 'none';
                this.domCache.colorModeToolbar.classList.remove('visible');
                this.domCache.dataInfoSection.classList.remove('visible');
            }

            hideWelcome() {
                this.domCache.welcomeScreen.style.display = 'none';
                // 显示图例和控制按钮
                this.domCache.legend.style.display = 'block';
                this.domCache.zoomControls.style.display = 'flex';
                this.domCache.colorModeToolbar.classList.add('visible');
            }

            updateDimensions() {
                const container = document.querySelector('.graph-area');
                this.width = container.clientWidth;
                this.height = container.clientHeight;

                this.svg
                    .attr('width', this.width)
                    .attr('height', this.height);
            }

            async loadData(fileContent = null) {
                try {
                    let text;
                    if (fileContent) {
                        text = fileContent;
                    } else {
                        const response = await fetch('mutual_graph.gexf');
                        text = await response.text();
                    }

                    const data = GEXFParser.parse(text);

                    this.nodes = data.nodes;
                    this.edges = data.edges;
                    this.nodeMap.clear();

                    this.nodes.forEach(node => {
                        this.nodeMap.set(node.id, node);
                    });

                    // 构建邻接表索引（性能优化）
                    this.buildGraphIndex();

                    this.updateStats();
                } catch (error) {
                    console.error('加载数据失败:', error);
                    alert('加载文件失败，请确保文件格式正确');
                }
            }

            async loadFromFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = (e) => reject(e);
                    reader.readAsText(file);
                });
            }

            async loadFromVRCXDatabase(file) {
                // 显示加载界面
                this.hideWelcome();
                const loading = this.domCache.loading;
                loading.style.display = 'flex';
                loading.style.opacity = '1';
                const texts = i18n[currentLang];
                document.querySelector('.loading-text').textContent = texts.initSql;

                try {
                    // 初始化 sql.js
                    const SQL = await initSqlJs({
                        locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
                    });

                    document.querySelector('.loading-text').textContent = texts.readingDb;

                    // 读取文件为 ArrayBuffer
                    const arrayBuffer = await file.arrayBuffer();
                    const db = new SQL.Database(new Uint8Array(arrayBuffer));

                    document.querySelector('.loading-text').textContent = '正在解析数据...';

                    // 检测所有可用的账号前缀
                    const allPrefixes = this.detectAllVRCXPrefixes(db);
                    if (!allPrefixes.length) {
                        throw new Error('无法找到 mutual_graph 相关表，请确保已在 VRCX 中执行过 Fetch Mutual Friends');
                    }

                    // 如果有多个账号，显示选择对话框
                    let prefix;
                    if (allPrefixes.length > 1) {
                        // 隐藏加载动画，显示选择对话框
                        loading.style.display = 'none';
                        
                        // 加载保存的账号信息
                        const savedCredentials = this.loadSavedCredentials(db);
                        
                        // 获取每个账号的信息
                        const accounts = allPrefixes.map(p => this.getAccountInfo(db, p, savedCredentials));
                        prefix = await this.showAccountSelector(accounts);
                        
                        // 重新显示加载动画
                        loading.style.display = 'flex';
                        document.querySelector('.loading-text').textContent = '正在加载数据...';
                    } else {
                        prefix = allPrefixes[0];
                    }

                    // 获取数据库最新日期作为时间基准
                    const latestDate = this.getVRCXLatestDate(db);

                    // 加载好友信息（displayName + trustLevel）
                    const friendInfo = this.loadVRCXDisplayNames(db, prefix);

                    // 加载好友 ID
                    const friendIds = this.loadVRCXFriendIds(db, prefix);

                    // 加载边
                    const edges = this.loadVRCXEdges(db, prefix);

                    // 加载游玩数据（meetCount, playTime + 7d/30d）
                    const playData = this.loadVRCXPlayData(db, latestDate);

                    // 加载认识天数
                    const daysKnown = this.loadVRCXDaysKnown(db, prefix, latestDate);

                    document.querySelector('.loading-text').textContent = '正在计算关系指标...';

                    // 执行关系分析算法
                    const { metrics: relationshipMetrics, params: analysisParams } = 
                        await this.analyzeRelationships(db, prefix, latestDate, friendIds);

                    // 保存分析参数供后续使用
                    this.analysisParams = analysisParams;

                    // 关闭数据库
                    db.close();

                    document.querySelector('.loading-text').textContent = '正在生成图形...';

                    // 构建 GEXF（包含所有新增属性和关系指标）
                    const gexfContent = this.buildGEXFFromVRCX(friendIds, edges, friendInfo, playData, daysKnown, relationshipMetrics);

                    // 加载图形（显示原始文件名，标记为从数据库导入）
                    await this.reloadGraph(gexfContent, file.name, true);

                    // 显示数据完整性信息
                    this.updateDataInfo({
                        dateRange: analysisParams.dateRange,
                        totalDays: analysisParams.totalDays,
                        activityFactor: analysisParams.activityFactor,
                        halflife: analysisParams.halflife,
                        recentWindow: analysisParams.recentWindow
                    });

                } catch (error) {
                    loading.style.display = 'none';
                    this.showWelcome();
                    throw error;
                }
            }

            detectVRCXPrefix(db) {
                const result = db.exec("SELECT name FROM sqlite_master WHERE type='table' AND name LIKE '%mutual_graph_links'");
                if (!result.length || !result[0].values.length) return null;

                const tableName = result[0].values[0][0];
                return tableName.replace('_mutual_graph_links', '');
            }

            detectAllVRCXPrefixes(db) {
                const result = db.exec("SELECT name FROM sqlite_master WHERE type='table' AND name LIKE '%_mutual_graph_links'");
                if (!result.length || !result[0].values.length) return [];

                return result[0].values.map(row => row[0].replace('_mutual_graph_links', ''));
            }

            // Load saved credentials from configs table (if available)
            loadSavedCredentials(db) {
                const credentials = new Map(); // userId -> displayName
                try {
                    const result = db.exec("SELECT value FROM configs WHERE key = 'config:savedcredentials'");
                    if (result.length && result[0].values.length) {
                        const jsonStr = result[0].values[0][0];
                        if (jsonStr) {
                            const savedCreds = JSON.parse(jsonStr);
                            // savedCreds is an array of credential objects
                            if (Array.isArray(savedCreds)) {
                                savedCreds.forEach(cred => {
                                    if (cred.user && cred.user.id && cred.user.displayName) {
                                        credentials.set(cred.user.id, cred.user.displayName);
                                    }
                                });
                            }
                        }
                    }
                } catch (e) {
                    console.warn('无法加载 savedCredentials:', e);
                }
                return credentials;
            }

            getAccountInfo(db, prefix, savedCredentials) {
                let friendCount = 0;
                let displayName = '';
                
                try {
                    const countResult = db.exec(`SELECT COUNT(*) FROM ${prefix}_friend_log_current`);
                    if (countResult.length && countResult[0].values.length) {
                        friendCount = countResult[0].values[0][0] || 0;
                    }
                } catch (e) {}

                // Convert prefix to user ID format
                let userId = prefix;
                if (prefix.startsWith('usr') && prefix.length === 35) {
                    const raw = prefix.slice(3);
                    userId = `usr_${raw.slice(0,8)}-${raw.slice(8,12)}-${raw.slice(12,16)}-${raw.slice(16,20)}-${raw.slice(20)}`;
                }

                // Try to get display name from saved credentials
                if (savedCredentials && savedCredentials.has(userId)) {
                    displayName = savedCredentials.get(userId);
                }

                return { prefix, friendCount, userId, displayName };
            }

            showAccountSelector(accounts) {
                return new Promise((resolve) => {
                    const texts = i18n[currentLang];
                    
                    const overlay = document.createElement('div');
                    overlay.className = 'account-modal-overlay';
                    overlay.innerHTML = `
                        <div class="account-modal">
                            <div class="account-modal-title">${texts.selectAccount}</div>
                            <div class="account-modal-desc">${texts.selectAccountDesc}</div>
                            <div class="account-list">
                                ${accounts.map((acc, idx) => `
                                    <div class="account-item" data-prefix="${acc.prefix}">
                                        <div class="account-item-icon">${acc.displayName ? acc.displayName.charAt(0).toUpperCase() : (idx + 1)}</div>
                                        <div class="account-item-info">
                                            <div class="account-item-name">${acc.displayName || `Account ${idx + 1}`}</div>
                                            <div class="account-item-id">${acc.userId} (${acc.friendCount} ${texts.friendCount})</div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(overlay);
                    
                    overlay.querySelectorAll('.account-item').forEach(item => {
                        item.addEventListener('click', () => {
                            const prefix = item.getAttribute('data-prefix');
                            overlay.remove();
                            resolve(prefix);
                        });
                    });
                });
            }

            loadVRCXDisplayNames(db, prefix) {
                // Returns Map<userId, {displayName, trustLevel}>
                const friendInfo = new Map();
                try {
                    const result = db.exec(`SELECT user_id, display_name, trust_level FROM ${prefix}_friend_log_current`);
                    if (result.length && result[0].values) {
                        result[0].values.forEach(([userId, displayName, trustLevel]) => {
                            if (userId) {
                                friendInfo.set(userId, {
                                    displayName: displayName || '',
                                    trustLevel: trustLevel || ''
                                });
                            }
                        });
                    }
                } catch (e) {
                    console.warn('无法加载显示名称表:', e);
                }
                return friendInfo;
            }

            loadVRCXFriendIds(db, prefix) {
                const result = db.exec(`SELECT friend_id FROM ${prefix}_mutual_graph_friends`);
                if (!result.length) return [];
                return result[0].values.map(row => row[0]).filter(Boolean);
            }

            loadVRCXEdges(db, prefix) {
                const excludedIds = new Set(['usr_00000000-0000-0000-0000-000000000000']);
                const result = db.exec(`SELECT friend_id, mutual_id FROM ${prefix}_mutual_graph_links`);
                if (!result.length) return [];

                return result[0].values
                    .filter(([friendId, mutualId]) =>
                        friendId && mutualId &&
                        !excludedIds.has(friendId) &&
                        !excludedIds.has(mutualId)
                    )
                    .map(([friendId, mutualId]) => ({ source: friendId, target: mutualId }));
            }

            // Get the latest date from gamelog_join_leave as time reference
            getVRCXLatestDate(db) {
                try {
                    const result = db.exec(`SELECT MAX(created_at) as latest_date FROM gamelog_join_leave`);
                    if (result.length && result[0].values[0][0]) {
                        const dateStr = result[0].values[0][0];
                        // 验证日期格式（ISO 8601 或 SQLite datetime 格式）
                        if (/^\d{4}-\d{2}-\d{2}/.test(dateStr)) {
                            return dateStr;
                        }
                    }
                } catch (e) {
                    console.warn('无法获取最新日期:', e);
                }
                return new Date().toISOString();
            }

            // Load play data (meetCount, playTime) for all friends
            // Returns Map<userId, {meetCount, playTime, meetCount7d, playTime7d, meetCount30d, playTime30d}>
            loadVRCXPlayData(db, latestDate) {
                const playData = new Map();

                try {
                    // All-time data: meetCount and playTime (time is in milliseconds)
                    const allTimeResult = db.exec(`
                        SELECT
                            user_id,
                            COUNT(*) as meet_count,
                            SUM(CASE WHEN time > 0 THEN time ELSE 0 END) / 1000.0 as play_seconds
                        FROM gamelog_join_leave
                        WHERE type = 'OnPlayerLeft'
                          AND user_id IS NOT NULL
                          AND user_id != ''
                        GROUP BY user_id
                    `);

                    if (allTimeResult.length && allTimeResult[0].values) {
                        allTimeResult[0].values.forEach(([userId, meetCount, playSeconds]) => {
                            if (userId) {
                                playData.set(userId, {
                                    meetCount: meetCount || 0,
                                    playTime: playSeconds || 0,
                                    meetCount7d: 0,
                                    playTime7d: 0,
                                    meetCount30d: 0,
                                    playTime30d: 0
                                });
                            }
                        });
                    }

                    // Last 30 days data
                    const last30dResult = db.exec(`
                        SELECT
                            user_id,
                            COUNT(*) as meet_count,
                            SUM(CASE WHEN time > 0 THEN time ELSE 0 END) / 1000.0 as play_seconds
                        FROM gamelog_join_leave
                        WHERE type = 'OnPlayerLeft'
                          AND user_id IS NOT NULL
                          AND user_id != ''
                          AND created_at >= datetime('${latestDate}', '-30 days')
                        GROUP BY user_id
                    `);

                    if (last30dResult.length && last30dResult[0].values) {
                        last30dResult[0].values.forEach(([userId, meetCount, playSeconds]) => {
                            if (userId && playData.has(userId)) {
                                const data = playData.get(userId);
                                data.meetCount30d = meetCount || 0;
                                data.playTime30d = playSeconds || 0;
                            }
                        });
                    }

                    // Last 7 days data
                    const last7dResult = db.exec(`
                        SELECT
                            user_id,
                            COUNT(*) as meet_count,
                            SUM(CASE WHEN time > 0 THEN time ELSE 0 END) / 1000.0 as play_seconds
                        FROM gamelog_join_leave
                        WHERE type = 'OnPlayerLeft'
                          AND user_id IS NOT NULL
                          AND user_id != ''
                          AND created_at >= datetime('${latestDate}', '-7 days')
                        GROUP BY user_id
                    `);

                    if (last7dResult.length && last7dResult[0].values) {
                        last7dResult[0].values.forEach(([userId, meetCount, playSeconds]) => {
                            if (userId && playData.has(userId)) {
                                const data = playData.get(userId);
                                data.meetCount7d = meetCount || 0;
                                data.playTime7d = playSeconds || 0;
                            }
                        });
                    }
                } catch (e) {
                    console.warn('无法加载游玩数据:', e);
                }

                return playData;
            }

            // Load days known (from friend_log_history with type='Friend')
            // Returns Map<userId, daysKnown>
            loadVRCXDaysKnown(db, prefix, latestDate) {
                const daysKnown = new Map();

                try {
                    const result = db.exec(`
                        SELECT
                            user_id,
                            julianday('${latestDate}') - julianday(MIN(created_at)) as days
                        FROM ${prefix}_friend_log_history
                        WHERE type = 'Friend'
                        GROUP BY user_id
                    `);

                    if (result.length && result[0].values) {
                        result[0].values.forEach(([userId, days]) => {
                            if (userId) {
                                daysKnown.set(userId, Math.round(days) || 0);
                            }
                        });
                    }
                } catch (e) {
                    console.warn('无法加载认识天数:', e);
                }

                return daysKnown;
            }

            // ========== 关系分析算法 V2.1 ==========

            // 获取每日互动数据聚合
            // Returns Map<userId, Array<{day: string, hours: number}>>
            loadVRCXDailyInteractions(db, latestDate) {
                const dailyData = new Map();

                try {
                    const result = db.exec(`
                        SELECT 
                            user_id, 
                            date(created_at) as day, 
                            SUM(CASE WHEN time > 0 THEN time ELSE 0 END) / 3600000.0 as hours
                        FROM gamelog_join_leave
                        WHERE type = 'OnPlayerLeft'
                          AND user_id IS NOT NULL
                          AND user_id != ''
                        GROUP BY user_id, date(created_at)
                    `);

                    if (result.length && result[0].values) {
                        result[0].values.forEach(([userId, day, hours]) => {
                            if (userId && day) {
                                if (!dailyData.has(userId)) {
                                    dailyData.set(userId, []);
                                }
                                dailyData.get(userId).push({ day, hours: hours || 0 });
                            }
                        });
                    }
                } catch (e) {
                    console.warn('无法加载每日互动数据:', e);
                }

                return dailyData;
            }

            // 获取好友统计数据 (interaction_count, meet_count, active_days)
            // Returns Map<userId, {interactionCount, meetCount, activeDays}>
            loadVRCXFriendStats(db) {
                const stats = new Map();

                try {
                    const result = db.exec(`
                        SELECT 
                            user_id,
                            COUNT(*) as interaction_count,
                            COUNT(DISTINCT location) as meet_count,
                            COUNT(DISTINCT date(created_at)) as active_days
                        FROM gamelog_join_leave
                        WHERE type = 'OnPlayerLeft' 
                          AND user_id IS NOT NULL 
                          AND user_id != ''
                          AND time > 0
                        GROUP BY user_id
                    `);

                    if (result.length && result[0].values) {
                        result[0].values.forEach(([userId, interactionCount, meetCount, activeDays]) => {
                            if (userId) {
                                stats.set(userId, {
                                    interactionCount: interactionCount || 0,
                                    meetCount: meetCount || 0,
                                    activeDays: activeDays || 0
                                });
                            }
                        });
                    }
                } catch (e) {
                    console.warn('无法加载好友统计数据:', e);
                }

                return stats;
            }

            // 获取近期互动数据 (recent_hours, recent_meets)
            // Returns Map<userId, {recentHours, recentMeets}>
            loadVRCXRecentStats(db, latestDate, recentWindow) {
                const recent = new Map();

                try {
                    const result = db.exec(`
                        SELECT 
                            user_id,
                            SUM(CASE WHEN time > 0 THEN time ELSE 0 END) / 3600000.0 as recent_hours,
                            COUNT(DISTINCT location) as recent_meets
                        FROM gamelog_join_leave
                        WHERE type = 'OnPlayerLeft'
                          AND user_id IS NOT NULL
                          AND user_id != ''
                          AND created_at >= datetime('${latestDate}', '-${recentWindow} days')
                        GROUP BY user_id
                    `);

                    if (result.length && result[0].values) {
                        result[0].values.forEach(([userId, recentHours, recentMeets]) => {
                            if (userId) {
                                recent.set(userId, {
                                    recentHours: recentHours || 0,
                                    recentMeets: recentMeets || 0
                                });
                            }
                        });
                    }
                } catch (e) {
                    console.warn('无法加载近期互动数据:', e);
                }

                return recent;
            }

            // 获取我的近期在线时长
            getMyRecentOnlineHours(db, latestDate, recentWindow) {
                try {
                    const result = db.exec(`
                        SELECT SUM(CASE WHEN time > 0 THEN time ELSE 0 END) / 3600000.0 as hours
                        FROM gamelog_location
                        WHERE created_at >= datetime('${latestDate}', '-${recentWindow} days')
                    `);

                    if (result.length && result[0].values[0][0]) {
                        return result[0].values[0][0];
                    }
                } catch (e) {
                    console.warn('无法获取我的近期在线时长:', e);
                }
                return 0;
            }

            // 计算自适应参数（半衰期、近期窗口）
            calculateAdaptiveParams(db, latestDate) {
                let myActiveDays = 0;
                let totalDays = 1;
                let dateRange = '--';

                try {
                    // 获取总天数范围和日期范围
                    const rangeResult = db.exec(`
                        SELECT 
                            julianday(MAX(date(created_at))) - julianday(MIN(date(created_at))) + 1 as total_days,
                            MIN(date(created_at)) as min_date,
                            MAX(date(created_at)) as max_date
                        FROM gamelog_join_leave
                    `);
                    if (rangeResult.length && rangeResult[0].values[0]) {
                        const [td, minDate, maxDate] = rangeResult[0].values[0];
                        totalDays = Math.max(1, td || 1);
                        if (minDate && maxDate) {
                            dateRange = `${minDate.slice(5)} ~ ${maxDate.slice(5)}`;
                        }
                    }

                    // 获取我的活跃天数（从 gamelog_location）
                    const activeDaysResult = db.exec(`
                        SELECT COUNT(DISTINCT date(created_at)) as active_days
                        FROM gamelog_location
                    `);
                    if (activeDaysResult.length && activeDaysResult[0].values[0][0]) {
                        myActiveDays = activeDaysResult[0].values[0][0];
                    }
                } catch (e) {
                    console.warn('无法计算活跃度参数:', e);
                }

                const activityFactor = Math.min(myActiveDays / totalDays, 1.0);
                
                // 半衰期 = 基准 × (乘数 - 活跃度因子)，范围 90-180 天
                const halflife = ALGORITHM_CONSTANTS.HALFLIFE_BASE_DAYS * (ALGORITHM_CONSTANTS.HALFLIFE_MULTIPLIER - activityFactor);
                
                // 近期窗口 = 基准 + (1 - 活跃度因子) × 范围，范围 30-60 天
                const recentWindow = Math.round(ALGORITHM_CONSTANTS.RECENT_WINDOW_BASE_DAYS + (1 - activityFactor) * ALGORITHM_CONSTANTS.RECENT_WINDOW_RANGE_DAYS);

                console.log(`[关系分析] 活跃度: ${(activityFactor * 100).toFixed(1)}%, 半衰期: ${halflife.toFixed(0)}天, 近期窗口: ${recentWindow}天`);

                return { 
                    activityFactor, 
                    halflife, 
                    recentWindow, 
                    totalDays, 
                    myActiveDays,
                    dateRange
                };
            }

            // 计算有效时长（带衰减）
            calculateEffectiveHours(dailyData, latestDate, halflife) {
                const results = new Map();
                const maxDate = new Date(latestDate);

                dailyData.forEach((interactions, userId) => {
                    let effectiveHours = 0;
                    let totalHours = 0;

                    interactions.forEach(({ day, hours }) => {
                        const dayDate = new Date(day);
                        const daysAgo = Math.floor((maxDate - dayDate) / (1000 * 60 * 60 * 24));
                        const weight = Math.pow(2, -daysAgo / halflife);
                        effectiveHours += hours * weight;
                        totalHours += hours;
                    });

                    const retentionRate = totalHours > 0 ? effectiveHours / totalHours : 0;

                    results.set(userId, {
                        totalHours,
                        effectiveHours,
                        retentionRate
                    });
                });

                return results;
            }

            // Percentile Rank 归一化（百分位排名）- 使用二分查找优化
            percentileRank(value, sortedValues) {
                if (sortedValues.length === 0) return 0;
                // 二分查找：找到第一个 >= value 的位置
                let left = 0, right = sortedValues.length;
                while (left < right) {
                    const mid = (left + right) >>> 1;
                    if (sortedValues[mid] < value) {
                        left = mid + 1;
                    } else {
                        right = mid;
                    }
                }
                return left / sortedValues.length;
            }

            // Sigmoid 归一化
            sigmoid(x, k) {
                if (k <= 0) return 0.5;
                return x / (x + k);
            }

            // 计算关系强度和近期亲密度
            calculateRelationshipMetrics(friendIds, effectiveData, friendStats, recentStats, mutualCounts, myRecentHours, totalDays, extraRecentData = null) {
                const results = new Map();

                // 收集所有有效时长用于排名计算
                const allEffectiveHours = [];
                const allTotalHours = [];
                const allMeetCounts = [];
                const allConnections = [];
                const allAvgDurations = [];
                const allRecentHours = [];
                const allRecentMeets = [];
                const allLifeShares = [];

                // 为30d/60d/90d各自构建参考数据
                const allRecentHours30d = [];
                const allRecentMeets30d = [];
                const allRecentHours60d = [];
                const allRecentMeets60d = [];
                const allRecentHours90d = [];
                const allRecentMeets90d = [];

                // 第一遍：收集数据
                friendIds.forEach(userId => {
                    const eff = effectiveData.get(userId);
                    const stats = friendStats.get(userId);
                    const recent = recentStats.get(userId);
                    const connections = mutualCounts.get(userId) || 0;

                    if (eff && stats) {
                        allEffectiveHours.push(eff.effectiveHours);
                        allTotalHours.push(eff.totalHours);
                        allMeetCounts.push(stats.meetCount);
                        allConnections.push(connections);
                        
                        if (stats.interactionCount > 0) {
                            allAvgDurations.push(eff.totalHours / stats.interactionCount);
                        }
                    }

                    if (recent && recent.recentHours > 0) {
                        allRecentHours.push(recent.recentHours);
                        allRecentMeets.push(recent.recentMeets);
                        if (myRecentHours > 0) {
                            allLifeShares.push(recent.recentHours / myRecentHours);
                        }
                    }

                    // 收集30d/60d/90d数据
                    if (extraRecentData) {
                        const r30 = extraRecentData.recentStats30d?.get(userId);
                        if (r30 && r30.recentHours > 0) {
                            allRecentHours30d.push(r30.recentHours);
                            allRecentMeets30d.push(r30.recentMeets);
                        }
                        const r60 = extraRecentData.recentStats60d?.get(userId);
                        if (r60 && r60.recentHours > 0) {
                            allRecentHours60d.push(r60.recentHours);
                            allRecentMeets60d.push(r60.recentMeets);
                        }
                        const r90 = extraRecentData.recentStats90d?.get(userId);
                        if (r90 && r90.recentHours > 0) {
                            allRecentHours90d.push(r90.recentHours);
                            allRecentMeets90d.push(r90.recentMeets);
                        }
                    }
                });

                // 排序用于百分位计算
                allEffectiveHours.sort((a, b) => a - b);
                allTotalHours.sort((a, b) => a - b);
                allMeetCounts.sort((a, b) => a - b);
                allConnections.sort((a, b) => a - b);
                allAvgDurations.sort((a, b) => a - b);
                allRecentHours.sort((a, b) => a - b);
                allRecentMeets.sort((a, b) => a - b);
                allLifeShares.sort((a, b) => a - b);
                // 排序30d/60d/90d参考数据
                allRecentHours30d.sort((a, b) => a - b);
                allRecentMeets30d.sort((a, b) => a - b);
                allRecentHours60d.sort((a, b) => a - b);
                allRecentMeets60d.sort((a, b) => a - b);
                allRecentHours90d.sort((a, b) => a - b);
                allRecentMeets90d.sort((a, b) => a - b);

                // 计算中位数
                const medianAvgDuration = allAvgDurations.length > 0 
                    ? allAvgDurations[Math.floor(allAvgDurations.length / 2)] 
                    : 1;
                const medianLifeShare = allLifeShares.length > 0 
                    ? allLifeShares[Math.floor(allLifeShares.length / 2)] 
                    : 0.01;

                // 隐藏好友检测阈值 (P70)
                const hoursP70 = allTotalHours.length > 0 
                    ? allTotalHours[Math.floor(allTotalHours.length * 0.7)] 
                    : 0;
                const meetsP70 = allMeetCounts.length > 0 
                    ? allMeetCounts[Math.floor(allMeetCounts.length * 0.7)] 
                    : 0;

                // 第二遍：计算指标
                friendIds.forEach(userId => {
                    const eff = effectiveData.get(userId);
                    const stats = friendStats.get(userId);
                    const recent = recentStats.get(userId) || { recentHours: 0, recentMeets: 0 };
                    const connections = mutualCounts.get(userId) || 0;

                    if (!eff || !stats) {
                        results.set(userId, {
                            relationshipStrength: 0,
                            recentIntimacy: 0,
                            effectiveHours: 0,
                            totalHours: 0,
                            retentionRate: 0,
                            isHiddenFriend: false
                        });
                        return;
                    }

                    // === 关系强度计算 ===

                    // 有效陪伴深度 (40%)
                    const depthPercentile = this.percentileRank(eff.effectiveHours, allEffectiveHours);
                    const depthScore = depthPercentile * 40;

                    // 互动质量 (25%)
                    const avgDuration = stats.interactionCount > 0 
                        ? eff.totalHours / stats.interactionCount 
                        : 0;
                    const qualityScore = this.sigmoid(avgDuration, medianAvgDuration) * 25;

                    // 稳定性 (20%)
                    const stabilityRatio = stats.activeDays / totalDays;
                    const stabilityScore = Math.sqrt(Math.min(stabilityRatio, 1)) * 20;

                    // 社交羁绊 (15%) - 含隐藏好友检测
                    let bondScore = 7.5; // 默认中等分
                    let isHiddenFriend = false;

                    if (connections > 0) {
                        const bondPercentile = this.percentileRank(connections, allConnections);
                        bondScore = bondPercentile * 15;
                    } else {
                        // 隐藏好友检测：共同好友=0 但互动量高
                        const highInteraction = eff.totalHours > hoursP70 || stats.meetCount > meetsP70;
                        if (highInteraction) {
                            isHiddenFriend = true;
                            bondScore = depthPercentile * 15; // 用互动量排名替代
                        }
                    }

                    const relationshipStrength = depthScore + qualityScore + stabilityScore + bondScore;

                    // === 近期亲密度计算 ===

                    let recentTimeScore = 0;
                    let recentFreqScore = 0;
                    let shareScore = 0;
                    let lifeShare = 0;

                    if (recent.recentHours > 0) {
                        // 近期陪伴 (40%)
                        recentTimeScore = this.percentileRank(recent.recentHours, allRecentHours) * 40;

                        // 近期频率 (30%)
                        recentFreqScore = this.percentileRank(recent.recentMeets, allRecentMeets) * 30;

                        // 生命份额 (30%)
                        if (myRecentHours > 0) {
                            lifeShare = recent.recentHours / myRecentHours;
                            shareScore = this.sigmoid(lifeShare, Math.max(medianLifeShare, 0.01)) * 30;
                        }
                    }

                    const recentIntimacy = recentTimeScore + recentFreqScore + shareScore;

                    // 计算固定时间窗口的近期亲密度 (30d, 60d, 90d)
                    let recentIntimacy30d = 0;
                    let recentIntimacy60d = 0;
                    let recentIntimacy90d = 0;

                    if (extraRecentData) {
                        // 30天近期亲密度 - 使用30天参考数据集
                        const recent30 = extraRecentData.recentStats30d?.get(userId) || { recentHours: 0, recentMeets: 0 };
                        if (recent30.recentHours > 0 && extraRecentData.myRecentHours30d > 0) {
                            const timeScore30 = this.percentileRank(recent30.recentHours, allRecentHours30d) * 40;
                            const freqScore30 = this.percentileRank(recent30.recentMeets, allRecentMeets30d) * 30;
                            const lifeShare30 = recent30.recentHours / extraRecentData.myRecentHours30d;
                            const shareScore30 = this.sigmoid(lifeShare30, Math.max(medianLifeShare, 0.01)) * 30;
                            recentIntimacy30d = timeScore30 + freqScore30 + shareScore30;
                        }

                        // 60天近期亲密度 - 使用60天参考数据集
                        const recent60 = extraRecentData.recentStats60d?.get(userId) || { recentHours: 0, recentMeets: 0 };
                        if (recent60.recentHours > 0 && extraRecentData.myRecentHours60d > 0) {
                            const timeScore60 = this.percentileRank(recent60.recentHours, allRecentHours60d) * 40;
                            const freqScore60 = this.percentileRank(recent60.recentMeets, allRecentMeets60d) * 30;
                            const lifeShare60 = recent60.recentHours / extraRecentData.myRecentHours60d;
                            const shareScore60 = this.sigmoid(lifeShare60, Math.max(medianLifeShare, 0.01)) * 30;
                            recentIntimacy60d = timeScore60 + freqScore60 + shareScore60;
                        }

                        // 90天近期亲密度 - 使用90天参考数据集
                        const recent90 = extraRecentData.recentStats90d?.get(userId) || { recentHours: 0, recentMeets: 0 };
                        if (recent90.recentHours > 0 && extraRecentData.myRecentHours90d > 0) {
                            const timeScore90 = this.percentileRank(recent90.recentHours, allRecentHours90d) * 40;
                            const freqScore90 = this.percentileRank(recent90.recentMeets, allRecentMeets90d) * 30;
                            const lifeShare90 = recent90.recentHours / extraRecentData.myRecentHours90d;
                            const shareScore90 = this.sigmoid(lifeShare90, Math.max(medianLifeShare, 0.01)) * 30;
                            recentIntimacy90d = timeScore90 + freqScore90 + shareScore90;
                        }
                    }

                    results.set(userId, {
                        relationshipStrength,
                        recentIntimacy,
                        recentIntimacy30d,
                        recentIntimacy60d,
                        recentIntimacy90d,
                        effectiveHours: eff.effectiveHours,
                        totalHours: eff.totalHours,
                        retentionRate: eff.retentionRate,
                        recentHours: recent.recentHours,
                        recentMeets: recent.recentMeets,
                        lifeShare,
                        isHiddenFriend,
                        // 关系强度子分数
                        depthScore,
                        qualityScore,
                        stabilityScore,
                        bondScore,
                        // 近期亲密度子分数
                        recentTimeScore,
                        recentFreqScore,
                        shareScore
                    });
                });

                return results;
            }

            // 完整的关系分析流程
            async analyzeRelationships(db, prefix, latestDate, friendIds) {
                console.log('[关系分析] 开始计算...');

                // 1. 计算自适应参数
                const params = this.calculateAdaptiveParams(db, latestDate);

                // 2. 获取每日互动数据
                const dailyData = this.loadVRCXDailyInteractions(db, latestDate);
                console.log(`[关系分析] 每日互动数据: ${dailyData.size} 位好友`);

                // 3. 计算有效时长
                const effectiveData = this.calculateEffectiveHours(dailyData, latestDate, params.halflife);

                // 4. 获取好友统计数据
                const friendStats = this.loadVRCXFriendStats(db);

                // 5. 获取近期互动数据（固定30d/60d/90d）
                const recentStats = this.loadVRCXRecentStats(db, latestDate, params.recentWindow);
                const recentStats30d = this.loadVRCXRecentStats(db, latestDate, 30);
                const recentStats60d = this.loadVRCXRecentStats(db, latestDate, 60);
                const recentStats90d = this.loadVRCXRecentStats(db, latestDate, 90);

                // 6. 获取我的近期在线时长（固定30d/60d/90d）
                const myRecentHours = this.getMyRecentOnlineHours(db, latestDate, params.recentWindow);
                const myRecentHours30d = this.getMyRecentOnlineHours(db, latestDate, 30);
                const myRecentHours60d = this.getMyRecentOnlineHours(db, latestDate, 60);
                const myRecentHours90d = this.getMyRecentOnlineHours(db, latestDate, 90);
                console.log(`[关系分析] 我近${params.recentWindow}天在线: ${myRecentHours.toFixed(1)}小时`);

                // 7. 获取共同好友数
                const mutualCounts = new Map();
                try {
                    const result = db.exec(`
                        SELECT friend_id, COUNT(*) as count
                        FROM ${prefix}_mutual_graph_links
                        GROUP BY friend_id
                    `);
                    if (result.length && result[0].values) {
                        result[0].values.forEach(([friendId, count]) => {
                            if (friendId) {
                                mutualCounts.set(friendId, count || 0);
                            }
                        });
                    }
                } catch (e) {
                    console.warn('无法加载共同好友数:', e);
                }

                // 8. 计算关系指标
                const friendIdSet = new Set(friendIds);
                const metrics = this.calculateRelationshipMetrics(
                    friendIdSet, 
                    effectiveData, 
                    friendStats, 
                    recentStats, 
                    mutualCounts, 
                    myRecentHours, 
                    params.totalDays,
                    { recentStats30d, recentStats60d, recentStats90d, myRecentHours30d, myRecentHours60d, myRecentHours90d }
                );

                console.log(`[关系分析] 完成! 计算了 ${metrics.size} 位好友的关系指标`);

                return { metrics, params };
            }

            buildGEXFFromVRCX(friendIds, edges, friendInfo, playData, daysKnown, relationshipMetrics = null) {
                const friendSet = new Set(friendIds);
                const nodeIds = new Set(friendIds);
                const excludedIds = new Set(['usr_00000000-0000-0000-0000-000000000000']);

                // 收集所有节点 ID
                edges.forEach(edge => {
                    if (edge.target && !excludedIds.has(edge.target)) {
                        nodeIds.add(edge.target);
                    }
                });

                // 构建节点（只导入在 friend_log_current 中存在的真正好友）
                const nodes = [];
                nodeIds.forEach(nodeId => {
                    if (excludedIds.has(nodeId)) return;
                    
                    // 只导入在 friendInfo（来自 friend_log_current）中存在的好友
                    // mutual_graph_friends 可能包含已删除的好友，跳过这些节点
                    const info = friendInfo.get(nodeId);
                    if (!info) return;
                    
                    const nodeType = 'friend';
                    const safeInfo = info;
                    const play = playData.get(nodeId) || {
                        meetCount: 0, playTime: 0,
                        meetCount7d: 0, playTime7d: 0,
                        meetCount30d: 0, playTime30d: 0
                    };
                    const days = daysKnown.get(nodeId) || 0;
                    const displayName = info.displayName || '';
                    const label = displayName || nodeId;

                    // 获取关系指标（如果有）
                    const metrics = relationshipMetrics ? relationshipMetrics.get(nodeId) : null;

                    nodes.push({
                        id: nodeId,
                        type: nodeType,
                        label,
                        displayName: displayName || label,
                        trustLevel: info.trustLevel || '',
                        meetCount: play.meetCount || 0,
                        meetCount7d: play.meetCount7d || 0,
                        meetCount30d: play.meetCount30d || 0,
                        playTime: play.playTime || 0,
                        playTime7d: play.playTime7d || 0,
                        playTime30d: play.playTime30d || 0,
                        daysKnown: days || 0,
                        // 关系指标
                        relationshipStrength: (metrics && metrics.relationshipStrength) || 0,
                        recentIntimacy: (metrics && metrics.recentIntimacy) || 0,
                        recentIntimacy30d: (metrics && metrics.recentIntimacy30d) || 0,
                        recentIntimacy60d: (metrics && metrics.recentIntimacy60d) || 0,
                        recentIntimacy90d: (metrics && metrics.recentIntimacy90d) || 0,
                        effectiveHours: (metrics && metrics.effectiveHours) || 0,
                        retentionRate: (metrics && metrics.retentionRate) || 0,
                        lifeShare: (metrics && metrics.lifeShare) || 0,
                        isHiddenFriend: (metrics && metrics.isHiddenFriend) || false
                    });
                });

                // 排序节点
                nodes.sort((a, b) => a.id.localeCompare(b.id));

                // 构建 GEXF XML
                const timestamp = new Date().toISOString().split('T')[0];
                const escapeXml = (str) => String(str)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&apos;');

                let gexf = `<?xml version="1.0" encoding="UTF-8"?>
<gexf xmlns="http://www.gexf.net/1.3draft" version="1.3">
  <meta lastmodifieddate="${timestamp}">
    <creator>VRCX Mutual Graph Exporter (Browser)</creator>
    <description>Mutual friend network exported from VRCX database</description>
  </meta>
  <graph mode="static" defaultedgetype="undirected">
    <attributes class="node" mode="static">
      <attribute id="0" title="type" type="string"/>
      <attribute id="1" title="displayName" type="string"/>
      <attribute id="2" title="trustLevel" type="string"/>
      <attribute id="3" title="meetCount" type="integer"/>
      <attribute id="4" title="meetCount7d" type="integer"/>
      <attribute id="5" title="meetCount30d" type="integer"/>
      <attribute id="6" title="playTime" type="float"/>
      <attribute id="7" title="playTime7d" type="float"/>
      <attribute id="8" title="playTime30d" type="float"/>
      <attribute id="9" title="daysKnown" type="integer"/>
      <attribute id="10" title="relationshipStrength" type="float"/>
      <attribute id="11" title="recentIntimacy" type="float"/>
      <attribute id="12" title="effectiveHours" type="float"/>
      <attribute id="13" title="retentionRate" type="float"/>
      <attribute id="14" title="lifeShare" type="float"/>
      <attribute id="15" title="isHiddenFriend" type="boolean"/>
      <attribute id="16" title="recentIntimacy30d" type="float"/>
      <attribute id="17" title="recentIntimacy60d" type="float"/>
      <attribute id="18" title="recentIntimacy90d" type="float"/>
    </attributes>
    <nodes>
`;
                nodes.forEach(node => {
                    // 安全获取数值，防止 undefined.toFixed() 错误
                    const safeNum = (v) => (typeof v === 'number' && !isNaN(v)) ? v : 0;
                    
                    gexf += `      <node id="${escapeXml(node.id)}" label="${escapeXml(node.label)}">
        <attvalues>
          <attvalue for="0" value="${escapeXml(node.type)}" />
          <attvalue for="1" value="${escapeXml(node.displayName)}" />
          <attvalue for="2" value="${escapeXml(node.trustLevel)}" />
          <attvalue for="3" value="${safeNum(node.meetCount)}" />
          <attvalue for="4" value="${safeNum(node.meetCount7d)}" />
          <attvalue for="5" value="${safeNum(node.meetCount30d)}" />
          <attvalue for="6" value="${safeNum(node.playTime).toFixed(2)}" />
          <attvalue for="7" value="${safeNum(node.playTime7d).toFixed(2)}" />
          <attvalue for="8" value="${safeNum(node.playTime30d).toFixed(2)}" />
          <attvalue for="9" value="${safeNum(node.daysKnown)}" />
          <attvalue for="10" value="${safeNum(node.relationshipStrength).toFixed(2)}" />
          <attvalue for="11" value="${safeNum(node.recentIntimacy).toFixed(2)}" />
          <attvalue for="12" value="${safeNum(node.effectiveHours * 3600).toFixed(2)}" />
          <attvalue for="13" value="${safeNum(node.retentionRate).toFixed(4)}" />
          <attvalue for="14" value="${safeNum(node.lifeShare).toFixed(4)}" />
          <attvalue for="15" value="${node.isHiddenFriend || false}" />
          <attvalue for="16" value="${safeNum(node.recentIntimacy30d).toFixed(2)}" />
          <attvalue for="17" value="${safeNum(node.recentIntimacy60d).toFixed(2)}" />
          <attvalue for="18" value="${safeNum(node.recentIntimacy90d).toFixed(2)}" />
        </attvalues>
      </node>
`;
                });

                gexf += `    </nodes>
    <edges>
`;
                // 只包含两端节点都在 friendInfo 中的边
                const validNodeIds = new Set(nodes.map(n => n.id));
                let edgeIndex = 0;
                edges.forEach((edge) => {
                    if (validNodeIds.has(edge.source) && validNodeIds.has(edge.target)) {
                        gexf += `      <edge id="${edgeIndex++}" source="${escapeXml(edge.source)}" target="${escapeXml(edge.target)}" />
`;
                    }
                });

                gexf += `    </edges>
  </graph>
</gexf>`;

                return gexf;
            }

            async reloadGraph(fileContent, fileName, isFromDatabase = false) {
                // 隐藏欢迎界面
                this.hideWelcome();

                // 显示加载动画
                const loading = this.domCache.loading;
                loading.style.display = 'flex';
                loading.style.opacity = '1';

                // 清除旧的图形
                if (this.simulation) {
                    this.simulation.stop();
                }
                if (this.container) {
                    this.container.selectAll('*').remove();
                }

                // 重置状态
                this.selectedNode = null;
                this.highlightedNodes.clear();
                this.frozen = false;
                document.getElementById('btnFreeze').classList.remove('active');

                // 保存 GEXF 内容用于导出
                this.currentGexfContent = fileContent;
                this.currentFileName = fileName;

                // 加载新数据
                await this.loadData(fileContent);

                // 重新设置模拟和渲染
                this.setupSimulation();
                this.render();

                // 更新文件名显示（使用当前语言）
                const texts = i18n[currentLang];
                this.domCache.fileName.textContent = `${texts.currentFile}: ${fileName}`;

                // 如果是从数据库导入的，显示导出按钮
                const exportBtn = this.domCache.exportGexfBtn;
                if (isFromDatabase) {
                    exportBtn.style.display = 'flex';
                } else {
                    exportBtn.style.display = 'none';
                }

                // 显示排名列表
                this.showRankingList();

                // 移动端加载成功后自动隐藏侧边栏
                if (window.innerWidth <= 900) {
                    document.querySelector('.sidebar').classList.remove('visible');
                    document.getElementById('sidebarOverlay').classList.remove('visible');
                    document.getElementById('menuToggle').classList.remove('active');
                }

                // 重置搜索框
                document.getElementById('searchInput').value = '';

                // 隐藏加载动画
                this.hideLoading();
            }

            showRankingList(dimension = 'mutual', timeRange = 'all') {
                this.currentRankingDimension = dimension;
                this.currentRankingTimeRange = timeRange;
                const texts = i18n[currentLang];

                // 根据维度和时间范围获取排序字段和格式化函数
                const getDimensionConfig = () => {
                    switch (dimension) {
                        case 'strength':
                            return {
                                getValue: n => n.relationshipStrength || 0,
                                format: v => v.toFixed(1),
                                showHint: true
                            };
                        case 'intimacy':
                            // 近期亲密度：30d/60d/90d 使用对应字段
                            const intimacyField = timeRange === '60d' ? 'recentIntimacy60d' : 
                                                  timeRange === '90d' ? 'recentIntimacy90d' : 'recentIntimacy30d';
                            return {
                                getValue: n => n[intimacyField] || 0,
                                format: v => v.toFixed(1),
                                showHint: true
                            };
                        case 'playtime':
                            const field = timeRange === '7d' ? 'playTime7d' : 
                                          timeRange === '30d' ? 'playTime30d' : 'playTime';
                            return {
                                getValue: n => n[field] || 0,
                                format: v => (v / 3600).toFixed(1) + 'h',
                                showHint: true
                            };
                        default: // mutual
                            return {
                                getValue: n => n.connections,
                                format: v => v.toString(),
                                showHint: false
                            };
                    }
                };

                const config = getDimensionConfig();
                const sortedNodes = [...this.nodes].sort((a, b) => config.getValue(b) - config.getValue(a));

                const detailSection = this.domCache.detailSection;
                detailSection.innerHTML = `
                    <div class="ranking-card">
                        <div class="ranking-header-row">
                            <div class="ranking-header">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"></path>
                                </svg>
                                <span>${texts.rankingTitle}</span>
                            </div>
                            <div class="export-csv-dropdown">
                                <button class="export-csv-btn">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                        <polyline points="7 10 12 15 17 10"></polyline>
                                        <line x1="12" y1="15" x2="12" y2="3"></line>
                                    </svg>
                                    <span>${texts.exportCSV}</span>
                                </button>
                                <div class="export-csv-menu">
                                    <button class="export-csv-option" data-export="strength">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                                            <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                                        </svg>
                                        <span>${texts.exportStrength}</span>
                                    </button>
                                    <button class="export-csv-option" data-export="intimacy">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor" stroke="none">
                                            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path>
                                        </svg>
                                        <span>${texts.exportIntimacy}</span>
                                    </button>
                                    <button class="export-csv-option" data-export="full">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                            <polyline points="14 2 14 8 20 8"></polyline>
                                            <line x1="16" y1="13" x2="8" y2="13"></line>
                                            <line x1="16" y1="17" x2="8" y2="17"></line>
                                            <polyline points="10 9 9 9 8 9"></polyline>
                                        </svg>
                                        <span>${texts.exportFull}</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="ranking-tabs">
                            <button class="ranking-tab ${dimension === 'mutual' ? 'active' : ''}" data-dim="mutual">${texts.rankingMutual}</button>
                            <button class="ranking-tab ${dimension === 'strength' ? 'active' : ''}" data-dim="strength">${texts.rankingStrength}</button>
                            <button class="ranking-tab ${dimension === 'intimacy' ? 'active' : ''}" data-dim="intimacy">${texts.rankingIntimacy}</button>
                            <button class="ranking-tab ${dimension === 'playtime' ? 'active' : ''}" data-dim="playtime">${texts.rankingPlaytime}</button>
                        </div>
                        ${dimension === 'intimacy' ? `
                            <div class="ranking-time-selector">
                                <button class="ranking-time-btn ${timeRange === '30d' || timeRange === 'all' ? 'active' : ''}" data-time="30d">${texts.time30d}</button>
                                <button class="ranking-time-btn ${timeRange === '60d' ? 'active' : ''}" data-time="60d">${texts.time60d}</button>
                                <button class="ranking-time-btn ${timeRange === '90d' ? 'active' : ''}" data-time="90d">${texts.time90d}</button>
                            </div>
                        ` : ''}
                        ${dimension === 'playtime' ? `
                            <div class="ranking-time-selector">
                                <button class="ranking-time-btn ${timeRange === 'all' ? 'active' : ''}" data-time="all">${texts.timeAll}</button>
                                <button class="ranking-time-btn ${timeRange === '30d' ? 'active' : ''}" data-time="30d">${texts.time30d}</button>
                                <button class="ranking-time-btn ${timeRange === '7d' ? 'active' : ''}" data-time="7d">${texts.time7d}</button>
                            </div>
                        ` : ''}
                        ${config.showHint ? `<div class="ranking-data-hint">${texts.dataHint}</div>` : ''}
                        <div class="ranking-desc">${texts.clickToView}</div>
                        <div class="ranking-list">
                            ${sortedNodes.map((node, index) => `
                                <div class="ranking-item ${index < 3 ? 'top-' + (index + 1) : ''}" data-id="${node.id}">
                                    <span class="ranking-position">${index + 1}</span>
                                    <span class="ranking-name">${node.label}</span>
                                    <span class="ranking-score">${config.format(config.getValue(node))}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;

                // Tab 切换事件
                detailSection.querySelectorAll('.ranking-tab').forEach(tab => {
                    tab.addEventListener('click', () => {
                        const dim = tab.getAttribute('data-dim');
                        // 切换维度时，保留对应维度的时间范围或使用默认值
                        let newTimeRange = 'all';
                        if (dim === 'playtime' && this.currentRankingDimension === 'playtime') {
                            newTimeRange = this.currentRankingTimeRange;
                        } else if (dim === 'intimacy' && this.currentRankingDimension === 'intimacy') {
                            newTimeRange = this.currentRankingTimeRange;
                        } else if (dim === 'intimacy') {
                            newTimeRange = '30d';
                        }
                        this.showRankingList(dim, newTimeRange);
                    });
                });

                // 时间范围切换事件
                detailSection.querySelectorAll('.ranking-time-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const time = btn.getAttribute('data-time');
                        this.showRankingList(this.currentRankingDimension, time);
                    });
                });

                // 导出 CSV 事件
                detailSection.querySelectorAll('.export-csv-option').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const exportType = btn.getAttribute('data-export');
                        this.exportCSV(exportType);
                    });
                });

                // 排行榜项点击事件
                detailSection.querySelectorAll('.ranking-item[data-id]').forEach(item => {
                    item.addEventListener('click', () => {
                        const id = item.getAttribute('data-id');
                        const node = this.nodeMap.get(id);
                        if (node) {
                            this.selectedNode = node;
                            this.highlightConnections(node);
                            this.showNodeDetail(node);
                            this.centerOnNode(node);
                        }
                    });
                });
            }

            // 构建图索引（邻接表 + 边索引），用于加速高亮和邻居查询
            buildGraphIndex() {
                this.neighborIndex.clear();
                this.edgeIndex.clear();

                // 初始化每个节点的索引
                this.nodes.forEach(node => {
                    this.neighborIndex.set(node.id, new Set());
                    this.edgeIndex.set(node.id, []);
                });

                // 遍历边构建索引
                this.edges.forEach(edge => {
                    const sourceId = typeof edge.source === 'object' ? edge.source.id : edge.source;
                    const targetId = typeof edge.target === 'object' ? edge.target.id : edge.target;

                    // 添加邻居关系
                    if (this.neighborIndex.has(sourceId)) {
                        this.neighborIndex.get(sourceId).add(targetId);
                    }
                    if (this.neighborIndex.has(targetId)) {
                        this.neighborIndex.get(targetId).add(sourceId);
                    }

                    // 添加边索引
                    if (this.edgeIndex.has(sourceId)) {
                        this.edgeIndex.get(sourceId).push(edge);
                    }
                    if (this.edgeIndex.has(targetId)) {
                        this.edgeIndex.get(targetId).push(edge);
                    }
                });
            }

            updateStats() {
                const nodeCount = this.nodes.length;
                const edgeCount = this.edges.length;

                // 空图边界检查
                if (nodeCount === 0) {
                    document.getElementById('nodeCount').textContent = '0';
                    document.getElementById('edgeCount').textContent = '0';
                    document.getElementById('avgDegree').textContent = '0';
                    document.getElementById('density').textContent = '0%';
                    this.maxConnections = 1;
                    this.nodeRanks = new Map();
                    this.strengthRanks = new Map();
                    this.intimacyRanks = new Map();
                    return;
                }

                const totalDegree = this.nodes.reduce((sum, n) => sum + n.connections, 0);
                const avgDegree = (totalDegree / nodeCount).toFixed(1);
                const maxPossibleEdges = (nodeCount * (nodeCount - 1)) / 2;
                const density = maxPossibleEdges > 0 ? (edgeCount / maxPossibleEdges * 100).toFixed(2) : '0';

                document.getElementById('nodeCount').textContent = nodeCount;
                document.getElementById('edgeCount').textContent = edgeCount;
                document.getElementById('avgDegree').textContent = avgDegree;
                document.getElementById('density').textContent = density + '%';

                // 缓存最大连接数，避免重复计算
                this.maxConnections = Math.max(...this.nodes.map(n => n.connections), 1);

                // 预计算节点排名（连接数）
                this.nodeRanks = new Map();
                const sorted = [...this.nodes].sort((a, b) => b.connections - a.connections);
                sorted.forEach((node, index) => {
                    this.nodeRanks.set(node.id, index + 1);
                });

                // 预计算关系强度排名
                this.strengthRanks = new Map();
                const sortedByStrength = [...this.nodes].sort((a, b) => (b.relationshipStrength || 0) - (a.relationshipStrength || 0));
                sortedByStrength.forEach((node, index) => {
                    this.strengthRanks.set(node.id, index + 1);
                });

                // 预计算近期亲密度排名
                this.intimacyRanks = new Map();
                const sortedByIntimacy = [...this.nodes].sort((a, b) => (b.recentIntimacy || 0) - (a.recentIntimacy || 0));
                sortedByIntimacy.forEach((node, index) => {
                    this.intimacyRanks.set(node.id, index + 1);
                });

                // 构建邻接表（用于聚类系数和社区检测）
                this.adjacencyMap = new Map();
                this.edgeSet = new Set();
                this.nodes.forEach(n => this.adjacencyMap.set(n.id, new Set()));
                this.edges.forEach(e => {
                    const s = typeof e.source === 'object' ? e.source.id : e.source;
                    const t = typeof e.target === 'object' ? e.target.id : e.target;
                    if (this.adjacencyMap.has(s)) this.adjacencyMap.get(s).add(t);
                    if (this.adjacencyMap.has(t)) this.adjacencyMap.get(t).add(s);
                    const edgeKey = s < t ? `${s}|${t}` : `${t}|${s}`;
                    this.edgeSet.add(edgeKey);
                });

                // 计算聚类系数
                this.calculateClusteringCoefficients();

                // 社区检测
                this.detectCommunities();

                // 更新统计卡片
                const avgClustering = this.avgClusteringCoef !== undefined ? this.avgClusteringCoef.toFixed(2) : '--';
                const communityCount = this.communityCount || '--';
                document.getElementById('clusteringCoef').textContent = avgClustering;
                document.getElementById('communityCount').textContent = communityCount;
            }

            calculateClusteringCoefficients() {
                let totalClustering = 0;
                let countWithNeighbors = 0;
                this.nodes.forEach(node => {
                    const neighbors = this.adjacencyMap.get(node.id);
                    if (!neighbors || neighbors.size < 2) {
                        node.clusteringCoef = 0;
                        return;
                    }
                    const neighborArr = Array.from(neighbors);
                    let edgesBetween = 0;
                    for (let i = 0; i < neighborArr.length; i++) {
                        for (let j = i + 1; j < neighborArr.length; j++) {
                            const key = neighborArr[i] < neighborArr[j] 
                                ? `${neighborArr[i]}|${neighborArr[j]}` 
                                : `${neighborArr[j]}|${neighborArr[i]}`;
                            if (this.edgeSet.has(key)) edgesBetween++;
                        }
                    }
                    const maxEdges = (neighbors.size * (neighbors.size - 1)) / 2;
                    node.clusteringCoef = maxEdges > 0 ? edgesBetween / maxEdges : 0;
                    totalClustering += node.clusteringCoef;
                    countWithNeighbors++;
                });
                this.avgClusteringCoef = countWithNeighbors > 0 ? totalClustering / countWithNeighbors : 0;
            }

            detectCommunities() {
                // 完整 Louvain 算法 - 基于模块度优化的社区检测
                // 包含：自适应/手动 resolution、多次运行取最优、两阶段迭代
                
                if (this.nodes.length === 0) {
                    this.communityCount = 0;
                    this.communityColors = [];
                    return;
                }

                const m = this.edges.length;
                if (m === 0) {
                    this.nodes.forEach((node, i) => { node.community = i; });
                    this.communityCount = this.nodes.length;
                    this.communityColors = this.generateCommunityColors(this.communityCount);
                    return;
                }

                // 获取 resolution：用户设置或自适应
                let resolution;
                if (this.userResolution !== null && this.userResolution !== undefined) {
                    resolution = this.userResolution;
                } else {
                    // 自适应：根据网络密度计算
                    const n = this.nodes.length;
                    const maxEdges = (n * (n - 1)) / 2;
                    const density = m / maxEdges;
                    resolution = 1.0 + density * 2.0;
                }

                // 多次运行取最优结果
                const numRuns = 3;
                let bestResult = null;
                let bestModularity = -Infinity;

                for (let run = 0; run < numRuns; run++) {
                    const result = this.louvainOneRun(resolution);
                    if (result.modularity > bestModularity) {
                        bestModularity = result.modularity;
                        bestResult = result;
                    }
                }

                // 应用最优结果
                this.nodes.forEach(node => {
                    node.community = bestResult.communities.get(node.id) ?? 0;
                });
                this.communityCount = bestResult.communityCount;
                this.communityColors = this.generateCommunityColors(this.communityCount);
            }

            louvainOneRun(resolution) {
                // 构建工作图（支持超节点聚合）
                let graph = {
                    nodes: this.nodes.map(n => n.id),
                    adj: new Map(),
                    degree: new Map(),
                    nodeWeight: new Map() // 超节点内部边权重
                };
                
                // 初始化邻接表和度数
                graph.nodes.forEach(nid => {
                    graph.adj.set(nid, new Map());
                    graph.nodeWeight.set(nid, 0);
                });
                this.edges.forEach(e => {
                    const s = typeof e.source === 'object' ? e.source.id : e.source;
                    const t = typeof e.target === 'object' ? e.target.id : e.target;
                    if (s === t) return;
                    graph.adj.get(s).set(t, (graph.adj.get(s).get(t) || 0) + 1);
                    graph.adj.get(t).set(s, (graph.adj.get(t).get(s) || 0) + 1);
                });
                graph.nodes.forEach(nid => {
                    let deg = 0;
                    graph.adj.get(nid).forEach(w => { deg += w; });
                    graph.degree.set(nid, deg);
                });

                // 记录原始节点到最终社区的映射
                let nodeToFinalComm = new Map();
                graph.nodes.forEach(nid => nodeToFinalComm.set(nid, nid));

                let totalM = this.edges.length;
                let level = 0;
                const maxLevels = 10;

                while (level < maxLevels) {
                    // 第一阶段：局部移动
                    const phaseResult = this.louvainPhase1(graph, resolution, totalM);
                    
                    if (!phaseResult.improved) break;

                    // 更新原始节点到社区的映射
                    const newMapping = new Map();
                    nodeToFinalComm.forEach((currentComm, origNode) => {
                        newMapping.set(origNode, phaseResult.nodeToComm.get(currentComm));
                    });
                    nodeToFinalComm = newMapping;

                    // 第二阶段：社区聚合为超节点
                    graph = this.louvainPhase2(graph, phaseResult.nodeToComm);
                    
                    if (graph.nodes.length <= 1) break;
                    level++;
                }

                // 重新编号社区
                const uniqueComms = [...new Set(nodeToFinalComm.values())];
                const commRemap = new Map();
                uniqueComms.forEach((c, i) => commRemap.set(c, i));

                const communities = new Map();
                nodeToFinalComm.forEach((comm, nid) => {
                    communities.set(nid, commRemap.get(comm));
                });

                // 计算最终模块度
                const modularity = this.calculateModularity(communities, resolution);

                return {
                    communities,
                    communityCount: uniqueComms.length,
                    modularity
                };
            }

            louvainPhase1(graph, resolution, totalM) {
                // 初始化：每个节点一个社区
                const nodeToComm = new Map();
                const commNodes = new Map();
                graph.nodes.forEach((nid, i) => {
                    nodeToComm.set(nid, nid);
                    commNodes.set(nid, new Set([nid]));
                });

                // 社区总度数
                const commTotDegree = new Map();
                graph.nodes.forEach(nid => {
                    commTotDegree.set(nid, graph.degree.get(nid) + 2 * graph.nodeWeight.get(nid));
                });

                // 社区内部边权重
                const commInternalWeight = new Map();
                graph.nodes.forEach(nid => {
                    commInternalWeight.set(nid, graph.nodeWeight.get(nid));
                });

                const m2 = totalM * 2; // 2m
                let improved = false;
                const maxPasses = 20;

                for (let pass = 0; pass < maxPasses; pass++) {
                    let passImproved = false;
                    const shuffled = [...graph.nodes].sort(() => Math.random() - 0.5);

                    for (const nid of shuffled) {
                        const currentComm = nodeToComm.get(nid);
                        const neighbors = graph.adj.get(nid);
                        if (!neighbors || neighbors.size === 0) continue;

                        const ki = graph.degree.get(nid) + 2 * graph.nodeWeight.get(nid);

                        // 统计到各社区的边权重
                        const commEdgeWeight = new Map();
                        neighbors.forEach((weight, neighborId) => {
                            const neighborComm = nodeToComm.get(neighborId);
                            commEdgeWeight.set(neighborComm, (commEdgeWeight.get(neighborComm) || 0) + weight);
                        });

                        // 从当前社区移除
                        commNodes.get(currentComm).delete(nid);
                        const kiInCurrent = commEdgeWeight.get(currentComm) || 0;
                        commTotDegree.set(currentComm, commTotDegree.get(currentComm) - ki);
                        commInternalWeight.set(currentComm, 
                            (commInternalWeight.get(currentComm) || 0) - graph.nodeWeight.get(nid) - kiInCurrent);

                        // 寻找最佳社区
                        let bestComm = currentComm;
                        let bestDeltaQ = 0;

                        const candidateComms = new Set([currentComm]);
                        neighbors.forEach((_, neighborId) => candidateComms.add(nodeToComm.get(neighborId)));

                        for (const targetComm of candidateComms) {
                            if (!commNodes.has(targetComm) || commNodes.get(targetComm).size === 0) {
                                if (targetComm !== currentComm) continue;
                            }
                            
                            const kiInTarget = commEdgeWeight.get(targetComm) || 0;
                            const sigmaTot = commTotDegree.get(targetComm) || 0;

                            // ΔQ = 2 * (ki_in - resolution * ki * Σ_tot / (2m))
                            const deltaQ = (kiInTarget - resolution * ki * sigmaTot / m2) / totalM;

                            if (deltaQ > bestDeltaQ + 1e-10) {
                                bestDeltaQ = deltaQ;
                                bestComm = targetComm;
                            }
                        }

                        // 加入最佳社区
                        nodeToComm.set(nid, bestComm);
                        if (!commNodes.has(bestComm)) commNodes.set(bestComm, new Set());
                        commNodes.get(bestComm).add(nid);
                        const kiInBest = commEdgeWeight.get(bestComm) || 0;
                        commTotDegree.set(bestComm, (commTotDegree.get(bestComm) || 0) + ki);
                        commInternalWeight.set(bestComm,
                            (commInternalWeight.get(bestComm) || 0) + graph.nodeWeight.get(nid) + kiInBest);

                        if (bestComm !== currentComm) {
                            passImproved = true;
                            improved = true;
                        }
                    }

                    if (!passImproved) break;
                }

                return { nodeToComm, improved };
            }

            louvainPhase2(graph, nodeToComm) {
                // 将社区聚合为超节点
                const communities = [...new Set(nodeToComm.values())];
                const newGraph = {
                    nodes: communities,
                    adj: new Map(),
                    degree: new Map(),
                    nodeWeight: new Map()
                };

                communities.forEach(c => {
                    newGraph.adj.set(c, new Map());
                    newGraph.nodeWeight.set(c, 0);
                    newGraph.degree.set(c, 0);
                });

                // 计算超节点内部边权重和社区间边权重
                graph.nodes.forEach(nid => {
                    const comm = nodeToComm.get(nid);
                    // 累加节点内部权重
                    newGraph.nodeWeight.set(comm, newGraph.nodeWeight.get(comm) + graph.nodeWeight.get(nid));
                    
                    graph.adj.get(nid).forEach((weight, neighborId) => {
                        const neighborComm = nodeToComm.get(neighborId);
                        if (comm === neighborComm) {
                            // 内部边（只计算一半避免重复）
                            newGraph.nodeWeight.set(comm, newGraph.nodeWeight.get(comm) + weight / 2);
                        } else {
                            // 社区间边
                            newGraph.adj.get(comm).set(neighborComm, 
                                (newGraph.adj.get(comm).get(neighborComm) || 0) + weight);
                        }
                    });
                });

                // 计算新图度数
                communities.forEach(c => {
                    let deg = 0;
                    newGraph.adj.get(c).forEach(w => { deg += w; });
                    newGraph.degree.set(c, deg);
                });

                return newGraph;
            }

            calculateModularity(communities, resolution) {
                const m = this.edges.length;
                if (m === 0) return 0;

                const m2 = 2 * m;
                let Q = 0;

                // 计算每个社区的内部边数和总度数
                const commInternalEdges = new Map();
                const commTotalDegree = new Map();

                this.nodes.forEach(node => {
                    const comm = communities.get(node.id);
                    const deg = this.adjacencyMap.get(node.id)?.size || 0;
                    commTotalDegree.set(comm, (commTotalDegree.get(comm) || 0) + deg);
                });

                this.edges.forEach(e => {
                    const s = typeof e.source === 'object' ? e.source.id : e.source;
                    const t = typeof e.target === 'object' ? e.target.id : e.target;
                    const commS = communities.get(s);
                    const commT = communities.get(t);
                    if (commS === commT) {
                        commInternalEdges.set(commS, (commInternalEdges.get(commS) || 0) + 1);
                    }
                });

                commTotalDegree.forEach((totalDeg, comm) => {
                    const internalEdges = commInternalEdges.get(comm) || 0;
                    Q += internalEdges / m - resolution * (totalDeg / m2) * (totalDeg / m2);
                });

                return Q;
            }

            generateCommunityColors(count) {
                // 使用黄金角分布生成颜色，确保对比度
                const colors = [];
                const goldenRatio = 0.618033988749895;
                let hue = 0.1;
                for (let i = 0; i < count; i++) {
                    hue = (hue + goldenRatio) % 1;
                    const h = Math.floor(hue * 360);
                    const s = 65 + (i % 3) * 10;
                    const l = 50 + (i % 2) * 10;
                    colors.push(`hsl(${h}, ${s}%, ${l}%)`);
                }
                return colors;
            }

            setupSimulation() {
                const isLargeDataset = this.edges.length > 10000;

                this.simulation = d3.forceSimulation(this.nodes)
                    .force('link', d3.forceLink(this.edges)
                        .id(d => d.id)
                        .distance(80))
                    .force('charge', d3.forceManyBody()
                        .strength(-300)
                        // 大数据时限制计算范围以提升性能
                        .theta(isLargeDataset ? 0.9 : 0.81)
                        .distanceMax(isLargeDataset ? 500 : Infinity))
                    .force('center', d3.forceCenter(this.width / 2, this.height / 2))
                    .force('collision', d3.forceCollide().radius(d => this.getNodeRadius(d) + 5));

                // 大数据时加快收敛
                if (isLargeDataset) {
                    this.simulation
                        .alphaDecay(0.03)      // 加快收敛（默认 0.0228）
                        .velocityDecay(0.5);   // 增加阻尼（默认 0.4）
                }
            }

            getNodeRadius(d) {
                const minRadius = 6;
                const maxRadius = 24;
                const maxConn = this.maxConnections || 10;
                const scale = d3.scaleLog()
                    .domain([1, maxConn])
                    .range([minRadius, maxRadius]);
                return scale(d.connections || 1);
            }

            getNodeColor(d) {
                switch (this.colorMode) {
                    case 'trust':
                        return this.getNodeColorByTrust(d);
                    case 'strength':
                        return this.getNodeColorByStrength(d);
                    case 'playtime':
                        return this.getNodeColorByPlaytime(d);
                    case 'community':
                        return this.getNodeColorByCommunity(d);
                    default: // connections
                        return this.getNodeColorByConnections(d);
                }
            }

            getNodeColorByConnections(d) {
                const ratio = Math.min(d.connections / (this.maxConnections || 1), 1);
                // 无极渐变：灰紫 → 粉红，使用 LAB 颜色空间
                return d3.interpolateLab('#5e6575', '#ea2864')(ratio);
            }

            getNodeColorByTrust(d) {
                return TRUST_LEVEL_COLORS[d.trustLevel] || '#5e6575';
            }

            getNodeColorByStrength(d) {
                // 基于绝对分数着色（关系强度已是0-100分）
                const score = d.relationshipStrength || 0;
                // 紫红渐变 - 与主色 #ea2864 相邻色系，表达情感羁绊深度
                // 从冷紫灰到暖玫红，情感由浅入深
                if (score < 25) return '#4a4a5c';       // 暗紫灰 - 浅层关系
                else if (score < 50) return '#7b4b8c';  // 葡萄紫 - 一般关系
                else if (score < 75) return '#b84a7c';  // 梅紫红 - 较深关系
                else return '#e84393';                   // 亮粉紫 - 深厚羁绊
            }

            getNodeColorByPlaytime(d) {
                if (!this.maxPlaytime) {
                    this.maxPlaytime = Math.max(...this.nodes.map(n => n.playTime || 0), 1);
                }
                const ratio = Math.min((d.playTime || 0) / this.maxPlaytime, 1);
                // 无极渐变：深青 → 亮青，使用 LAB 颜色空间获得更均匀的感知过渡
                return d3.interpolateLab('#1a3a4a', '#64ffda')(ratio);
            }

            getNodeColorByCommunity(d) {
                if (d.community === undefined || !this.communityColors) return '#5e6575';
                return this.communityColors[d.community % this.communityColors.length];
            }

            updateNodeColors() {
                this.maxStrength = null;
                this.maxPlaytime = null;
                this.nodeElements.selectAll('.node-glow')
                    .transition().duration(300)
                    .attr('fill', d => this.getNodeColor(d));
                this.nodeElements.selectAll('.node-circle')
                    .transition().duration(300)
                    .attr('fill', d => this.getNodeColor(d));
                this.updateLegendColors();
            }

            updateLegendColors() {
                const legend = document.querySelector('.legend');
                const texts = i18n[currentLang];
                let items = [];
                switch (this.colorMode) {
                    case 'trust':
                        items = [
                            { color: '#cccccc', label: 'Visitor' },
                            { color: '#1778ff', label: 'New User' },
                            { color: '#2bcf5c', label: 'User' },
                            { color: '#ff7b42', label: 'Known User' },
                            { color: '#8143e6', label: 'Trusted User' }
                        ];
                        break;
                    case 'strength':
                        items = [
                            { color: '#4a4a5c', label: '0-25' },
                            { color: '#7b4b8c', label: '25-50' },
                            { color: '#b84a7c', label: '50-75' },
                            { color: '#e84393', label: '75-100' }
                        ];
                        break;
                    case 'playtime':
                        // 使用渐变条代替离散色块
                        legend.innerHTML = `
                            <div class="legend-gradient-container">
                                <div class="legend-gradient-bar" style="background: linear-gradient(to right, #1a3a4a, #64ffda);"></div>
                                <div class="legend-gradient-labels">
                                    <span>${texts.legendPlaytimeLow}</span>
                                    <span>${texts.legendPlaytimeTop}</span>
                                </div>
                            </div>
                        `;
                        return; // 提前返回，跳过后面的通用渲染
                    case 'community':
                        // 动态生成社区图例（显示前4个社区）
                        if (this.communityColors && this.communityCount) {
                            const count = Math.min(this.communityCount, 4);
                            for (let i = 0; i < count; i++) {
                                items.push({ color: this.communityColors[i], label: `${texts.community || 'Community'} ${i + 1}` });
                            }
                            if (this.communityCount > 4) {
                                items.push({ color: '#666', label: `+${this.communityCount - 4}` });
                            }
                        }
                        break;
                    default:
                        // 共同好友 - 使用渐变条
                        legend.innerHTML = `
                            <div class="legend-gradient-container">
                                <div class="legend-gradient-bar" style="background: linear-gradient(to right, #5e6575, #ea2864);"></div>
                                <div class="legend-gradient-labels">
                                    <span>${texts.legendLow}</span>
                                    <span>${texts.legendTop}</span>
                                </div>
                            </div>
                        `;
                        return;
                }
                legend.innerHTML = items.map(i => `
                    <div class="legend-item">
                        <div class="legend-circle" style="background: ${i.color}; box-shadow: 0 0 10px ${i.color}40;"></div>
                        <span class="legend-label">${i.label}</span>
                    </div>
                `).join('');
            }

            exportCSV(type) {
                const texts = i18n[currentLang];
                let filename, headers, rows;
                
                const formatHours = (s) => s ? (s / 3600).toFixed(2) : '0';
                const formatPercent = (v) => v ? (v * 100).toFixed(2) : '0';
                
                switch (type) {
                    case 'strength':
                        filename = 'relationship_strength_ranking.csv';
                        headers = ['Rank', 'Name', 'UserID', 'RelationshipStrength', 'TotalHours', 'EffectiveHours', 'RetentionRate', 'MeetCount', 'Connections'];
                        rows = [...this.nodes]
                            .sort((a, b) => (b.relationshipStrength || 0) - (a.relationshipStrength || 0))
                            .map((n, i) => [
                                i + 1,
                                `"${(n.label || '').replace(/"/g, '""')}"`,
                                n.id,
                                (n.relationshipStrength || 0).toFixed(2),
                                formatHours(n.playTime),
                                formatHours(n.effectiveHours),
                                formatPercent(n.retentionRate),
                                n.meetCount || 0,
                                n.connections || 0
                            ]);
                        break;
                    case 'intimacy':
                        filename = 'recent_intimacy_ranking.csv';
                        headers = ['Rank', 'Name', 'UserID', 'RecentIntimacy', 'RecentHours30d', 'LifeShare', 'MeetCount30d'];
                        rows = [...this.nodes]
                            .sort((a, b) => (b.recentIntimacy || 0) - (a.recentIntimacy || 0))
                            .map((n, i) => [
                                i + 1,
                                `"${(n.label || '').replace(/"/g, '""')}"`,
                                n.id,
                                (n.recentIntimacy || 0).toFixed(2),
                                formatHours(n.playTime30d),
                                formatPercent(n.lifeShare),
                                n.meetCount30d || 0
                            ]);
                        break;
                    default: // full
                        filename = 'full_relationship_data.csv';
                        headers = ['Rank', 'Name', 'UserID', 'TrustLevel', 'Connections', 'TotalHours', 'EffectiveHours', 'RetentionRate', 
                                   'MeetCount', 'RecentHours30d', 'MeetCount30d', 'LifeShare', 
                                   'RelationshipStrength', 'RecentIntimacy', 'RecentIntimacy30d', 'RecentIntimacy60d', 'RecentIntimacy90d', 
                                   'DaysKnown', 'IsHiddenFriend'];
                        rows = [...this.nodes]
                            .sort((a, b) => (b.relationshipStrength || 0) - (a.relationshipStrength || 0))
                            .map((n, i) => [
                                i + 1,
                                `"${(n.label || '').replace(/"/g, '""')}"`,
                                n.id,
                                `"${n.trustLevel || ''}"`,
                                n.connections || 0,
                                formatHours(n.playTime),
                                formatHours(n.effectiveHours),
                                formatPercent(n.retentionRate),
                                n.meetCount || 0,
                                formatHours(n.playTime30d),
                                n.meetCount30d || 0,
                                formatPercent(n.lifeShare),
                                (n.relationshipStrength || 0).toFixed(2),
                                (n.recentIntimacy || 0).toFixed(2),
                                (n.recentIntimacy30d || 0).toFixed(2),
                                (n.recentIntimacy60d || 0).toFixed(2),
                                (n.recentIntimacy90d || 0).toFixed(2),
                                n.daysKnown || 0,
                                n.isHiddenFriend ? 'true' : 'false'
                            ]);
                }
                
                const csvContent = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
                const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                try {
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                } finally {
                    URL.revokeObjectURL(url);
                }
            }

            updateDataInfo(params) {
                this.dataParams = params;
                if (!params) {
                    document.getElementById('dataInfoSection').classList.remove('visible');
                    return;
                }
                document.getElementById('dataInfoSection').classList.add('visible');
                const texts = i18n[currentLang];
                document.getElementById('dataInfoRange').textContent = params.dateRange || '--';
                document.getElementById('dataInfoDays').textContent = params.totalDays ? `${params.totalDays}${texts.day || '天'}` : '--';
                document.getElementById('dataInfoActivity').textContent = params.activityFactor ? `${(params.activityFactor * 100).toFixed(0)}%` : '--';
                document.getElementById('dataInfoHalflife').textContent = params.halflife ? `${Math.round(params.halflife)}${texts.day || '天'}` : '--';
            }

            render() {
                // 检测是否为大数据集
                const isLargeDataset = this.edges.length > 10000;

                // 创建容器
                this.container = this.svg.append('g')
                    .attr('class', 'graph-container' + (isLargeDataset ? ' large-dataset' : ''));

                // 添加缩放
                this.zoom = d3.zoom()
                    .scaleExtent([0.1, 4])
                    .on('zoom', (event) => {
                        this.container.attr('transform', event.transform);
                        // 根据缩放级别动态显示/隐藏标签（性能优化）
                        this.updateLabelsVisibility(event.transform.k);
                    });

                this.svg.call(this.zoom);
                this.currentZoom = 1;

                // 渲染边
                this.linkGroup = this.container.append('g').attr('class', 'links');
                this.links = this.linkGroup.selectAll('line')
                    .data(this.edges)
                    .enter()
                    .append('line')
                    .attr('class', 'link')
                    .attr('stroke', '#3d4f6f')
                    .attr('stroke-width', 1);

                // 渲染节点
                this.nodeGroup = this.container.append('g').attr('class', 'nodes');
                this.nodeElements = this.nodeGroup.selectAll('g')
                    .data(this.nodes)
                    .enter()
                    .append('g')
                    .attr('class', 'node')
                    .call(this.drag());

                // 节点光晕（使用渐变透明度代替 blur 滤镜提升性能）
                this.nodeElements.append('circle')
                    .attr('class', 'node-glow')
                    .attr('r', d => this.getNodeRadius(d) + 6)
                    .attr('fill', d => this.getNodeColor(d))
                    .attr('opacity', 0.15);

                // 节点圆圈
                this.nodeElements.append('circle')
                    .attr('class', 'node-circle')
                    .attr('r', d => this.getNodeRadius(d))
                    .attr('fill', d => this.getNodeColor(d))
                    .attr('stroke', '#fff')
                    .attr('stroke-width', 1.5);

                // 节点标签
                this.labels = this.nodeElements.append('text')
                    .attr('class', 'node-label')
                    .attr('dy', d => this.getNodeRadius(d) + 14)
                    .attr('text-anchor', 'middle')
                    .text(d => d.label.length > 12 ? d.label.slice(0, 12) + '...' : d.label)
                    .style('opacity', this.showLabels ? 1 : 0);

                // 事件监听（大数据时添加节流优化）
                this.lastMouseOverTime = 0;
                this.nodeElements
                    .on('mouseover', (event, d) => {
                        // 节流：至少间隔 16ms（约 60fps）
                        const now = Date.now();
                        if (now - this.lastMouseOverTime < 16) return;
                        this.lastMouseOverTime = now;
                        this.handleMouseOver(event, d);
                    })
                    .on('mouseout', (event, d) => this.handleMouseOut(event, d))
                    .on('click', (event, d) => this.handleClick(event, d));

                // 模拟更新
                this.simulation.on('tick', () => this.tick());

                // 重新启动模拟以确保动画效果
                this.simulation.alpha(1).restart();

                // 初始化图例（确保使用渐变条）
                this.updateLegendColors();
            }

            tick() {
                this.links
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                this.nodeElements.attr('transform', d => `translate(${d.x}, ${d.y})`);
            }

            updateLabelsVisibility(zoomLevel) {
                if (!this.labels || !this.showLabels) return;

                this.currentZoom = zoomLevel;
                const nodeCount = this.nodes.length;

                // 节点数量多时，只在缩放足够大时显示标签
                if (nodeCount > 200) {
                    // 节点多时，缩放 > 0.8 才显示标签
                    const shouldShow = zoomLevel > 0.8;
                    this.labels.style('opacity', shouldShow ? 1 : 0);
                } else if (nodeCount > 100) {
                    // 中等数量，缩放 > 0.5 显示
                    const shouldShow = zoomLevel > 0.5;
                    this.labels.style('opacity', shouldShow ? 1 : 0);
                }
                // 节点少时始终显示
            }

            drag() {
                return d3.drag()
                    .on('start', (event, d) => {
                        this.isDragging = true;
                        // 拖动开始时隐藏 tooltip
                        document.getElementById('tooltip').classList.remove('visible');
                        if (!event.active) this.simulation.alphaTarget(0.3).restart();
                        d.fx = d.x;
                        d.fy = d.y;
                    })
                    .on('drag', (event, d) => {
                        d.fx = event.x;
                        d.fy = event.y;
                    })
                    .on('end', (event, d) => {
                        this.isDragging = false;
                        if (!event.active) this.simulation.alphaTarget(0);
                        if (!this.frozen) {
                            d.fx = null;
                            d.fy = null;
                        }
                    });
            }

            handleMouseOver(event, d) {
                // 拖动过程中不处理悬停事件，防止闪烁
                if (this.isDragging) return;

                const tooltip = document.getElementById('tooltip');
                tooltip.querySelector('.tooltip-name').textContent = d.label;

                // 使用预计算的排名
                const rank = this.nodeRanks ? this.nodeRanks.get(d.id) : '?';

                tooltip.querySelector('.tooltip-info').textContent =
                    `共同好友: ${d.connections} | 排名: #${rank}`;

                tooltip.style.left = (event.pageX + 15) + 'px';
                tooltip.style.top = (event.pageY - 10) + 'px';
                tooltip.classList.add('visible');

                // 只有未选中节点时，悬停才改变高亮
                // 已选中节点时，悬停只显示 tooltip，需点击才切换
                if (!this.selectedNode) {
                    this.highlightConnections(d);
                }
            }

            handleMouseOut(event, d) {
                // 拖动过程中不处理悬停事件，防止闪烁
                if (this.isDragging) return;

                const tooltip = document.getElementById('tooltip');
                tooltip.classList.remove('visible');

                // 已选中节点时保持高亮，未选中时清除
                if (!this.selectedNode) {
                    this.clearHighlights();
                }
            }

            handleClick(event, d) {
                event.stopPropagation();
                this.selectedNode = d;
                this.highlightConnections(d);
                this.showNodeDetail(d);
            }

            highlightConnections(node) {
                this.highlightedNodes.clear();
                this.highlightedNodes.add(node.id);

                // 使用邻接表索引快速获取邻居（O(1) vs O(E)）
                const neighbors = this.neighborIndex.get(node.id);
                if (neighbors) {
                    neighbors.forEach(id => this.highlightedNodes.add(id));
                }

                // 使用边索引快速标记高亮边
                const connectedEdgeSet = new Set(this.edgeIndex.get(node.id) || []);

                this.links
                    .classed('highlighted', d => connectedEdgeSet.has(d))
                    .classed('dimmed', d => !connectedEdgeSet.has(d));

                this.nodeElements.style('opacity', d =>
                    this.highlightedNodes.has(d.id) ? 1 : 0.2
                );
            }

            clearHighlights() {
                if (this.links) this.links.classed('highlighted', false).classed('dimmed', false);
                if (this.nodeElements) this.nodeElements.style('opacity', 1);
                this.highlightedNodes.clear();
            }

            showNodeDetail(node) {
                // 使用邻接表索引快速获取邻居（O(1) vs O(E)）
                const neighborIds = this.neighborIndex.get(node.id) || new Set();
                const connections = [];

                neighborIds.forEach(neighborId => {
                    if (this.nodeMap.has(neighborId)) {
                        connections.push(this.nodeMap.get(neighborId));
                    }
                });

                // 按连接数排序
                connections.sort((a, b) => b.connections - a.connections);

                // 使用预计算的排名
                const rank = this.nodeRanks ? this.nodeRanks.get(node.id) : '?';

                const texts = i18n[currentLang];
                const detailSection = this.domCache.detailSection;

                // 辅助函数：格式化时长
                const formatHours = (seconds) => {
                    if (seconds === undefined || seconds === null || isNaN(seconds)) return 'N/A';
                    const hours = seconds / 3600;
                    return hours.toFixed(1);
                };

                // 辅助函数：格式化百分比
                const formatPercent = (value) => {
                    if (value === undefined || value === null || isNaN(value)) return 'N/A';
                    return (value * 100).toFixed(1) + '%';
                };

                // 辅助函数：获取信任等级样式类
                const getTrustLevelClass = (level) => {
                    if (!level) return '';
                    const normalized = level.toLowerCase().replace(/\s+/g, '-');
                    return normalized;
                };

                // 检查是否有互动数据
                const hasInteractionData = node.playTime !== undefined && node.playTime > 0;

                // 使用预计算的排名（关系强度和近期亲密度）
                const strengthRank = this.strengthRanks?.get(node.id) || '?';
                const intimacyRank = this.intimacyRanks?.get(node.id) || '?';

                // 构建信任等级徽章
                const trustBadge = node.trustLevel ? 
                    `<span class="trust-level-badge ${getTrustLevelClass(node.trustLevel)}">${node.trustLevel}</span>` : '';

                // 构建隐藏好友标记（只显示锁图标，hover 显示提示）
                const hiddenBadge = node.isHiddenFriend ? 
                    `<span class="hidden-friend-icon" title="${texts.hiddenFriendHint}"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg></span>` : '';

                // 构建关系指标区块
                let metricsSection = '';
                if (hasInteractionData && (node.relationshipStrength > 0 || node.recentIntimacy > 0)) {
                    metricsSection = `
                        <div class="detail-metrics">
                            <div class="detail-metrics-title">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                </svg>
                                ${texts.relationMetrics}
                            </div>
                            <div class="metric-row">
                                <span class="metric-label"><span class="metric-label-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg></span>${texts.relationshipStrength}</span>
                                <span class="metric-value">${(node.relationshipStrength || 0).toFixed(1)}%<span class="metric-rank">#${strengthRank}</span></span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label"><span class="metric-label-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path></svg></span>${texts.recentIntimacy}</span>
                                <span class="metric-value">${(node.recentIntimacy || 0).toFixed(1)}<span class="metric-rank">#${intimacyRank}</span></span>
                            </div>
                        </div>
                    `;
                }

                // 构建原始数据区块
                let rawDataSection = '';
                if (hasInteractionData) {
                    const playTimeHours = formatHours(node.playTime);
                    const effectiveHours = node.effectiveHours !== undefined ? (node.effectiveHours / 3600).toFixed(1) : 'N/A';
                    const retentionStr = formatPercent(node.retentionRate);
                    const meetCount = node.meetCount !== undefined ? node.meetCount.toLocaleString() : 'N/A';
                    const recentHours = node.playTime30d !== undefined ? formatHours(node.playTime30d) : 'N/A';
                    const lifeShareStr = node.lifeShare !== undefined ? formatPercent(node.lifeShare) : 'N/A';

                    rawDataSection = `
                        <div class="detail-raw-data">
                            <div class="detail-metrics-title">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 20V10"></path>
                                    <path d="M18 20V4"></path>
                                    <path d="M6 20v-4"></path>
                                </svg>
                                ${texts.rawData}
                            </div>
                            <div class="raw-data-grid">
                                <div class="raw-data-item">
                                    <div class="raw-data-value">${playTimeHours}${texts.hour}</div>
                                    <div class="raw-data-label">${texts.totalPlaytime}</div>
                                </div>
                                <div class="raw-data-item">
                                    <div class="raw-data-value">${effectiveHours}${texts.hour}</div>
                                    <div class="raw-data-label">${texts.effectivePlaytime}</div>
                                    <div class="raw-data-sub">${texts.retentionRate} ${retentionStr}</div>
                                </div>
                                <div class="raw-data-item">
                                    <div class="raw-data-value">${meetCount}${texts.times}</div>
                                    <div class="raw-data-label">${texts.meetCount}</div>
                                </div>
                                <div class="raw-data-item">
                                    <div class="raw-data-value">${recentHours}${texts.hour}</div>
                                    <div class="raw-data-label">${texts.recentPlaytime}</div>
                                    <div class="raw-data-sub">${texts.lifeShare} ${lifeShareStr}</div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    rawDataSection = `
                        <div class="no-data-hint">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="12" y1="8" x2="12" y2="12"></line>
                                <line x1="12" y1="16" x2="12.01" y2="16"></line>
                            </svg>
                            ${texts.noInteractionData}
                        </div>
                    `;
                }

                // 构建得分明细折叠面板
                let scoreBreakdownSection = '';
                if (hasInteractionData && (node.depthScore !== undefined || node.relationshipStrength > 0)) {
                    const depthScore = node.depthScore !== undefined ? node.depthScore.toFixed(1) : ((node.relationshipStrength || 0) * 0.4).toFixed(1);
                    const qualityScore = node.qualityScore !== undefined ? node.qualityScore.toFixed(1) : ((node.relationshipStrength || 0) * 0.25).toFixed(1);
                    const stabilityScore = node.stabilityScore !== undefined ? node.stabilityScore.toFixed(1) : ((node.relationshipStrength || 0) * 0.2).toFixed(1);
                    const bondScore = node.bondScore !== undefined ? node.bondScore.toFixed(1) : ((node.relationshipStrength || 0) * 0.15).toFixed(1);
                    const recentTimeScore = node.recentTimeScore !== undefined ? node.recentTimeScore.toFixed(1) : ((node.recentIntimacy || 0) * 0.4).toFixed(1);
                    const recentFreqScore = node.recentFreqScore !== undefined ? node.recentFreqScore.toFixed(1) : ((node.recentIntimacy || 0) * 0.3).toFixed(1);
                    const shareScore = node.shareScore !== undefined ? node.shareScore.toFixed(1) : ((node.recentIntimacy || 0) * 0.3).toFixed(1);

                    scoreBreakdownSection = `
                        <div class="detail-score-breakdown">
                            <button class="score-breakdown-toggle">
                                <span><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: -2px; margin-right: 4px;"><circle cx="12" cy="12" r="10"></circle><path d="M12 2a10 10 0 0 1 10 10"></path><path d="M12 12L12 2"></path><path d="M12 12L20.5 16.5"></path></svg>${texts.scoreBreakdown}</span>
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6 9 12 15 18 9"></polyline>
                                </svg>
                            </button>
                            <div class="score-breakdown-content-wrapper">
                                <div class="score-breakdown-content">
                                    <div class="score-breakdown-content-inner">
                                        <div class="score-item">
                                            <span class="score-item-label">${texts.depthScore}</span>
                                            <div class="score-item-bar"><div class="score-item-bar-fill" style="width: ${parseFloat(depthScore) / 40 * 100}%"></div></div>
                                            <span class="score-item-value">${depthScore}/40</span>
                                        </div>
                                        <div class="score-item">
                                            <span class="score-item-label">${texts.qualityScore}</span>
                                            <div class="score-item-bar"><div class="score-item-bar-fill" style="width: ${parseFloat(qualityScore) / 25 * 100}%"></div></div>
                                            <span class="score-item-value">${qualityScore}/25</span>
                                        </div>
                                        <div class="score-item">
                                            <span class="score-item-label">${texts.stabilityScore}</span>
                                            <div class="score-item-bar"><div class="score-item-bar-fill" style="width: ${parseFloat(stabilityScore) / 20 * 100}%"></div></div>
                                            <span class="score-item-value">${stabilityScore}/20</span>
                                        </div>
                                        <div class="score-item">
                                            <span class="score-item-label">${texts.bondScore}</span>
                                            <div class="score-item-bar"><div class="score-item-bar-fill" style="width: ${parseFloat(bondScore) / 15 * 100}%"></div></div>
                                            <span class="score-item-value">${bondScore}/15</span>
                                        </div>
                                        <div class="score-item">
                                            <span class="score-item-label">${texts.recentTimeScore}</span>
                                            <div class="score-item-bar"><div class="score-item-bar-fill" style="width: ${parseFloat(recentTimeScore) / 40 * 100}%"></div></div>
                                            <span class="score-item-value">${recentTimeScore}/40</span>
                                        </div>
                                        <div class="score-item">
                                            <span class="score-item-label">${texts.recentFreqScore}</span>
                                            <div class="score-item-bar"><div class="score-item-bar-fill" style="width: ${parseFloat(recentFreqScore) / 30 * 100}%"></div></div>
                                            <span class="score-item-value">${recentFreqScore}/30</span>
                                        </div>
                                        <div class="score-item">
                                            <span class="score-item-label">${texts.shareScore}</span>
                                            <div class="score-item-bar"><div class="score-item-bar-fill" style="width: ${parseFloat(shareScore) / 30 * 100}%"></div></div>
                                            <span class="score-item-value">${shareScore}/30</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                detailSection.innerHTML = `
                    <div class="detail-card">
                        <div class="detail-header-row">
                            <div class="detail-name">${node.label}${trustBadge}${hiddenBadge}</div>
                            <button class="close-detail-btn" title="${texts.closeDetail}">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M18 6L6 18"></path>
                                    <path d="M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="detail-rank">
                            <span class="rank-badge">${texts.rank} #${rank}</span>
                            <span class="rank-desc">${texts.total} ${this.nodes.length} ${texts.people}</span>
                        </div>
                        
                        <div class="detail-stats">
                            <div class="detail-stat">
                                <div class="detail-stat-value">${connections.length}</div>
                                <div class="detail-stat-label">${texts.mutualCount}</div>
                            </div>
                            <div class="detail-stat">
                                <div class="detail-stat-value">${node.clusteringCoef !== undefined ? node.clusteringCoef.toFixed(2) : '--'}</div>
                                <div class="detail-stat-label">${texts.clusteringCoef || '聚类系数'}</div>
                            </div>
                            <div class="detail-stat full-width">
                                <div class="detail-stat-value">${node.community !== undefined ? `#${node.community + 1}` : '--'}</div>
                                <div class="detail-stat-label">${texts.community || '社区'}</div>
                            </div>
                        </div>
                        
                        ${metricsSection}
                        ${rawDataSection}
                        ${scoreBreakdownSection}
                        
                        <div class="connections-list">
                            <div class="connections-title">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                    <circle cx="9" cy="7" r="4"></circle>
                                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                </svg>
                                ${texts.mutualList} (${connections.length})
                            </div>
                            <div class="connections-container">
                                ${connections.map(c => `
                                    <div class="connection-item" data-id="${c.id}">
                                        <div class="connection-dot" style="background: ${this.getNodeColor(c)}"></div>
                                        <span class="connection-name">${c.label}</span>
                                        <span class="connection-count">${c.connections}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                        <button class="remove-node-btn" data-id="${node.id}">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 6h18"></path>
                                <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"></path>
                            </svg>
                            ${texts.removeNode}
                        </button>
                    </div>
                `;

                // 添加连接项点击事件
                detailSection.querySelectorAll('.connection-item[data-id]').forEach(item => {
                    item.addEventListener('click', () => {
                        const id = item.getAttribute('data-id');
                        const targetNode = this.nodeMap.get(id);
                        if (targetNode) {
                            this.selectedNode = targetNode;
                            this.highlightConnections(targetNode);
                            this.showNodeDetail(targetNode);
                            this.centerOnNode(targetNode);
                        }
                    });
                });

                // 关闭详情按钮点击事件（返回排行榜）
                const closeBtn = detailSection.querySelector('.close-detail-btn');
                if (closeBtn) {
                    closeBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.selectedNode = null;
                        this.clearHighlights();
                        this.showRankingList(this.currentRankingDimension, this.currentRankingTimeRange);
                    });
                }

                // 移除节点按钮点击事件
                const removeBtn = detailSection.querySelector('.remove-node-btn');
                if (removeBtn) {
                    removeBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const nodeId = removeBtn.getAttribute('data-id');
                        this.removeNode(nodeId);
                    });
                }

                // 得分明细折叠事件
                const breakdownToggle = detailSection.querySelector('.score-breakdown-toggle');
                if (breakdownToggle) {
                    breakdownToggle.addEventListener('click', () => {
                        breakdownToggle.classList.toggle('expanded');
                        const wrapper = detailSection.querySelector('.score-breakdown-content-wrapper');
                        if (wrapper) wrapper.classList.toggle('expanded');
                    });
                }

                // 自动滚动侧边栏到节点详情区域
                const sidebar = document.querySelector('.sidebar');
                if (sidebar && detailSection) {
                    detailSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }

            removeNode(nodeId) {
                // 从节点数组中移除
                const nodeIndex = this.nodes.findIndex(n => n.id === nodeId);
                if (nodeIndex === -1) return;

                const removedNode = this.nodes[nodeIndex];
                this.nodes.splice(nodeIndex, 1);
                this.nodeMap.delete(nodeId);

                // 移除相关的边
                this.edges = this.edges.filter(edge => {
                    const sourceId = typeof edge.source === 'object' ? edge.source.id : edge.source;
                    const targetId = typeof edge.target === 'object' ? edge.target.id : edge.target;
                    return sourceId !== nodeId && targetId !== nodeId;
                });

                // 重新计算所有节点的连接数
                this.nodes.forEach(node => {
                    const connectionSet = new Set();
                    this.edges.forEach(edge => {
                        const sourceId = typeof edge.source === 'object' ? edge.source.id : edge.source;
                        const targetId = typeof edge.target === 'object' ? edge.target.id : edge.target;
                        if (sourceId === node.id && targetId !== node.id) {
                            connectionSet.add(targetId);
                        }
                        if (targetId === node.id && sourceId !== node.id) {
                            connectionSet.add(sourceId);
                        }
                    });
                    node.connections = connectionSet.size;
                });

                // 更新统计信息
                this.updateStats();

                // 重建图索引
                this.buildGraphIndex();

                // 重新渲染图形
                this.simulation.stop();
                this.container.selectAll('*').remove();
                this.setupSimulation();
                this.render();

                // 重置选中状态，显示排名列表
                this.selectedNode = null;
                this.highlightedNodes.clear();
                this.showRankingList();
            }

            centerOnNode(node) {
                const scale = 1.5;
                const x = this.width / 2 - node.x * scale;
                const y = this.height / 2 - node.y * scale;

                this.svg.transition()
                    .duration(750)
                    .call(this.zoom.transform, d3.zoomIdentity.translate(x, y).scale(scale));
            }

            setupControls() {
                // GEXF 文件选择
                const fileInput = document.getElementById('fileInput');
                const btnLoadFile = document.getElementById('btnLoadFile');
                const welcomeUploadBtn = document.getElementById('welcomeUploadBtn');

                const triggerFileInput = () => fileInput.click();

                btnLoadFile.addEventListener('click', triggerFileInput);
                welcomeUploadBtn.addEventListener('click', triggerFileInput);

                fileInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        try {
                            const content = await this.loadFromFile(file);
                            await this.reloadGraph(content, file.name);
                        } catch (error) {
                            console.error('读取文件失败:', error);
                            alert('读取文件失败');
                        }
                    }
                    fileInput.value = '';
                });

                // VRCX 数据库选择
                const dbFileInput = document.getElementById('dbFileInput');
                const btnLoadDB = document.getElementById('btnLoadDB');
                const welcomeUploadDBBtn = document.getElementById('welcomeUploadDBBtn');

                const triggerDBInput = () => dbFileInput.click();

                btnLoadDB.addEventListener('click', triggerDBInput);
                welcomeUploadDBBtn.addEventListener('click', triggerDBInput);

                dbFileInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        try {
                            await this.loadFromVRCXDatabase(file);
                        } catch (error) {
                            console.error('解析数据库失败:', error);
                            alert('解析数据库失败: ' + error.message);
                        }
                    }
                    dbFileInput.value = '';
                });

                // 导出 GEXF 按钮
                const btnExportGexf = this.domCache.exportGexfBtn;
                btnExportGexf.addEventListener('click', () => {
                    if (this.currentGexfContent) {
                        this.exportGexf();
                    }
                });

                // 搜索（添加防抖优化）
                const searchInput = document.getElementById('searchInput');
                let searchDebounceTimer = null;
                searchInput.addEventListener('input', (e) => {
                    clearTimeout(searchDebounceTimer);
                    searchDebounceTimer = setTimeout(() => {
                        this.handleSearch(e.target.value);
                    }, 150);
                });

                // 力度滑块
                const forceSlider = document.getElementById('forceSlider');
                forceSlider.addEventListener('input', (e) => {
                    const value = parseInt(e.target.value);
                    document.getElementById('forceValue').textContent = value;
                    if (this.simulation) {
                        this.simulation.force('charge').strength(value);
                        this.simulation.alpha(0.3).restart();
                    }
                });

                // 距离滑块
                const distanceSlider = document.getElementById('distanceSlider');
                distanceSlider.addEventListener('input', (e) => {
                    const value = parseInt(e.target.value);
                    document.getElementById('distanceValue').textContent = value;
                    if (this.simulation) {
                        this.simulation.force('link').distance(value);
                        this.simulation.alpha(0.3).restart();
                    }
                });

                // 显示标签
                const btnShowLabels = document.getElementById('btnShowLabels');
                btnShowLabels.addEventListener('click', () => {
                    this.showLabels = !this.showLabels;
                    btnShowLabels.classList.toggle('active', this.showLabels);
                    if (this.labels) {
                        if (this.showLabels) {
                            // 启用时根据缩放级别决定是否显示
                            this.updateLabelsVisibility(this.currentZoom || 1);
                        } else {
                            this.labels.transition().duration(200).style('opacity', 0);
                        }
                    }
                });

                // 重置视图
                const btnReset = document.getElementById('btnReset');
                btnReset.addEventListener('click', () => {
                    if (!this.simulation) return;
                    this.svg.transition()
                        .duration(750)
                        .call(this.zoom.transform, d3.zoomIdentity);
                    this.selectedNode = null;
                    this.clearHighlights();
                    this.simulation.alpha(0.3).restart();
                });

                // 冻结布局
                const btnFreeze = document.getElementById('btnFreeze');
                btnFreeze.addEventListener('click', () => {
                    if (!this.simulation) return;
                    this.frozen = !this.frozen;
                    btnFreeze.classList.toggle('active', this.frozen);

                    if (this.frozen) {
                        this.simulation.stop();
                        this.nodes.forEach(n => {
                            n.fx = n.x;
                            n.fy = n.y;
                        });
                    } else {
                        this.nodes.forEach(n => {
                            n.fx = null;
                            n.fy = null;
                        });
                        this.simulation.alpha(0.3).restart();
                    }
                });

                // 缩放按钮
                document.getElementById('zoomIn').addEventListener('click', () => {
                    if (this.zoom) this.svg.transition().call(this.zoom.scaleBy, 1.5);
                });

                document.getElementById('zoomOut').addEventListener('click', () => {
                    if (this.zoom) this.svg.transition().call(this.zoom.scaleBy, 0.67);
                });

                document.getElementById('zoomFit').addEventListener('click', () => {
                    if (this.container) this.fitToView();
                });

                // 点击空白处取消选择，显示排名列表
                this.svg.on('click', () => {
                    if (!this.simulation) return;
                    this.selectedNode = null;
                    this.clearHighlights();
                    this.showRankingList();
                });

                // 着色模式切换
                document.querySelectorAll('.color-mode-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const mode = btn.dataset.mode;
                        if (mode && mode !== this.colorMode) {
                            this.colorMode = mode;
                            document.querySelectorAll('.color-mode-btn').forEach(b => b.classList.remove('active'));
                            btn.classList.add('active');
                            this.updateNodeColors();
                            // 显示/隐藏社区粒度滑条
                            const sliderContainer = document.getElementById('resolutionSliderContainer');
                            if (mode === 'community') {
                                sliderContainer.classList.add('visible');
                            } else {
                                sliderContainer.classList.remove('visible');
                            }
                        }
                    });
                });

                // 社区粒度滑条
                const resolutionSlider = document.getElementById('resolutionSlider');
                const resolutionValue = document.getElementById('resolutionValue');
                const texts = i18n[currentLang];
                resolutionSlider.addEventListener('input', () => {
                    const val = parseInt(resolutionSlider.value);
                    if (val === 0) {
                        resolutionValue.textContent = texts.resolutionAuto || '自动';
                        this.userResolution = null;
                    } else {
                        // 滑条值 1-40 映射到 resolution 0.5-4.0
                        const res = 0.5 + (val / 40) * 3.5;
                        resolutionValue.textContent = res.toFixed(1);
                        this.userResolution = res;
                    }
                });
                resolutionSlider.addEventListener('change', () => {
                    // 松开滑条时重新计算社区
                    if (this.nodes && this.nodes.length > 0) {
                        this.detectCommunities();
                        if (this.colorMode === 'community') {
                            this.updateNodeColors();
                        }
                        // 更新统计卡片
                        document.getElementById('communityCount').textContent = this.communityCount || '--';
                        // 如果有选中节点，更新详情
                        if (this.selectedNode) {
                            this.showNodeDetail(this.selectedNode);
                        }
                    }
                });

                // 着色模式工具栏折叠
                document.getElementById('colorModeHeader').addEventListener('click', () => {
                    this.domCache.colorModeToolbar.classList.toggle('collapsed');
                });

                // 数据信息折叠
                document.getElementById('dataInfoToggle').addEventListener('click', () => {
                    document.querySelector('.data-info-card').classList.toggle('collapsed');
                });
            }

            handleSearch(query) {
                if (!this.nodeElements || !this.links) return;

                const normalizedQuery = query.toLowerCase().trim();

                if (!normalizedQuery) {
                    this.nodeElements.style('opacity', 1);
                    this.links.style('opacity', 0.4);
                    return;
                }

                const matchingNodes = new Set();
                this.nodes.forEach(node => {
                    if (node.label.toLowerCase().includes(normalizedQuery)) {
                        matchingNodes.add(node.id);
                    }
                });

                this.nodeElements.style('opacity', d =>
                    matchingNodes.has(d.id) ? 1 : 0.1
                );

                this.links.style('opacity', d => {
                    const sourceId = typeof d.source === 'object' ? d.source.id : d.source;
                    const targetId = typeof d.target === 'object' ? d.target.id : d.target;
                    return matchingNodes.has(sourceId) || matchingNodes.has(targetId) ? 0.6 : 0.05;
                });

                // 如果只有一个匹配，自动选中并居中
                if (matchingNodes.size === 1) {
                    const nodeId = [...matchingNodes][0];
                    const node = this.nodeMap.get(nodeId);
                    if (node) {
                        this.selectedNode = node;
                        this.showNodeDetail(node);
                        this.centerOnNode(node);
                    }
                }
            }

            fitToView() {
                const bounds = this.container.node().getBBox();
                const padding = 50;

                const scale = Math.min(
                    (this.width - padding * 2) / bounds.width,
                    (this.height - padding * 2) / bounds.height,
                    2
                );

                const x = this.width / 2 - (bounds.x + bounds.width / 2) * scale;
                const y = this.height / 2 - (bounds.y + bounds.height / 2) * scale;

                this.svg.transition()
                    .duration(750)
                    .call(this.zoom.transform, d3.zoomIdentity.translate(x, y).scale(scale));
            }

            hideLoading() {
                const loading = this.domCache.loading;
                loading.style.opacity = '0';
                setTimeout(() => {
                    loading.style.display = 'none';
                }, 300);
            }

            exportGexf() {
                if (!this.currentGexfContent) return;

                // 创建导出文件名
                let exportFileName = this.currentFileName || 'mutual_graph';
                if (exportFileName.endsWith('.sqlite3') || exportFileName.endsWith('.db')) {
                    exportFileName = exportFileName.replace(/\.(sqlite3|db)$/i, '.gexf');
                } else if (!exportFileName.endsWith('.gexf')) {
                    exportFileName += '.gexf';
                }

                // 创建 Blob 并下载
                const blob = new Blob([this.currentGexfContent], { type: 'application/xml' });
                const url = URL.createObjectURL(blob);
                try {
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = exportFileName;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                } finally {
                    URL.revokeObjectURL(url);
                }
            }
        }

        // 启动应用
        document.addEventListener('DOMContentLoaded', () => {
            // 初始化语言选择器
            const langBtn = document.getElementById('langBtn');
            const langDropdown = document.getElementById('langDropdown');

            // 从 localStorage 读取语言偏好
            const savedLang = localStorage.getItem('preferredLang') || 'zh';
            updateLanguage(savedLang);

            // 语言切换点击事件
            langDropdown.querySelectorAll('.lang-option').forEach(option => {
                option.addEventListener('click', () => {
                    const lang = option.getAttribute('data-lang');
                    updateLanguage(lang);
                });
            });

            // 移动端侧边栏控制
            const menuToggle = document.getElementById('menuToggle');
            const sidebar = document.querySelector('.sidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            let isMobile = window.innerWidth <= 900;

            function updateMenuTogglePosition() {
                if (!menuToggle) return;
                if (window.innerWidth > 900) {
                    menuToggle.style.left = '';
                    return;
                }
                const logoSection = document.querySelector('.logo-section');
                if (!logoSection) return;
                const paddingLeft = parseFloat(getComputedStyle(logoSection).paddingLeft) || 0;
                const btnWidth = parseFloat(getComputedStyle(menuToggle).width) || 0;
                const offset = Math.max(6, (paddingLeft - btnWidth) / 2);
                menuToggle.style.left = `${offset}px`;
            }

            function showSidebar() {
                sidebar.classList.add('visible');
                sidebarOverlay.classList.add('visible');
                menuToggle.classList.add('active');
            }

            function hideSidebar() {
                sidebar.classList.remove('visible');
                sidebarOverlay.classList.remove('visible');
                menuToggle.classList.remove('active');
            }

            // 菜单按钮点击
            if (menuToggle) {
                menuToggle.addEventListener('click', () => {
                    if (sidebar.classList.contains('visible')) {
                        hideSidebar();
                    } else {
                        showSidebar();
                    }
                });
                updateMenuTogglePosition();
            }

            // 遮罩点击关闭
            if (sidebarOverlay) {
                sidebarOverlay.addEventListener('click', hideSidebar);
            }

            // 响应窗口大小变化
            window.addEventListener('resize', () => {
                const wasMobile = isMobile;
                isMobile = window.innerWidth <= 900;

                // 从移动端切换到桌面端时，移除移动端样式
                if (wasMobile && !isMobile) {
                    sidebar.classList.remove('visible');
                    sidebarOverlay.classList.remove('visible');
                }
                updateMenuTogglePosition();
            });

            window.networkViz = new NetworkVisualization();
        });
    </script>
    <!-- Cloudflare Web Analytics - Removed for security -->
    <!-- End Cloudflare Web Analytics -->
</body>

</html>